<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bands Management - LMC Admin</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 共通CSS -->
    <link rel="stylesheet" href="/css/style.css">
</head>
<body class="min-h-screen flex overflow-hidden bg-[#f8fafc] hidden">
    <!-- サイドバーはJSによって自動的に挿入されます -->

    <!-- メインコンテンツ -->
    <main class="flex-1 ml-[260px] h-screen overflow-y-auto p-8 relative">
        <header class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-xl font-extrabold text-gray-800 uppercase tracking-widest">Bands Management</h2>
                <p class="text-[10px] text-gray-400 mt-1 font-bold uppercase tracking-wider">バンド編成・楽曲・メンバー管理</p>
            </div>
        </header>

        <!-- ツールバー: 検索 & 操作 -->
        <div class="bg-white rounded-[28px] shadow-sm border border-gray-100 p-6 mb-6">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex flex-1 items-center gap-3 bg-gray-50 px-5 py-3 rounded-2xl max-w-md focus-within:ring-2 focus-within:ring-blue-100 transition-all">
                    <i class="fa-solid fa-magnifying-glass text-gray-400"></i>
                    <input type="text" id="band-search-input" placeholder="バンド名・メンバー名・IDで検索..." class="bg-transparent border-none outline-none text-sm w-full font-bold placeholder:font-medium placeholder:text-gray-300">
                </div>

                <div class="flex items-center gap-3 bg-gray-50 px-4 py-2 rounded-xl border border-gray-100 shadow-sm">
                    <span class="text-[10px] font-extrabold text-gray-400 uppercase tracking-widest whitespace-nowrap">アーカイブを表示</span>
                    <label class="switch">
                        <input type="checkbox" id="archive-toggle">
                        <span class="slider"></span>
                    </label>
                </div>

                <button onclick="window.openAddBandModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-2xl font-bold text-xs flex items-center gap-2 transition-all shadow-lg shadow-blue-100">
                    <i class="fa-solid fa-plus"></i> バンドを追加
                </button>
            </div>
        </div>

        <!-- 一覧テーブル -->
        <div class="bg-white rounded-[28px] shadow-sm border border-gray-100 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="text-gray-400 uppercase text-[9px] font-extrabold tracking-widest border-b border-gray-50 bg-gray-50/50">
                        <tr>
                            <th class="px-8 py-5">バンド名 / システムID</th>
                            <th class="px-8 py-5">メンバー構成</th>
                            <th class="px-8 py-5">Cueシート</th>
                            <th class="px-8 py-5 text-right">操作</th>
                        </tr>
                    </thead>
                    <tbody id="bands-list-body" class="text-sm">
                        <tr>
                            <td colspan="4" class="px-8 py-10 text-center text-gray-400 font-bold">
                                <div class="flex flex-col items-center justify-center gap-2">
                                    <i class="fa-solid fa-spinner fa-spin text-2xl text-blue-500"></i>
                                    <span id="loading-status-text">Connecting to Database...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- ================= MODALS ================= -->

    <!-- 1. 新規バンド作成モーダル -->
    <div id="add-band-modal" class="hidden fixed inset-0 z-50 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4">
        <div onclick="event.stopPropagation()" class="bg-white w-full max-w-md rounded-[32px] shadow-2xl overflow-hidden animate-in zoom-in duration-200 p-8 flex flex-col max-h-[90vh]">
            <button onclick="window.closeAddBandModal()" class="absolute top-4 right-4 w-10 h-10 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center text-gray-500"><i class="fa-solid fa-xmark"></i></button>
            <h3 class="text-xl font-black text-gray-800 mb-6">バンドの新規作成</h3>
            <div class="space-y-6 overflow-y-auto custom-scroll pr-1">
                <div>
                    <label class="text-[10px] font-extrabold text-gray-400 uppercase tracking-widest block mb-2">バンド名</label>
                    <input type="text" id="new-band-name" placeholder="バンド名を入力" class="w-full bg-gray-50 border border-gray-100 rounded-xl px-4 py-3 font-bold text-gray-800 outline-none">
                </div>
                <div>
                    <label class="text-[10px] font-extrabold text-gray-400 uppercase tracking-widest block mb-2">メンバー選択</label>
                    <div id="new-band-members-list" class="h-48 overflow-y-auto border border-gray-100 rounded-xl p-2 bg-gray-50 custom-scroll"></div>
                </div>
                <button onclick="window.handleNewBandSubmit()" class="w-full bg-blue-600 text-white py-4 rounded-[22px] font-bold text-[11px] uppercase tracking-[0.2em] shadow-xl">作成する</button>
            </div>
        </div>
    </div>

    <!-- 2. バンド詳細モーダル -->
    <div id="band-detail-modal" class="hidden fixed inset-0 z-50 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4">
        <div onclick="event.stopPropagation()" class="bg-white w-full max-w-xl rounded-[40px] shadow-2xl overflow-hidden relative animate-in zoom-in duration-200 max-h-[90vh] flex flex-col">
            <button onclick="window.closeBandDetail()" class="absolute top-4 right-4 w-10 h-10 bg-white/80 hover:bg-white rounded-full flex items-center justify-center text-gray-500 z-20"><i class="fa-solid fa-xmark"></i></button>
            <div id="band-modal-content" class="overflow-y-auto flex-1 p-0 custom-scroll"></div>
        </div>
    </div>

    <!-- 3. 出演イベント追加モーダル (新規追加) -->
    <div id="add-event-select-modal" class="hidden fixed inset-0 z-[70] bg-black/40 backdrop-blur-sm flex items-center justify-center p-4">
        <div onclick="event.stopPropagation()" class="bg-white w-full max-w-sm rounded-[32px] shadow-2xl overflow-hidden animate-in zoom-in duration-200 p-8 flex flex-col">
            <button onclick="window.closeAddBandEventModal()" class="absolute top-4 right-4 w-10 h-10 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center text-gray-500"><i class="fa-solid fa-xmark"></i></button>
            <h3 class="text-xl font-black text-gray-800 mb-6 text-center">出演イベントの追加</h3>
            <div class="space-y-6">
                <div>
                    <label class="text-[10px] font-extrabold text-gray-400 uppercase tracking-widest block mb-2">イベントを選択</label>
                    <select id="band-event-select-input" class="w-full bg-gray-50 border border-gray-100 rounded-xl px-4 py-3 font-bold text-gray-800 outline-none">
                        <!-- JSでイベント一覧を挿入 -->
                    </select>
                </div>
                <button onclick="window.handleAddEventToBand()" class="w-full bg-sky-600 text-white py-4 rounded-[22px] font-bold text-[11px] uppercase tracking-[0.2em] shadow-xl">登録する</button>
            </div>
        </div>
    </div>

    <!-- その他モーダル (メンバー編集/曲追加/削除確認) は省略せず維持 -->
    <div id="edit-members-modal" class="hidden fixed inset-0 z-[60] bg-black/40 backdrop-blur-sm flex items-center justify-center p-4">
        <div onclick="event.stopPropagation()" class="bg-white w-full max-w-md rounded-[32px] shadow-2xl p-8 flex flex-col max-h-[90vh]">
            <button onclick="window.closeEditMembersModal()" class="absolute top-4 right-4 w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-gray-500"><i class="fa-solid fa-xmark"></i></button>
            <h3 class="text-xl font-black text-gray-800 mb-6">メンバー編集</h3>
            <input type="hidden" id="edit-members-band-id">
            <div id="edit-members-list" class="h-64 overflow-y-auto border rounded-xl p-2 bg-gray-50 custom-scroll mb-6"></div>
            <button onclick="window.saveBandMembers()" class="w-full bg-blue-600 text-white py-4 rounded-[22px] font-bold text-[11px] uppercase tracking-[0.2em]">保存する</button>
        </div>
    </div>

    <div id="add-song-modal" class="hidden fixed inset-0 z-[60] bg-black/40 backdrop-blur-sm flex items-center justify-center p-4">
        <div onclick="event.stopPropagation()" class="bg-white w-full max-w-md rounded-[32px] p-8 flex flex-col">
            <button onclick="window.closeAddSongModal()" class="absolute top-4 right-4 w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-gray-500"><i class="fa-solid fa-xmark"></i></button>
            <h3 id="song-modal-title" class="text-xl font-black mb-6">曲を追加</h3>
            <input type="hidden" id="song-band-id">
            <input type="hidden" id="song-edit-id">
            <div class="space-y-4">
                <input type="text" id="new-song-title" class="w-full bg-gray-50 border rounded-xl px-4 py-3 font-bold" placeholder="曲名">
                <input type="text" id="new-song-duration" class="w-full bg-gray-50 border rounded-xl px-4 py-3 font-bold" placeholder="長さ (4:30)">
                <select id="new-song-event" class="w-full bg-gray-50 border rounded-xl px-4 py-3 font-bold"></select>
                <button onclick="window.handleSongSubmit()" class="w-full bg-blue-600 text-white py-4 rounded-[22px] font-bold text-[11px] uppercase tracking-[0.2em]">追加</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="hidden fixed inset-0 z-[70] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 text-left">
        <div onclick="event.stopPropagation()" class="bg-white w-full max-w-sm rounded-[32px] p-8 shadow-2xl text-center animate-in zoom-in duration-200">
            <div class="w-16 h-16 bg-red-100 text-red-600 rounded-2xl flex items-center justify-center mx-auto mb-6"><i class="fa-solid fa-triangle-exclamation text-2xl"></i></div>
            <h3 class="text-lg font-black text-gray-800 mb-2">確認</h3>
            <p id="confirm-modal-text" class="text-sm text-gray-500 mb-8 font-medium leading-relaxed">この操作は取り消せません。</p>
            <div class="flex gap-4">
                <button onclick="window.closeConfirmModal()" class="flex-1 py-4 text-sm font-bold text-gray-400 hover:text-gray-600 transition-colors">キャンセル</button>
                <button id="confirm-action-btn" class="flex-1 py-4 bg-red-600 text-white rounded-2xl text-sm font-bold shadow-lg shadow-red-100 hover:bg-red-700 transition-all">実行する</button>
            </div>
        </div>
    </div>

    <!-- Logic -->
    <script type="module">
        import { initAdminPage, db } from "/js/admin-common.js";
        import { collection, onSnapshot, addDoc, updateDoc, doc, serverTimestamp, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let bandsData = [], usersData = [], eventsData = [];
        let bandSearchQuery = "";
        let showArchivedBands = false;
        let currentConfirmAction = null;
        let activeBandId = null; 

        initAdminPage('bands', (user) => {
            console.log("Admin Bands Module Loaded. User UID:", user.uid);
            updateLoadingStatus("Fetching data...");

            onSnapshot(collection(db, 'users'), (s) => {
                usersData = s.docs.map(d => ({id:d.id, ...d.data()}));
                renderBandsList();
            });

            onSnapshot(collection(db, 'events'), (s) => {
                eventsData = s.docs.map(d => ({id:d.id, ...d.data()}));
                updateEventSelects();
                if (activeBandId) renderBandDetailContent(activeBandId);
            });

            onSnapshot(collection(db, 'bands'), (s) => {
                bandsData = s.docs.map(d => ({id:d.id, ...d.data()}));
                renderBandsList();
                if (activeBandId) renderBandDetailContent(activeBandId);
            });
        });

        function updateLoadingStatus(text, isError = false) {
            const el = document.getElementById('loading-status-text');
            if (el) {
                el.innerText = text;
                if (isError) el.classList.add('text-red-500');
            }
        }

        function updateEventSelects() {
            const selects = ['band-event-select-input', 'new-song-event'];
            selects.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                const options = eventsData.map(e => `<option value="${e.id}">${e.event}</option>`).join('');
                el.innerHTML = (id === 'new-song-event' ? '<option value="">イベントを選択（任意）</option>' : '') + options;
            });
        }

        function renderBandsList() {
            const container = document.getElementById('bands-list-body');
            if (!container) return;
            const q = bandSearchQuery.toLowerCase();
            let filtered = bandsData.filter(b => {
                if (!showArchivedBands && b.isArchived) return false;
                const members = (b.memberIds || []).map(id => usersData.find(u => u.id === id)?.name || "").join(" ").toLowerCase();
                return (b.name||"").toLowerCase().includes(q) || (b.id||"").toLowerCase().includes(q) || members.includes(q);
            });
            filtered.sort((a, b) => (a.isArchived !== b.isArchived) ? (a.isArchived ? 1 : -1) : (a.name || "").localeCompare(b.name || "", "ja"));
            
            if (filtered.length === 0 && bandsData.length > 0) {
                container.innerHTML = `<tr><td colspan="4" class="px-8 py-10 text-center text-gray-300 font-bold uppercase">No Match Found</td></tr>`;
                return;
            }
            if (bandsData.length === 0) return;

            container.innerHTML = filtered.map(band => {
                const membersNames = (band.memberIds || []).map(id => usersData.find(u => u.id === id)?.name || "Unknown").join(', ');
                return `
                <tr onclick="window.showBandDetail('${band.id}')" class="cursor-pointer border-b border-gray-50 transition-all ${band.isArchived ? 'bg-gray-100 opacity-60 grayscale' : 'hover:bg-gray-50'}">
                    <td class="px-8 py-5 flex items-center gap-3">
                        ${band.icon ? `<img src="${band.icon}" class="w-10 h-10 rounded-lg object-cover">` : `<div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600 font-bold">${(band.name || "?")[0]}</div>`}
                        <div><span class="font-bold text-gray-800 block">${band.name || 'No Name'}</span><span class="text-[9px] text-gray-400 font-bold uppercase">ID: ${band.id.substring(0,8)}</span></div>
                    </td>
                    <td class="px-8 py-5 text-xs text-gray-500 font-medium truncate max-w-xs">${membersNames}</td>
                    <td class="px-8 py-5">${band.latestCuesheetUrl ? `<a href="${band.latestCuesheetUrl}" target="_blank" onclick="event.stopPropagation()" class="px-3 py-1.5 bg-emerald-100 text-emerald-700 rounded-lg text-[10px] font-bold">開く</a>` : `<span class="text-gray-300 text-[10px] font-bold">未提出</span>`}</td>
                    <td class="px-8 py-5 text-right"><span class="text-blue-600 font-bold text-xs">詳細</span></td>
                </tr>`;
            }).join('');
        }

        document.getElementById('band-search-input').addEventListener('input', (e) => { bandSearchQuery = e.target.value; renderBandsList(); });
        document.getElementById('archive-toggle').addEventListener('change', (e) => { showArchivedBands = e.target.checked; renderBandsList(); });

        window.showBandDetail = (bandId) => {
            activeBandId = bandId;
            renderBandDetailContent(bandId);
            const modal = document.getElementById('band-detail-modal');
            modal.classList.remove('hidden');
            modal.classList.add('modal-active');
        };

        window.closeBandDetail = () => {
            activeBandId = null;
            const modal = document.getElementById('band-detail-modal');
            modal.classList.remove('modal-active');
            setTimeout(() => modal.classList.add('hidden'), 200);
        };

        function renderBandDetailContent(bandId) {
            const band = bandsData.find(b => b.id === bandId);
            if (!band) return;
            const members = (band.memberIds || []).map(id => usersData.find(u => u.id === id)).filter(u => u);
            const participatingEvents = (band.events || []).map(eid => eventsData.find(e => e.id === eid)).filter(e => e);

            const content = document.getElementById('band-modal-content');
            content.innerHTML = `
                <div class="relative w-full">
                    <div class="h-32 w-full bg-gradient-to-r from-slate-800 to-slate-900 relative">
                        <div class="absolute inset-0 opacity-20 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
                    </div>
                    <div class="px-6 pb-8 -mt-12 relative">
                        <div class="flex flex-col items-center text-center mb-6">
                            <div class="w-24 h-24 rounded-full border-4 border-white shadow-xl bg-white flex items-center justify-center overflow-hidden mb-3">
                                ${band.icon ? `<img src="${band.icon}" class="w-full h-full object-cover">` : `<div class="text-3xl font-bold text-slate-700">${(band.name||"?")[0]}</div>`}
                            </div>
                            <h3 class="text-2xl font-black text-gray-800 mb-2">${band.name}</h3>
                            <div class="flex gap-2">
                                ${band.isArchived ? '<span class="px-3 py-1 bg-gray-100 text-gray-500 rounded-full text-[10px] font-bold">Archived</span>' : '<span class="px-3 py-1 bg-green-100 text-green-600 rounded-full text-[10px] font-bold uppercase">Active</span>'}
                                <span class="px-3 py-1 bg-blue-50 text-blue-600 rounded-full text-[10px] font-bold uppercase">${members.length} Members</span>
                            </div>
                        </div>

                        <!-- 出演イベントセクション (追加機能) -->
                        <div class="mb-8">
                            <div class="flex items-center justify-between mb-4 px-1">
                                <h4 class="text-xs font-extrabold text-gray-400 uppercase tracking-widest"><i class="fa-solid fa-calendar-star mr-2"></i>Participating Events</h4>
                                <button onclick="window.openAddBandEventModal()" class="text-[10px] font-bold text-sky-600 hover:underline">イベント登録</button>
                            </div>
                            <div class="bg-white rounded-[24px] border border-gray-100 shadow-sm overflow-hidden divide-y divide-gray-50">
                                ${participatingEvents.length > 0 ? participatingEvents.map(evt => `
                                    <div class="p-4 flex items-center justify-between group hover:bg-sky-50/30 transition-colors">
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 bg-sky-100 text-sky-600 rounded-lg flex items-center justify-center text-xs"><i class="fa-solid fa-star"></i></div>
                                            <div>
                                                <p class="font-bold text-gray-800 text-sm">${evt.event}</p>
                                                <p class="text-[9px] text-gray-400 font-bold">${evt.startDate || evt.date || ''}</p>
                                            </div>
                                        </div>
                                        <button onclick="window.removeEventFromBand('${band.id}', '${evt.id}')" class="w-8 h-8 flex items-center justify-center text-gray-300 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100"><i class="fa-solid fa-trash-can"></i></button>
                                    </div>
                                `).join('') : '<div class="p-6 text-center text-xs text-gray-400 font-bold">出演イベントはありません</div>'}
                            </div>
                        </div>

                        <div class="mb-8">
                            <div class="flex items-center justify-between mb-4 px-1"><h4 class="text-xs font-extrabold text-gray-400 uppercase tracking-widest"><i class="fa-solid fa-users mr-2"></i>Members</h4></div>
                            <div class="bg-white rounded-[24px] border border-gray-100 shadow-sm overflow-hidden divide-y divide-gray-50">
                                ${members.map(m => `
                                    <div class="p-4 flex items-center gap-4">
                                        ${m.icon ? `<img src="${m.icon}" class="w-10 h-10 rounded-full object-cover border border-indigo-100">` : `<div class="w-10 h-10 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-500 font-bold border border-indigo-100">${m.name[0]}</div>`}
                                        <div class="flex-1 min-w-0"><span class="font-bold text-gray-800 text-sm truncate block">${m.name}</span><span class="text-[10px] text-gray-400 font-bold">${m.studentId || ''}</span></div>
                                        <button onclick="window.removeMemberFromBand('${band.id}', '${m.id}')" class="w-8 h-8 flex items-center justify-center text-gray-300 hover:text-red-500 transition-colors"><i class="fa-solid fa-xmark"></i></button>
                                    </div>
                                `).join('')}
                                <button onclick="window.openEditBandMembersModal('${band.id}')" class="w-full py-3 text-center text-[10px] font-bold text-gray-400 hover:bg-gray-50 transition-colors"><i class="fa-solid fa-plus mr-1"></i> メンバー編集</button>
                            </div>
                        </div>

                        <div class="mb-8">
                            <div class="flex items-center justify-between mb-4 px-1"><h4 class="text-xs font-extrabold text-gray-400 uppercase tracking-widest"><i class="fa-solid fa-music mr-2"></i>Songs</h4></div>
                            <div class="bg-white rounded-[24px] border shadow-sm overflow-hidden divide-y divide-gray-50">
                                ${band.songs && band.songs.length > 0 ? band.songs.map((song, idx) => `
                                    <div class="p-4 flex items-center gap-4 group">
                                        <div class="w-6 h-6 rounded bg-gray-100 flex items-center justify-center text-gray-400 font-bold text-[10px]">${idx + 1}</div>
                                        <div class="flex-1 min-w-0"><p class="font-bold text-gray-800 text-sm truncate">${song.title}</p></div>
                                        <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button onclick="window.openAddSongModal('${band.id}', '${song.id}')" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-blue-500"><i class="fa-solid fa-pen text-xs"></i></button>
                                            <button onclick="window.deleteSong('${band.id}', '${song.id}')" class="w-8 h-8 flex items-center justify-center text-gray-300 hover:text-red-500"><i class="fa-solid fa-trash text-xs"></i></button>
                                        </div>
                                    </div>`).join('') : '<div class="p-6 text-center text-xs text-gray-400 font-bold">曲未登録</div>'}
                                <button onclick="window.openAddSongModal('${band.id}')" class="w-full py-3 text-center text-[10px] font-bold text-gray-400 hover:bg-gray-50 transition-colors"><i class="fa-solid fa-plus mr-1"></i> 曲追加</button>
                            </div>
                        </div>

                        <button onclick="window.toggleBandArchive('${band.id}', ${band.isArchived})" class="w-full py-3.5 bg-white border border-gray-200 text-gray-500 rounded-2xl text-xs font-bold hover:bg-gray-50 shadow-sm">
                            <i class="fa-solid fa-box-archive mr-2"></i>${band.isArchived ? 'アーカイブ解除' : 'アーカイブする'}
                        </button>
                    </div>
                </div>
            `;
        }

        // --- イベント追加・削除ロジック ---
        window.openAddBandEventModal = () => {
            const modal = document.getElementById('add-event-select-modal');
            modal.classList.remove('hidden');
            modal.classList.add('modal-active');
        };

        window.closeAddBandEventModal = () => {
            const modal = document.getElementById('add-event-select-modal');
            modal.classList.remove('modal-active');
            setTimeout(() => modal.classList.add('hidden'), 200);
        };

        window.handleAddEventToBand = async () => {
            if (!activeBandId) return;
            const eventId = document.getElementById('band-event-select-input').value;
            if (!eventId) return;

            try {
                const bandRef = doc(db, 'bands', activeBandId);
                await updateDoc(bandRef, {
                    events: arrayUnion(eventId)
                });
                window.closeAddBandEventModal();
            } catch (e) {
                console.error(e);
                alert("登録に失敗しました");
            }
        };

        window.removeEventFromBand = async (bandId, eventId) => {
            if (!confirm("出演イベントを削除しますか？")) return;
            try {
                const bandRef = doc(db, 'bands', bandId);
                await updateDoc(bandRef, {
                    events: arrayRemove(eventId)
                });
            } catch (e) {
                console.error(e);
            }
        };

        // --- その他ハンドラ (省略せず維持) ---
        window.openAddBandModal = () => {
            const container = document.getElementById('new-band-members-list');
            container.innerHTML = usersData.map(u => `<label class="flex items-center gap-2 p-2 hover:bg-white rounded cursor-pointer text-xs font-bold"><input type="checkbox" value="${u.id}"> ${u.name}</label>`).join('');
            document.getElementById('add-band-modal').classList.remove('hidden');
            document.getElementById('add-band-modal').classList.add('modal-active');
        };
        window.closeAddBandModal = () => {
            document.getElementById('add-band-modal').classList.remove('modal-active');
            setTimeout(() => document.getElementById('add-band-modal').classList.add('hidden'), 200);
        };
        window.handleNewBandSubmit = async () => {
            const name = document.getElementById('new-band-name').value;
            const checks = document.querySelectorAll('#new-band-members-list input:checked');
            const memberIds = Array.from(checks).map(c => c.value);
            if(!name) return alert('バンド名を入力');
            try { await addDoc(collection(db, 'bands'), { name, memberIds, events: [], songs: [], isArchived: false, createdAt: serverTimestamp() }); window.closeAddBandModal(); } catch (e) { console.error(e); }
        };
        window.openEditBandMembersModal = (bandId) => {
            const band = bandsData.find(b => b.id === bandId);
            document.getElementById('edit-members-band-id').value = bandId;
            const container = document.getElementById('edit-members-list');
            container.innerHTML = usersData.map(u => `<label class="flex items-center gap-2 p-2 hover:bg-white rounded cursor-pointer text-xs font-bold"><input type="checkbox" value="${u.id}" ${band.memberIds.includes(u.id)?'checked':''}> ${u.name}</label>`).join('');
            document.getElementById('edit-members-modal').classList.remove('hidden');
            document.getElementById('edit-members-modal').classList.add('modal-active');
        };
        window.closeEditMembersModal = () => { document.getElementById('edit-members-modal').classList.remove('modal-active'); setTimeout(() => document.getElementById('edit-members-modal').classList.add('hidden'), 200); };
        window.saveBandMembers = async () => {
            const bid = document.getElementById('edit-members-band-id').value;
            const ids = Array.from(document.querySelectorAll('#edit-members-list input:checked')).map(c => c.value);
            try { await updateDoc(doc(db, 'bands', bid), { memberIds: ids }); window.closeEditMembersModal(); } catch(e) { console.error(e); }
        };
        window.removeMemberFromBand = async (bid, uid) => { if(confirm('削除しますか？')) { const b = bandsData.find(x=>x.id===bid); await updateDoc(doc(db,'bands',bid), {memberIds: b.memberIds.filter(i=>i!==uid)}); } };
        window.openAddSongModal = (bid, sid = null) => {
            document.getElementById('song-band-id').value = bid;
            document.getElementById('song-edit-id').value = sid || "";
            if(sid) { const b = bandsData.find(x=>x.id===bid); const s = b.songs.find(x=>x.id===sid); document.getElementById('new-song-title').value = s.title; document.getElementById('new-song-duration').value = s.duration || ""; document.getElementById('new-song-event').value = s.eventId || ""; }
            else { document.getElementById('new-song-title').value = ""; document.getElementById('new-song-duration').value = ""; document.getElementById('new-song-event').value = ""; }
            document.getElementById('add-song-modal').classList.remove('hidden');
            document.getElementById('add-song-modal').classList.add('modal-active');
        };
        window.closeAddSongModal = () => { document.getElementById('add-song-modal').classList.remove('modal-active'); setTimeout(() => document.getElementById('add-song-modal').classList.add('hidden'), 200); };
        window.handleSongSubmit = async () => {
            const bid = document.getElementById('song-band-id').value;
            const sid = document.getElementById('song-edit-id').value;
            const title = document.getElementById('new-song-title').value;
            if(!title) return;
            const b = bandsData.find(x=>x.id===bid);
            let songs = b.songs || [];
            if(sid) songs = songs.map(s => s.id === sid ? {...s, title, duration: document.getElementById('new-song-duration').value, eventId: document.getElementById('new-song-event').value} : s);
            else songs.push({id: Math.random().toString(36).substr(2,9), title, duration: document.getElementById('new-song-duration').value, eventId: document.getElementById('new-song-event').value});
            await updateDoc(doc(db, 'bands', bid), {songs}); window.closeAddSongModal();
        };
        window.deleteSong = async (bid, sid) => { if(confirm('削除しますか？')) { const b = bandsData.find(x=>x.id===bid); await updateDoc(doc(db, 'bands', bid), {songs: b.songs.filter(s=>s.id!==sid)}); } };
        window.toggleBandArchive = async (bid, st) => { await updateDoc(doc(db, 'bands', bid), {isArchived: !st}); };
        window.openConfirmModal = (t, a) => { document.getElementById('confirm-modal-text').innerText = t; currentConfirmAction = a; document.getElementById('confirm-modal').classList.remove('hidden'); document.getElementById('confirm-modal').classList.add('flex'); };
        window.closeConfirmModal = () => { document.getElementById('confirm-modal').classList.add('hidden'); document.getElementById('confirm-modal').classList.remove('flex'); };
        document.getElementById('confirm-action-btn').onclick = async () => { if(currentConfirmAction) await currentConfirmAction(); window.closeConfirmModal(); };
        window.filterMemberList = (cid, v) => { const q = v.toLowerCase(); document.querySelectorAll(`#${cid} label`).forEach(l => { if(l.innerText.toLowerCase().includes(q)) l.classList.remove('hidden'); else l.classList.add('hidden'); }); };
    </script>
</body>
</html>
