<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LMC Mobile - åˆã‚ã›äºˆç´„</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; font-family: 'Roboto', 'Noto Sans JP', sans-serif; background-color: rgb(241, 244, 249); color: #1f1f1f; min-height: 100vh; padding-bottom: 88px; overscroll-behavior-y: none; user-select: none; -webkit-user-select: none; }
        .container { max-width: 480px; margin: 0 auto; height: 100%; display: flex; flex-direction: column; } .hidden { display: none !important; }
        .app-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: rgb(241, 244, 249); flex-shrink: 0; z-index: 500; }
        .header-title { font-size: 22px; font-weight: bold; color: #1f1f1f; display: flex; align-items: center; gap: 8px; }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼å³å´ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚°ãƒ«ãƒ¼ãƒ— */
        .header-actions { display: flex; align-items: center; gap: 12px; }
        .header-icon-btn { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; cursor: pointer; color: #1f1f1f; transition: background 0.2s; }
        .header-icon-btn:active { background-color: #e0e0e0; }
        .header-icon-btn .material-icons { font-size: 26px; }

        .header-avatar { width: 36px; height: 36px; border-radius: 50%; display: flex; justify-content: center; align-items: center; background: #dadce0; cursor: pointer; position: relative; }
        .header-avatar img { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid white; z-index: 2; }
        .ring-sound { background: #1a73e8; box-shadow: 0 0 5px rgba(26,115,232,0.5); } .ring-light { background: #fa7b17; box-shadow: 0 0 5px rgba(250,123,23,0.5); }
        .ring-stage { background: #34A853; box-shadow: 0 0 5px rgba(52,168,83,0.5); } .ring-video { background: #EA4335; box-shadow: 0 0 5px rgba(234,67,53,0.5); }
        .ring-rainbow { background: linear-gradient(135deg, #EA4335, #FBBC05, #34A853, #4285F4); animation: spin 4s linear infinite; }
        .ring-birthday { background: linear-gradient(45deg, #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000); background-size: 400%; animation: birthday-glow 3s linear infinite; box-shadow: 0 0 8px rgba(255, 215, 0, 0.8); }
        @keyframes spin { 100% { transform: rotate(360deg); } } @keyframes birthday-glow { 0% { background-position: 0 0; } 50% { background-position: 400% 0; } 100% { background-position: 0 0; } }
        .scroll-content { flex-grow: 1; overflow-y: auto; padding: 16px; padding-bottom: 100px; -webkit-overflow-scrolling: touch; }
        .calendar-controls { display: flex; justify-content: space-between; align-items: center; background: white; padding: 12px 16px; border-radius: 12px; margin: 0 16px 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); flex-shrink: 0; z-index: 400; }
        .view-switcher { display: flex; position: relative; background: #f1f3f4; border-radius: 20px; padding: 2px; width: 90px; height: 32px; }
        .switcher-item { flex: 1; z-index: 2; font-size: 13px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: color 0.3s; color: #5f6368; }
        .switcher-item.active { color: #0b57d0; }
        .switcher-slide { position: absolute; width: 44px; height: 28px; background: white; border-radius: 18px; top: 2px; left: 2px; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 1px 3px rgba(0,0,0,0.1); z-index: 1; }
        .view-switcher.day-mode .switcher-slide { transform: translateX(42px); }
        .month-grid { background: white; border-radius: 12px; padding: 10px; display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; margin-bottom: 20px; }
        .weekday-label { font-size: 11px; color: #5f6368; padding-bottom: 8px; font-weight: bold; }
        .weekday-label.sun { color: #d93025; } .weekday-label.sat { color: #1a73e8; }
        .day-cell { height: 54px; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 4px; cursor: pointer; border: 1px solid transparent; transition: all 0.2s; background-color: #fafafa; }
        .day-num { font-size: 13px; width: 24px; height: 24px; line-height: 24px; border-radius: 50%; z-index: 2; margin-bottom: 2px; } 
        .day-cell.today { background-color: #e8f0fe; } .day-cell.today .day-num { background: #0b57d0; color: white; font-weight: bold; }
        .day-cell.other-month { opacity: 0.15; cursor: default; pointer-events: none; } 
        .day-cell.unavailable { background-color: #fff1f0; border-color: #ffccc7; } 
        .day-cell.unavailable .day-num { color: #cf1322; }
        .day-cell.partial-event { background-color: #fff7e6; border-color: #ffd591; }
        .day-cell.partial-event .day-num { color: #d46b08; }
        .status-label { font-size: 8px; color: #cf1322; font-weight: bold; height: 12px; transform: scale(0.9); }
        .event-dots { display: flex; gap: 2px; margin-top: 2px; justify-content: center; min-height: 5px; align-items: center; } 
        .dot { width: 4px; height: 4px; border-radius: 50%; background: #34A853; } .dot.event { background: #137333; transform: scale(1.2); }
        .dot-plus { font-size: 10px; color: #137333; font-weight: bold; margin-left: 2px; line-height: 1; }
        .timeline-container { background: white; border-radius: 12px; padding: 10px 0; position: relative; height: auto; min-height: 600px; }
        .time-slot { height: 60px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: flex-start; position: relative; }
        .time-label { width: 50px; font-size: 12px; color: #5f6368; text-align: center; transform: translateY(-8px); }
        .time-content { flex-grow: 1; height: 100%; position: relative; border-left: 1px solid #f0f0f0; touch-action: pan-y; } .time-content.selecting { background-color: rgba(11, 87, 208, 0.2); }
        .event-block { position: absolute; left: 0; width: 100%; background: #e8f0fe; border-left: 4px solid #0b57d0; border-radius: 4px; padding: 4px 8px; font-size: 12px; color: #0b57d0; overflow: hidden; cursor: pointer; z-index: 10; box-shadow: 0 1px 2px rgba(0,0,0,0.1); box-sizing: border-box; }
        .event-title { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; } .event-block.special-event { background: #e6f4ea; border-left: 4px solid #137333; color: #0d652d; }
        .event-block.pending { opacity: 0.9; background: #fff8e1; border-left: 4px solid #ffb300; color: #b06000; border: 1px dashed #ffb300; border-left-style: solid; }
        .event-block.lottery-confirmed { background: #f3e5f5; border-left: 4px solid #ab47bc; color: #4a148c; }
        .event-block.cluster { background: #5f6368; color: white; border-left: 4px solid #3c4043; display: flex; justify-content: center; align-items: center; z-index: 25; } .event-block.cluster .event-title { white-space: normal; text-align: center; font-size: 13px; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #ffffff; border-top: 1px solid #e0e3e7; display: flex; justify-content: space-around; padding: 12px 0 28px; z-index: 2000; box-shadow: 0 -1px 3px rgba(0,0,0,0.05); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #444746; font-size: 12px; width: 72px; cursor: pointer; gap: 4px; font-weight: 500; }
        .nav-icon { font-size: 24px; padding: 4px 20px; border-radius: 16px; transition: background-color 0.2s ease-in-out, color 0.2s; } .nav-item.active .nav-icon { background-color: #c2e7ff; color: #001d35; } .nav-item#nav-admin.active .nav-icon { background-color: #ffd8e4; color: #31111d; } .nav-item.active span { color: #1f1f1f; font-weight: bold; }
        .btn-primary { background: #0b57d0; color: white; border: none; padding: 12px 20px; border-radius: 24px; width: 100%; font-weight: bold; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .btn-secondary { background: #f1f3f4; color: #1f1f1f; border: none; padding: 12px 20px; border-radius: 24px; width: 100%; margin-top: 8px; cursor: pointer; font-weight: bold; }
        .btn-danger { background: #fee2e2; color: #d93025; border: none; padding: 12px 20px; border-radius: 24px; width: 100%; margin-top: 8px; cursor: pointer; font-weight: bold; }
        .btn-google { background: #fff; color: #3c4043; border: 1px solid #dadce0; padding: 10px; border-radius: 20px; font-weight: bold; width: 100%; margin-top: 16px; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9000; display: none; justify-content: center; align-items: flex-end; } .modal-overlay.open { display: flex; }
        .modal-content { background: white; width: 100%; max-width: 480px; border-radius: 24px 24px 0 0; padding: 24px; box-sizing: border-box; max-height: 85vh; overflow-y: auto; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .form-group { margin-bottom: 16px; } .form-label { display: block; font-size: 12px; color: #5f6368; margin-bottom: 4px; font-weight: bold; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #dadce0; border-radius: 8px; box-sizing: border-box; font-size: 16px; background: white; }
        #selectionToast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 30px; z-index: 9500; font-size: 14px; pointer-events: none; opacity: 0; transition: opacity 0.2s; } #selectionToast.show { opacity: 1; }
        .radio-group { display: flex; gap: 15px; } .radio-label { display: flex; align-items: center; font-size: 16px; cursor: pointer; } .radio-label input { width: 20px; height: 20px; margin-right: 6px; }
        .checkbox-label { display: flex; align-items: center; font-size: 15px; font-weight: bold; color: #0b57d0; cursor: pointer; } .checkbox-label input { width: 20px; height: 20px; margin-right: 8px; }
        .card { background: white; border-radius: 16px; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); margin-bottom: 12px; transition: background-color 0.2s; }
        .user-status-card { text-align: center; padding: 20px; } .user-status-icon { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; border: 4px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); } .user-status-name { font-size: 18px; font-weight: bold; margin-bottom: 20px; } .fee-status-row { display: flex; gap: 10px; justify-content: center; margin-top: 10px; } .fee-status-badge { flex: 1; padding: 10px; border-radius: 8px; font-size: 14px; font-weight: bold; } .fee-paid { background-color: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; } .fee-unpaid { background-color: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
        .dialog-content { background: white; width: 85%; max-width: 320px; border-radius: 20px; padding: 24px; text-align: center; animation: zoomIn 0.2s ease; margin: auto; }
        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .dialog-title { font-weight: bold; font-size: 18px; margin-bottom: 12px; color: #1f1f1f; }
        .dialog-message { font-size: 14px; color: #444746; margin-bottom: 24px; line-height: 1.5; white-space: pre-wrap; }
        .dialog-buttons { display: flex; gap: 12px; }
        .dialog-btn { flex: 1; padding: 12px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 14px; }
        .btn-dialog-cancel { background: #f1f3f4; color: #1f1f1f; }
        .btn-dialog-ok { background: #0b57d0; color: white; }
        .sync-indicator { margin-right: 12px; animation: spin 1.5s linear infinite; display: flex; }
        
        /* ç¾åœ¨æ™‚åˆ»è¡¨ç¤ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .current-time-line { position: absolute; left: 50px; width: calc(100% - 50px); border-top: 2px solid #ea4335; z-index: 50; pointer-events: none; display: none; }
        .current-time-badge { position: absolute; left: -50px; width: 50px; top: -10px; text-align: center; display: flex; justify-content: center; align-items: center; }
        .current-time-text { background-color: #ea4335; color: white; font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 10px; height: 16px; line-height: 16px; }
        .current-time-dot { width: 8px; height: 8px; background-color: #ea4335; border-radius: 50%; position: absolute; left: -4px; top: -5px; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }

        /* é€±é–“æ—¥ä»˜ã‚¹ãƒˆãƒªãƒƒãƒ—ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        /* é«˜ã•ã‚’è¦‹åˆ‡ã‚Œè§£æ¶ˆã®ãŸã‚èª¿æ•´ã€è§’ä¸¸ã‚’è¿½åŠ  */
        .week-strip { position: relative; overflow: hidden; height: 74px; background: white; border-bottom: 1px solid #f0f0f0; margin-bottom: 10px; user-select: none; border-radius: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ãƒ©ãƒƒãƒ‘ãƒ¼ */
        .week-strip-wrapper { display: flex; width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
        /* å„ãƒšãƒ¼ã‚¸ï¼ˆ1é€±é–“åˆ†ï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .week-strip-page { width: 100%; flex-shrink: 0; display: flex; justify-content: space-around; padding: 12px 0; box-sizing: border-box; }
        
        .week-day-item { display: flex; flex-direction: column; align-items: center; width: 40px; cursor: pointer; }
        .week-day-label { font-size: 10px; color: #5f6368; margin-bottom: 6px; font-weight: bold; }
        .week-day-num { width: 34px; height: 34px; line-height: 34px; text-align: center; border-radius: 50%; font-size: 15px; font-weight: bold; color: #1f1f1f; transition: background-color 0.2s; }
        .week-day-item.selected .week-day-num { background-color: #0b57d0; color: white; }
        .week-day-item.today .week-day-num { border: 1px solid #0b57d0; box-sizing: border-box; } 
        .week-day-item.today.selected .week-day-num { background-color: #0b57d0; border: none; }
        .week-day-item.sun .week-day-label { color: #d93025; }
        .week-day-item.sat .week-day-label { color: #1a73e8; }
    </style>
</head>
<body>
    <div id="selectionToast">ãªãã£ã¦æ™‚é–“ã‚’é¸æŠ...</div>
    <div id="modal-custom-dialog" class="modal-overlay" style="align-items: center; z-index: 10000;">
        <div class="dialog-content">
            <div id="dialogTitle" class="dialog-title">ç¢ºèª</div>
            <div id="dialogMessage" class="dialog-message">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
            <div class="dialog-buttons">
                <button id="dialogBtnCancel" class="dialog-btn btn-dialog-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="dialogBtnOk" class="dialog-btn btn-dialog-ok">OK</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="app-header">
            <div class="header-title">åˆã‚ã›äºˆç´„</div>
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼å³å´ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ç¾¤ -->
            <div class="header-actions">
                <div id="btnSearch" class="header-icon-btn" onclick="openSearchModal()">
                    <span class="material-icons">search</span>
                </div>
                <div id="btnAdd" class="header-icon-btn" onclick="handleNewBooking()">
                    <span class="material-icons">add</span>
                </div>
                <div id="syncIndicator" class="sync-indicator hidden">
                    <span class="material-icons" style="font-size: 20px; color: #5f6368;">sync</span>
                </div>
                <div class="header-avatar" id="headerIconCal"></div>
            </div>
        </div>
        <div class="calendar-controls">
            <div class="view-switcher" id="viewSwitcher">
                <div class="switcher-slide"></div>
                <div class="switcher-item active" data-mode="month" onclick="switchCalendarView('month')">æœˆ</div>
                <div class="switcher-item" data-mode="day" onclick="switchCalendarView('day')">æ—¥</div>
            </div>
            <div style="display:flex; align-items:center;"><span class="material-icons" style="cursor:pointer; padding:5px;" onclick="changeDate(-1)">chevron_left</span><div class="date-display" id="calHeaderDate" style="margin:0 10px; font-size:16px;"></div><span class="material-icons" style="cursor:pointer; padding:5px;" onclick="changeDate(1)">chevron_right</span></div>
        </div>
        <div class="scroll-content">
            <div id="calMonthView"><div class="month-grid" id="monthGrid"></div></div>
            <div id="calDayView" class="hidden">
                <!-- é€±é–“ã‚¹ãƒˆãƒªãƒƒãƒ— -->
                <div id="weekStrip" class="week-strip"></div>
                
                <div id="bookingModeBanner" style="margin:0 10px 10px; padding:10px; border-radius:8px; font-size:13px; text-align:center; line-height:1.4;"></div>
                <div style="font-size:12px; color:#999; text-align:center; margin-bottom:5px;">ç©ºãæ™‚é–“ã‚’é•·æŠ¼ã—ï¼†ãªãã£ã¦äºˆç´„ / äºˆç´„ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ç·¨é›†</div>
                <div class="timeline-container" id="timeline"></div>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item" onclick="window.location.href='/index.html'"><span class="material-icons nav-icon">groups</span><span>ãƒã‚¤ãƒãƒ³ãƒ‰</span></div>
        <div class="nav-item active" onclick="window.location.href='/booking.html'"><span class="material-icons nav-icon">calendar_month</span><span>åˆã‚ã›äºˆç´„</span></div>
        <div class="nav-item" onclick="window.location.href='/cue.html'"><span class="material-icons nav-icon">description</span><span>Cueã‚·ãƒ¼ãƒˆ</span></div>
        <div class="nav-item hidden" id="nav-admin" onclick="window.location.href='/manage.html'"><span class="material-icons nav-icon">admin_panel_settings</span><span>ç®¡ç†</span></div>
        <div class="nav-item" onclick="goToMyPage()"><span class="material-icons nav-icon">account_circle</span><span>ãƒã‚¤ãƒšãƒ¼ã‚¸</span></div>
    </div>

    <div id="modal-booking" class="modal-overlay" onclick="if(event.target===this) closeModal('modal-booking')"><div class="modal-content"><h3 style="margin-top:0;" id="bookingModalTitle">äºˆç´„ã®ç¢ºèª</h3><input type="hidden" id="editingBookingId"><div class="form-group"><label class="form-label">æ—¥ä»˜</label><div style="font-weight:bold; font-size:16px; margin-bottom:10px;" id="bookingDateDisplay"></div></div><div class="form-group"><label class="checkbox-label"><input type="checkbox" id="checkAllDay" onchange="toggleAllDay()"> çµ‚æ—¥ (9:00 - 20:00)</label></div><div class="form-group" id="timeSelectArea" style="display:flex; gap:10px; align-items:center;"><div style="flex:1;"><label class="form-label">é–‹å§‹</label><select id="selectStartTime" class="form-input"></select></div><span>ã€œ</span><div style="flex:1;"><label class="form-label">çµ‚äº†</label><select id="selectEndTime" class="form-input"></select></div></div><div id="bookingTypeSelector" class="form-group hidden" style="background:#f8f9fa; padding:10px; border-radius:8px;"><label class="form-label">ç™»éŒ²ç¨®åˆ¥</label><div class="radio-group"><label class="radio-label"><input type="radio" name="bookingType" value="normal" checked onchange="toggleBookingInputs()"> ãƒãƒ³ãƒ‰ç·´ç¿’</label><label class="radio-label" style="color:#137333; font-weight:bold;"><input type="radio" name="bookingType" value="event" onchange="toggleBookingInputs()"> ã‚¤ãƒ™ãƒ³ãƒˆãƒ»ä¸å¯æ—¥</label></div></div><div id="groupBandSelect" class="form-group"><label class="form-label">äºˆç´„ã™ã‚‹ãƒãƒ³ãƒ‰</label><select id="selectBookingBand" class="form-input"></select></div><div id="groupEventTitle" class="form-group hidden"><label class="form-label">ã‚¤ãƒ™ãƒ³ãƒˆå / ç†ç”±</label><input type="text" id="inputEventTitle" class="form-input" placeholder="ä¾‹: å®šæœŸæ¼”å¥ä¼š"></div><button id="btnSaveBooking" class="btn-primary" onclick="saveBooking()">äºˆç´„ã‚’ç¢ºå®šã™ã‚‹</button><button id="btnAddToGCal" class="btn-google hidden" onclick="addToGoogleCalendar()"><span class="material-icons" style="color:#34A853;">calendar_today</span> Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¿½åŠ </button><button id="btnDeleteBooking" class="btn-danger hidden" onclick="deleteBooking()">ã“ã®äºˆç´„ã‚’å‰Šé™¤</button><button class="btn-secondary" onclick="closeModal('modal-booking')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></div></div>
    
    <!-- æ¤œç´¢ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="modal-search" class="modal-overlay" onclick="if(event.target===this) closeModal('modal-search')">
        <div class="modal-content">
            <h3 style="margin-top:0;">äºˆç´„æ¤œç´¢</h3>
            <div class="form-group">
                <input type="text" id="searchInput" class="form-input" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›..." onkeyup="filterSearchResults()">
            </div>
            <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ç”¨ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’è¿½åŠ  -->
            <div class="form-group" style="margin-bottom:10px;">
                <label class="checkbox-label" style="font-size:14px; color:#5f6368;">
                    <input type="checkbox" id="filterMyBands" onchange="filterSearchResults()">
                    <span style="color:#1f1f1f;">è‡ªåˆ†ã®å‚åŠ ãƒãƒ³ãƒ‰ã®ã¿è¡¨ç¤º</span>
                </label>
            </div>
            <p style="font-size:12px; color:#5f6368; margin-bottom:10px;">ç›´è¿‘ã®èª­ã¿è¾¼ã¿æ¸ˆã¿äºˆç´„ã‹ã‚‰æ¤œç´¢ã—ã¾ã™ã€‚</p>
            <div id="searchResultContainer" style="max-height: 400px; overflow-y: auto;"></div>
            <button class="btn-secondary" onclick="closeModal('modal-search')">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <div id="modal-event-list" class="modal-overlay" onclick="if(event.target===this) closeModal('modal-event-list')"><div class="modal-content"><h3 style="margin-top:0;">äºˆç´„ä¸€è¦§</h3><p style="font-size:12px; color:#5f6368; margin-bottom:20px;">è©³ç´°ã‚’ç¢ºèªãƒ»ç·¨é›†ã—ãŸã„äºˆç´„ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚</p><div id="eventListContainer" style="max-height: 400px; overflow-y: auto;"></div><button class="btn-secondary" onclick="closeModal('modal-event-list')">é–‰ã˜ã‚‹</button></div></div>
    <div id="modal-user-status" class="modal-overlay" onclick="if(event.target===this) closeModal('modal-user-status')"><div class="modal-content"><h3 style="margin-top:0; text-align:center; font-size:16px; color:#5f6368;">ãƒã‚¤ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3><div class="user-status-card"><img id="modalUserIcon" src="" class="user-status-icon"><div id="modalUserName" class="user-status-name"></div><div style="background:#f9f9f9; padding:15px; border-radius:12px;"><div id="statusFeeYear" style="font-size:12px; color:#666; margin-bottom:10px; font-weight:bold;">2025å¹´åº¦ éƒ¨è²»</div><div class="fee-status-row"><div id="statusFeeTerm1" class="fee-status-badge">å‰æœŸ: -</div><div id="statusFeeTerm2" class="fee-status-badge">å¾ŒæœŸ: -</div></div></div><div style="margin-top:20px;"><div style="font-size:12px; color:#999; margin-bottom:5px;">ä¼šå“¡QRã‚³ãƒ¼ãƒ‰</div><div id="myQRCodeArea" style="width:150px; height:150px; background:#eee; margin:0 auto; display:flex; align-items:center; justify-content:center;"><span class="material-icons" style="font-size:48px; color:#ccc;">qr_code_2</span></div></div></div><button class="btn-secondary" onclick="closeModal('modal-user-status')">é–‰ã˜ã‚‹</button></div></div>

    <script>
        (function(){
            document.addEventListener('DOMContentLoaded', function() {
                const d = new Date();
                const y = d.getFullYear();
                const m = d.getMonth();
                const header = document.getElementById('calHeaderDate');
                if(header && header.innerText === "") header.innerText = y + "å¹´ " + (m+1) + "æœˆ";
                const grid = document.getElementById('monthGrid');
                if(grid && grid.innerHTML.trim() === "") {
                    const wds = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
                    let html = "";
                    wds.forEach((wd, i) => { let cls = 'weekday-label'; if(i===0) cls+=' sun'; if(i===6) cls+=' sat'; html += '<div class="'+cls+'">'+wd+'</div>'; });
                    const firstD = new Date(y, m, 1);
                    const lastD = new Date(y, m+1, 0);
                    for(let i=0; i<firstD.getDay(); i++) html += '<div></div>';
                    for(let i=1; i<=lastD.getDate(); i++){ let cls = 'day-cell'; if(i === d.getDate()) cls += ' today'; html += '<div class="'+cls+'" id="day-'+y+'-'+(m+1)+'-'+i+'"><div class="day-num">'+i+'</div><div class="status-label"></div><div class="event-dots" id="dots-'+y+'-'+(m+1)+'-'+i+'"></div></div>'; }
                    grid.innerHTML = html;
                }
                const strip = document.getElementById('weekStrip');
                if(strip && strip.innerHTML.trim() === "") {
                    // åˆæœŸè¡¨ç¤ºç”¨ã®é€±é–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”Ÿæˆï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãªã—ï¼‰
                    const current = new Date(); 
                    const dayOfWeek = current.getDay();
                    const startOfWeek = new Date(current);
                    startOfWeek.setDate(current.getDate() - dayOfWeek);
                    const wds = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
                    let html = "";
                    for (let i = 0; i < 7; i++) {
                        const targetD = new Date(startOfWeek);
                        targetD.setDate(startOfWeek.getDate() + i);
                        let cls = 'week-day-item';
                        if (i === 0) cls += ' sun'; if (i === 6) cls += ' sat';
                        if (targetD.getDate() === current.getDate()) cls += ' today selected';
                        html += '<div class="'+cls+'"><div class="week-day-label">'+wds[i]+'</div><div class="week-day-num">'+targetD.getDate()+'</div></div>';
                    }
                    strip.innerHTML = '<div class="week-strip-page">' + html + '</div>';
                }
                const timeline = document.getElementById('timeline');
                if(timeline && timeline.innerHTML.trim() === "") {
                    let html = ""; for(let h=9; h<20; h++){ html += '<div class="time-slot"><div class="time-label">'+h+':00</div><div class="time-content" data-hour="'+h+'"></div></div>'; }
                    timeline.innerHTML = html;
                }
            });
        })();
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, setDoc, updateDoc, deleteDoc, query, where, orderBy, onSnapshot, Timestamp, arrayUnion, arrayRemove, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        const firebaseConfig = { apiKey: "AIzaSyAWtITnn5uMOPBgOY0Bd7Rt5IN1ry8XoJI", authDomain: "urakata-app.firebaseapp.com", projectId: "urakata-app", storageBucket: "urakata-app.firebasestorage.app", messagingSenderId: "407777765696", appId: "1:407777765696:web:045c2d94729022b4eab2a5", measurementId: "G-9ZRMD26XNJ" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app);
        const MY_LIFF_ID = "2008162165-vVODNp12"; const MY_PAGE_URL = "https://mypage.sorairosystem.com";
        
        const CACHE_KEY_USER = 'lmc_user_cache';
        const CACHE_KEY_BANDS = 'lmc_bands_cache';
        const CACHE_KEY_BOOKINGS_PREFIX = 'lmc_bookings_';

        let currentUser=null, currentProfile=null, currentUserData=null, displayDate=new Date(), selectedTimeSlot=null, selectionStartHour=null, selectionEndHour=null;
        let myBandsAll=[], calendarMode='month', isSelecting=false, selectionTimer=null, editingBookingData=null;
        let currentSystemSettings={ bookingMode:'first_come', lotteryConfig:{ mode:'auto', daysBefore:2, time:0 } };
        let currentFeeSettings={ year:new Date().getFullYear(), term1_amount:0, term2_amount:0 };
        let loadedBookingsCache = [];
        let touchStartX = 0;
        let touchEndX = 0;

        window.showCustomAlert = async function(message, title = "é€šçŸ¥") { return new Promise((resolve) => { const modal = document.getElementById('modal-custom-dialog'); document.getElementById('dialogTitle').innerText = title; document.getElementById('dialogMessage').innerText = message; const okBtn = document.getElementById('dialogBtnOk'); const cancelBtn = document.getElementById('dialogBtnCancel'); cancelBtn.classList.add('hidden'); okBtn.onclick = () => { modal.classList.remove('open'); resolve(); }; modal.classList.add('open'); }); }
        window.showCustomConfirm = async function(message, title = "ç¢ºèª") { return new Promise((resolve) => { const modal = document.getElementById('modal-custom-dialog'); document.getElementById('dialogTitle').innerText = title; document.getElementById('dialogMessage').innerText = message; const okBtn = document.getElementById('dialogBtnOk'); const cancelBtn = document.getElementById('dialogBtnCancel'); cancelBtn.classList.remove('hidden'); okBtn.onclick = () => { modal.classList.remove('open'); resolve(true); }; cancelBtn.onclick = () => { modal.classList.remove('open'); resolve(false); }; modal.classList.add('open'); }); }
        window.openModal=(id)=>document.getElementById(id).classList.add('open');
        window.closeModal=(id)=>document.getElementById(id).classList.remove('open');
        window.goToMyPage=()=>window.location.href=MY_PAGE_URL;
        
        async function loadSystemConfig(){ try{ const snap=await getDoc(doc(db,"system","settings")); if(snap.exists())currentSystemSettings=snap.data(); }catch(e){} }
        function renderHeaderIcons(d){ let r=""; const aff=d.affiliations||[]; const isU=aff.includes("urakata"); if(d.birthday){ const t=new Date(), b=new Date(d.birthday); if(t.getMonth()===b.getMonth()&&t.getDate()===b.getDate()) r="ring-birthday"; } if(!r&&isU) r=d.job?`ring-${d.job}`:"ring-rainbow"; const h=`<img src="${d.icon||'https://ul.h3z.jp/Vnukmtvq.jpg'}">`; const el=document.getElementById('headerIconCal'); if(el){ el.innerHTML=h; el.className="header-avatar "+r; el.onclick=openUserStatusModal; } if(d.role && d.role.length > 0) { const navAdmin = document.getElementById('nav-admin'); if(navAdmin) navAdmin.classList.remove('hidden'); } }

        (function renderFromCache() {
            try {
                const cachedUserStr = localStorage.getItem(CACHE_KEY_USER);
                if (cachedUserStr) {
                    const u = JSON.parse(cachedUserStr);
                    currentUserData = u; renderHeaderIcons(u);
                }
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        const cachedBandsStr = localStorage.getItem(CACHE_KEY_BANDS);
                        if (cachedBandsStr) myBandsAll = JSON.parse(cachedBandsStr);
                        renderCalendar(true); 
                    }, 0);
                });
            } catch (e) { console.warn("Cache render error:", e); }
        })();

        const showSyncIndicator = () => document.getElementById('syncIndicator').classList.remove('hidden');
        const hideSyncIndicator = () => document.getElementById('syncIndicator').classList.add('hidden');

        async function main(){ 
            try{ 
                showSyncIndicator();
                try{ if(typeof __initial_auth_token!=='undefined'&&__initial_auth_token)await signInWithCustomToken(auth,__initial_auth_token); else await signInAnonymously(auth); }catch(ae){console.warn(ae)} 
                try {
                    await liff.init({liffId:MY_LIFF_ID}); 
                    if(!liff.isLoggedIn()){liff.login();return;} 
                    const profile=await liff.getProfile(); 
                    currentUser=profile.userId; currentProfile=profile; 
                    const userRef=doc(db,"users",currentUser), userSnap=await getDoc(userRef); 
                    if(!userSnap.exists()){ window.location.href=MY_PAGE_URL; return; } 
                    await setDoc(userRef,{lastLogin:serverTimestamp()},{merge:true}); 
                    currentUserData=userSnap.data(); 
                    localStorage.setItem(CACHE_KEY_USER, JSON.stringify(currentUserData));
                    renderHeaderIcons(currentUserData);
                } catch (e) { try { liff.login(); } catch (loginError) { window.location.href = MY_PAGE_URL; } return; }
                await loadSystemConfig(); loadMyBands(); 
                switchCalendarView('month'); 
                setInterval(updateCurrentTimeLine, 60000);
                setupWeekSwipe();
            }catch(e){console.error(e)} 
        }

        function setupWeekSwipe() {
            const weekStrip = document.getElementById('weekStrip');
            if (weekStrip) {
                weekStrip.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, {passive: true});
                weekStrip.addEventListener('touchend', e => { touchEndX = e.changedTouches[0].screenX; handleWeekSwipe(); }, {passive: true});
            }
        }
        function handleWeekSwipe() {
            const threshold = 50; 
            if (touchEndX < touchStartX - threshold) changeDate(7);
            if (touchEndX > touchStartX + threshold) changeDate(-7);
        }

        window.openUserStatusModal=async()=>{ if(!currentUserData)return; if(!currentFeeSettings.year){ try{ const snap=await getDoc(doc(db,"system","fees")); if(snap.exists())currentFeeSettings=snap.data(); }catch(e){console.error(e)} } const year=currentFeeSettings.year||new Date().getFullYear(); const status=currentUserData.feeStatus||{}; document.getElementById('modalUserIcon').src=currentUserData.icon||'https://ul.h3z.jp/Vnukmtvq.jpg'; document.getElementById('modalUserName').innerText=currentUserData.name+" ã•ã‚“"; const isPaid1=!!status[`${year}_1`], isPaid2=!!status[`${year}_2`], t1Text=isPaid1?'æ¸ˆ':'æœªç´', t2Text=isPaid2?'æ¸ˆ':'æœªç´', t1El=document.getElementById('statusFeeTerm1'), t2El=document.getElementById('statusFeeTerm2'); t1El.innerText=`å‰æœŸ: ${t1Text}`; t1El.className=`fee-status-badge ${isPaid1?'fee-paid':'fee-unpaid'}`; t2El.innerText=`å¾ŒæœŸ: ${t2Text}`; t2El.className=`fee-status-badge ${isPaid2?'fee-paid':'fee-unpaid'}`; document.getElementById('statusFeeYear').innerText=`${year}å¹´åº¦ éƒ¨è²»çŠ¶æ³`; if(currentUser){ const qrUrl=`https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${currentUser}`; document.getElementById('myQRCodeArea').innerHTML=`<img src="${qrUrl}" style="width:100%;height:100%;">`; } openModal('modal-user-status'); };
        function loadMyBands(){ const q=query(collection(db,"bands"),where("memberIds","array-contains",currentUser)); onSnapshot(q,(snapshot)=>{ myBandsAll=[]; snapshot.forEach(docSnap=>myBandsAll.push({id:docSnap.id,...docSnap.data()})); localStorage.setItem(CACHE_KEY_BANDS, JSON.stringify(myBandsAll)); }); }
        
        window.switchCalendarView=(m, keepDate = false)=>{ calendarMode=m; if(m==='day'){ if(!keepDate){ const t=new Date(); if(displayDate.getMonth()===t.getMonth()&&displayDate.getFullYear()===t.getFullYear()) { displayDate.setDate(t.getDate()); } else { displayDate.setDate(1); } } } updateViewMenuUI(); renderCalendar(); };
        function updateViewMenuUI(){ const isMonth = (calendarMode === 'month'); document.getElementById('calMonthView').classList.toggle('hidden', !isMonth); document.getElementById('calDayView').classList.toggle('hidden', isMonth); const switcher = document.getElementById('viewSwitcher'); switcher.classList.toggle('day-mode', !isMonth); document.querySelectorAll('.switcher-item').forEach(el => { el.classList.toggle('active', el.dataset.mode === calendarMode); }); }
        
        window.changeDate=(d)=>{ 
            if(calendarMode==='month') displayDate.setMonth(displayDate.getMonth()+d); 
            else displayDate.setDate(displayDate.getDate()+d); 
            const dir = d > 0 ? 1 : -1;
            renderCalendar(false, dir); 
        };
        
        function renderCalendar(useCache = false, animationDirection = 0){ 
            const y=displayDate.getFullYear(), m=displayDate.getMonth()+1; 
            if(calendarMode==='month'){
                document.getElementById('calHeaderDate').innerText=`${y}å¹´ ${m}æœˆ`; 
                renderMonthView(y, m-1, useCache);
            } else {
                const d=displayDate.getDate(), w=['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][displayDate.getDay()]; 
                document.getElementById('calHeaderDate').innerText=`${m}æœˆ`; 
                renderDayView(animationDirection);
            } 
        }

        function renderMonthView(y, m, useCache){ 
            const grid=document.getElementById('monthGrid'); 
            if(!grid) return;
            if(useCache && grid.innerHTML.trim() !== "") { loadMonthBookings(y, m, true); return; }
            grid.innerHTML=""; 
            ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].forEach(wd=>{const div=document.createElement('div'); div.className='weekday-label'; div.innerText=wd; if(wd==='æ—¥')div.classList.add('sun'); if(wd==='åœŸ')div.classList.add('sat'); grid.appendChild(div);}); 
            const firstD=new Date(y,m,1), lastD=new Date(y,m+1,0), today=new Date(); 
            for(let i=0; i<firstD.getDay(); i++)grid.appendChild(document.createElement('div')); 
            for(let d=1; d<=lastD.getDate(); d++){ 
                const div=document.createElement('div'); div.className='day-cell'; div.id=`day-${y}-${m+1}-${d}`; 
                if(y===today.getFullYear()&&m===today.getMonth()&&d===today.getDate())div.classList.add('today'); 
                div.onclick=()=>{displayDate.setDate(d); switchCalendarView('day', true);}; 
                div.innerHTML=`<div class="day-num">${d}</div><div class="status-label"></div><div class="event-dots" id="dots-${y}-${m+1}-${d}"></div>`; 
                grid.appendChild(div); 
            } 
            loadMonthBookings(y,m, useCache); 
        }

        function loadMonthBookings(y,m, useCache){ 
            const cacheKey = CACHE_KEY_BOOKINGS_PREFIX + `${y}_${m}`;
            const cached = localStorage.getItem(cacheKey);
            if(cached) { try { const data = JSON.parse(cached); loadedBookingsCache = data; applyBookingDataToMonth(data); } catch(e) {} }
            if (useCache) return;
            onSnapshot(query(collection(db,"bookings"),where("startTime",">=",new Date(y,m,1)),where("startTime","<=",new Date(y,m+1,0,23,59,59))),(qs)=>{ 
                const bookings = [];
                qs.forEach(docSnap => { const d = docSnap.data(); bookings.push({ ...d, id: docSnap.id, startTime: d.startTime.toDate().toISOString(), endTime: d.endTime.toDate().toISOString(), type: d.type }); });
                loadedBookingsCache = bookings; localStorage.setItem(cacheKey, JSON.stringify(bookings)); applyBookingDataToMonth(bookings); hideSyncIndicator();
            }); 
        }

        function applyBookingDataToMonth(bookings) {
            document.querySelectorAll('.event-dots').forEach(el=>el.innerHTML=""); 
            document.querySelectorAll('.day-cell.unavailable, .day-cell.partial-event').forEach(el=>{ el.classList.remove('unavailable', 'partial-event'); const st = el.querySelector('.status-label'); if(st) st.innerText = ""; }); 
            const stats = {};
            bookings.forEach(bk => {
                const d = new Date(bk.startTime); const key = `day-${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
                if (!stats[key]) stats[key] = { count: 0, eventType: null };
                if (bk.type === 'event') {
                    const e = bk.endTime ? new Date(bk.endTime) : new Date(bk.startTime); const sH = d.getHours(); const eH = e.getHours(); const isAllDay = (sH <= 9 && eH >= 20);
                    if (isAllDay) { stats[key].eventType = 'unavailable'; } else if (stats[key].eventType !== 'unavailable') { stats[key].eventType = 'partial'; }
                } else { stats[key].count++; }
            });
            Object.keys(stats).forEach(key => {
                const data = stats[key]; const cell = document.getElementById(key); if (!cell) return;
                if (data.eventType === 'unavailable') { cell.classList.add('unavailable'); const st = cell.querySelector('.status-label'); if(st) st.innerText = "ğŸš«ä¸å¯"; } else if (data.eventType === 'partial') { cell.classList.add('partial-event'); }
                if (data.count > 0) {
                    const dotsContainer = document.getElementById(key.replace('day-', 'dots-'));
                    if (dotsContainer) { if (data.count <= 3) { for(let i=0; i<data.count; i++) { const dot = document.createElement('div'); dot.className = 'dot'; dotsContainer.appendChild(dot); } } else { const dot = document.createElement('div'); dot.className = 'dot'; dotsContainer.appendChild(dot); const plus = document.createElement('div'); plus.className = 'dot-plus'; plus.innerText = `+${data.count - 1}`; dotsContainer.appendChild(plus); } }
                }
            });
        }

        function renderDayView(animationDirection = 0){ 
            const banner=document.getElementById('bookingModeBanner'), mode=currentSystemSettings.bookingMode||'first_come'; 
            if(mode==='lottery'){banner.style.backgroundColor='#fff3e0'; banner.style.color='#e65100'; banner.style.border='1px solid #ffe0b2'; banner.innerHTML=`<div style="font-weight:bold; font-size:14px;"><span class="material-icons" style="font-size:18px;">casino</span> æŠ½é¸å—ä»˜ä¸­</div><div style="font-size:11px;">å¸Œæœ›ã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚</div>`;} 
            else {banner.style.backgroundColor='#e8f0fe'; banner.style.color='#1967d2'; banner.style.border='1px solid #d2e3fc'; banner.innerHTML=`<div style="font-weight:bold; font-size:14px;"><span class="material-icons" style="font-size:18px;">flash_on</span> å…ˆç€é †ãƒ¢ãƒ¼ãƒ‰</div><div style="font-size:11px;">å³æ™‚ç¢ºå®šã—ã¾ã™ã€‚</div>`;} 
            
            const container=document.getElementById('timeline'); 
            container.innerHTML=""; 
            
            renderWeekStrip(animationDirection);

            for(let h=9;h<20;h++){ 
                const slot=document.createElement('div'); 
                slot.className='time-slot'; 
                slot.innerHTML=`<div class="time-label">${h}:00</div>`; 
                const content=document.createElement('div'); 
                content.className='time-content'; 
                content.dataset.hour=h; 
                content.addEventListener('touchstart',handleTouchStart,{passive:false}); 
                content.addEventListener('touchmove',handleTouchMove,{passive:false}); 
                content.addEventListener('touchend',handleTouchEnd); 
                content.addEventListener('mousedown',handleMouseDown); 
                slot.appendChild(content); 
                container.appendChild(slot); 
            } 
            container.addEventListener('mousemove',handleMouseMove); 
            container.addEventListener('mouseup',handleMouseUp); 

            createCurrentTimeLine(container);
            loadDayBookings(); 
        }

        function generateWeekHTML() {
            const today = new Date();
            const current = new Date(displayDate);
            const dayOfWeek = current.getDay();
            const startOfWeek = new Date(current);
            startOfWeek.setDate(current.getDate() - dayOfWeek);
            const wds = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
            let html = "";
            for (let i = 0; i < 7; i++) {
                const d = new Date(startOfWeek);
                d.setDate(startOfWeek.getDate() + i);
                let cls = 'week-day-item';
                if (i === 0) cls += ' sun';
                if (i === 6) cls += ' sat';
                if (d.getDate() === current.getDate() && d.getMonth() === current.getMonth()) cls += ' selected';
                if (d.getDate() === today.getDate() && d.getMonth() === today.getMonth() && d.getFullYear() === today.getFullYear()) cls += ' today';
                
                const dateStr = `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
                html += `<div class="${cls}" data-date="${dateStr}"><div class="week-day-label">${wds[i]}</div><div class="week-day-num">${d.getDate()}</div></div>`;
            }
            document.getElementById('calHeaderDate').innerText = `${current.getFullYear()}å¹´ ${current.getMonth() + 1}æœˆ`;
            return html;
        }

        function renderWeekStrip(animationDirection) {
            const strip = document.getElementById('weekStrip');
            if (!strip) return;

            if (!strip.hasAttribute('data-click-bound')) {
                strip.setAttribute('data-click-bound', 'true');
                strip.addEventListener('click', (e) => {
                    const item = e.target.closest('.week-day-item');
                    if (item && item.dataset.date) {
                        const parts = item.dataset.date.split('-').map(Number);
                        displayDate.setFullYear(parts[0], parts[1]-1, parts[2]);
                        renderCalendar(); 
                    }
                });
            }

            const newInnerHtml = generateWeekHTML();
            
            if (animationDirection === 0 || strip.innerHTML.trim() === "") {
                strip.innerHTML = `<div class="week-strip-page">${newInnerHtml}</div>`;
                return;
            }

            const oldPage = strip.querySelector('.week-strip-page');
            const oldContent = oldPage ? oldPage.innerHTML : "";

            const wrapper = document.createElement('div');
            wrapper.className = 'week-strip-wrapper';
            wrapper.style.transition = 'transform 0.3s cubic-bezier(0.25, 1, 0.5, 1)';

            const oldDiv = document.createElement('div');
            oldDiv.className = 'week-strip-page';
            oldDiv.innerHTML = oldContent;

            const newDiv = document.createElement('div');
            newDiv.className = 'week-strip-page';
            newDiv.innerHTML = newInnerHtml;

            strip.innerHTML = '';
            strip.appendChild(wrapper);

            if (animationDirection > 0) {
                wrapper.appendChild(oldDiv);
                wrapper.appendChild(newDiv);
                wrapper.style.transform = 'translateX(0)';
                wrapper.offsetHeight; 
                wrapper.style.transform = 'translateX(-100%)';
            } else {
                wrapper.appendChild(newDiv);
                wrapper.appendChild(oldDiv);
                wrapper.style.transform = 'translateX(-100%)';
                wrapper.offsetHeight;
                wrapper.style.transform = 'translateX(0)';
            }

            wrapper.addEventListener('transitionend', () => {
                strip.innerHTML = `<div class="week-strip-page">${newInnerHtml}</div>`;
            }, { once: true });
        }

        function createCurrentTimeLine(container) {
            const now = new Date();
            if (displayDate.getFullYear() === now.getFullYear() && displayDate.getMonth() === now.getMonth() && displayDate.getDate() === now.getDate()) {
                const line = document.createElement('div'); line.id = 'currentTimeLine'; line.className = 'current-time-line';
                line.innerHTML = '<div class="current-time-badge"><span id="currentTimeText" class="current-time-text"></span></div><div class="current-time-dot"></div>';
                container.appendChild(line); updateCurrentTimeLine(); 
            }
        }
        function updateCurrentTimeLine() {
            const line = document.getElementById('currentTimeLine'); if (!line) return;
            const now = new Date();
            const isToday = displayDate.getFullYear() === now.getFullYear() && displayDate.getMonth() === now.getMonth() && displayDate.getDate() === now.getDate();
            if (!isToday) { line.style.display = 'none'; return; }
            const h = now.getHours();
            if (h < 9 || h >= 20) { line.style.display = 'none'; } else {
                line.style.display = 'block';
                const m = now.getMinutes(); const top = ((h - 9) * 60) + m + 10; line.style.top = `${top}px`;
                const textEl = document.getElementById('currentTimeText'); if(textEl) { textEl.innerText = `${h}:${String(m).padStart(2, '0')}`; }
            }
        }
        
        function handleTouchStart(e){ if(e.target.classList.contains('event-block'))return; const h=parseInt(e.target.dataset.hour); if(isNaN(h))return; selectionTimer=setTimeout(()=>{isSelecting=true; selectionStartHour=h; selectionEndHour=h; updateSelectionUI(); document.getElementById('selectionToast').classList.add('show'); if(navigator.vibrate)navigator.vibrate(50);},500); }
        function handleTouchMove(e){ if(!isSelecting){clearTimeout(selectionTimer);return;} e.preventDefault(); const t=document.elementFromPoint(e.touches[0].clientX,e.touches[0].clientY); if(t&&t.classList.contains('time-content')){selectionEndHour=parseInt(t.dataset.hour); updateSelectionUI();} }
        function handleTouchEnd(e){ clearTimeout(selectionTimer); if(isSelecting){isSelecting=false; document.getElementById('selectionToast').classList.remove('show'); openBookingModalRange();} }
        function handleMouseDown(e){ if(!e.target.classList.contains('time-content'))return; isSelecting=true; selectionStartHour=parseInt(e.target.dataset.hour); selectionEndHour=selectionStartHour; updateSelectionUI(); }
        function handleMouseMove(e){ if(isSelecting&&e.target.classList.contains('time-content')){selectionEndHour=parseInt(e.target.dataset.hour); updateSelectionUI();} }
        function handleMouseUp(){ if(isSelecting){isSelecting=false; openBookingModalRange();} }
        function updateSelectionUI(){ document.querySelectorAll('.time-content').forEach(el=>el.classList.remove('selecting')); if(selectionStartHour===null||selectionEndHour===null)return; const s=Math.min(selectionStartHour,selectionEndHour), e=Math.max(selectionStartHour,selectionEndHour); for(let h=s; h<=e; h++)document.querySelector(`.time-content[data-hour="${h}"]`)?.classList.add('selecting'); }
        window.toggleAllDay=()=>{ const isA=document.getElementById('checkAllDay').checked, area=document.getElementById('timeSelectArea'); if(isA){area.style.opacity="0.5"; area.style.pointerEvents="none"; document.getElementById('selectStartTime').value="9:00"; document.getElementById('selectEndTime').value="20:00";} else {area.style.opacity="1"; area.style.pointerEvents="auto";} };
        window.toggleBookingInputs=()=>{ const t=document.querySelector('input[name="bookingType"]:checked')?.value||'normal'; if(t==='event'){document.getElementById('groupBandSelect').classList.add('hidden'); document.getElementById('groupEventTitle').classList.remove('hidden');} else {document.getElementById('groupBandSelect').classList.remove('hidden'); document.getElementById('groupEventTitle').classList.add('hidden');} };
        function openBookingModalRange(){ document.querySelectorAll('.time-content').forEach(el=>el.classList.remove('selecting')); const s=Math.min(selectionStartHour,selectionEndHour), e=Math.max(selectionStartHour,selectionEndHour); document.getElementById('bookingModalTitle').innerText="æ–°è¦äºˆç´„"; document.getElementById('btnSaveBooking').innerText="ç¢ºå®šã™ã‚‹"; document.getElementById('btnDeleteBooking').classList.add('hidden'); document.getElementById('btnAddToGCal').classList.add('hidden'); document.getElementById('editingBookingId').value=""; const isAdmin=currentUserData?.affiliations.includes('urakata')&&currentUserData.role; document.getElementById('bookingTypeSelector').classList.toggle('hidden',!isAdmin); if(isAdmin)document.querySelector('input[name="bookingType"][value="normal"]').checked=true; toggleBookingInputs(); document.getElementById('bookingDateDisplay').innerText=`${displayDate.getMonth()+1}æœˆ ${displayDate.getDate()}æ—¥`; setupTimeSelects(`${s}:00`,`${e+1}:00`); document.getElementById('checkAllDay').checked=false; toggleAllDay(); updateBandSelect(); openModal('modal-booking'); }
        function openEditBookingModal(id,data){ if(data.creatorId!==currentUser){ if(data.type==='event')showCustomAlert(`ã€${data.title}ã€‘\næ—¢ã«äºˆå®šãŒå…¥ã£ã¦ã„ã¾ã™ã€‚`, "äºˆç´„ä¸å¯"); else showCustomAlert("ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆã—ãŸäºˆç´„ã¯ç·¨é›†ã§ãã¾ã›ã‚“ã€‚", "ç·¨é›†ä¸å¯"); return; } document.getElementById('bookingModalTitle').innerText="äºˆç´„ã®ç·¨é›†"; document.getElementById('btnSaveBooking').innerText="å¤‰æ›´ä¿å­˜"; document.getElementById('btnDeleteBooking').classList.remove('hidden'); document.getElementById('btnAddToGCal').classList.remove('hidden'); document.getElementById('editingBookingId').value=id; editingBookingData=data; const isAdmin=currentUserData?.affiliations.includes('urakata')&&currentUserData.role; document.getElementById('bookingTypeSelector').classList.toggle('hidden',!isAdmin); if(isAdmin)document.querySelector(`input[name="bookingType"][value="${data.type||'normal'}"]`).checked=true; toggleBookingInputs(); const s=new Date(data.startTime); const e=new Date(data.endTime); const sStr=`${s.getHours()}:${String(s.getMinutes()).padStart(2,'0')}`, eStr=`${e.getHours()}:${String(e.getMinutes()).padStart(2,'0')}`; document.getElementById('bookingDateDisplay').innerText=`${s.getMonth()+1}æœˆ ${s.getDate()}æ—¥`; document.getElementById('checkAllDay').checked=(sStr==="9:00"&&eStr==="20:00"); setupTimeSelects(sStr,eStr); toggleAllDay(); if(data.type==='event')document.getElementById('inputEventTitle').value=data.title||""; else updateBandSelect(data.bandId); openModal('modal-booking'); }
        function setupTimeSelects(ds,de){ const sSel=document.getElementById('selectStartTime'), eSel=document.getElementById('selectEndTime'), opts=[]; for(let h=9;h<=20;h++){ opts.push(`${h}:00`); if(h<20)opts.push(`${h}:30`); } sSel.innerHTML=""; eSel.innerHTML=""; opts.forEach(t=>{sSel.appendChild(new Option(t,t)); eSel.appendChild(new Option(t,t));}); if(ds)sSel.value=ds; if(de)eSel.value=de; }
        function updateBandSelect(bid=""){ const s=document.getElementById('selectBookingBand'); s.innerHTML=""; const active=myBandsAll.filter(b=>!b.isArchived); if(active.length===0)s.appendChild(new Option("ãªã—","")); else active.forEach(b=>{const op=new Option(b.name,b.id); if(b.id===bid)op.selected=true; s.appendChild(op);}); }
        window.openEventListModal=(evs)=>{ const c=document.getElementById('eventListContainer'); c.innerHTML=""; evs.sort((a,b)=>new Date(a.startTime)-new Date(b.startTime)).forEach(d=>{ const div=document.createElement('div'); div.className="card"; div.style.cursor="pointer"; const s=new Date(d.startTime), e=new Date(d.endTime), tStr=`${s.getHours()}:${String(s.getMinutes()).padStart(2,'0')} - ${e.getHours()}:${String(e.getMinutes()).padStart(2,'0')}`; div.innerHTML=`<div style="font-weight:bold; color:#0b57d0;">${tStr}</div><div>${d.type==='event'?d.title:d.bandName}</div>`+(d.status==='pending'?'<div style="font-size:10px; color:#b06000;">â—æ‰¿èªå¾…ã¡</div>':''); div.onclick=()=>{closeModal('modal-event-list'); openEditBookingModal(d.id,d);}; c.appendChild(div); }); openModal('modal-event-list'); };
        
        window.handleNewBooking = () => { isSelecting = false; const now = new Date(); let startH = 10; if (displayDate.toDateString() === now.toDateString()) { startH = now.getHours() + 1; if (startH < 9) startH = 9; } if (startH >= 20) startH = 19; selectionStartHour = startH; selectionEndHour = startH + 1; openBookingModalRange(); };
        window.openSearchModal = () => { document.getElementById('searchInput').value = ""; document.getElementById('filterMyBands').checked = false; document.getElementById('searchResultContainer').innerHTML = ""; window.filterSearchResults(); openModal('modal-search'); };
        
        // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°é–¢æ•°ã®ä¿®æ­£ï¼šè‡ªåˆ†ã®ãƒãƒ³ãƒ‰ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ã‚’è¿½åŠ 
        window.filterSearchResults = () => {
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            const onlyMyBands = document.getElementById('filterMyBands').checked;
            const container = document.getElementById('searchResultContainer');
            container.innerHTML = "";
            
            const myBandIds = myBandsAll.map(b => b.id);

            const filtered = loadedBookingsCache.filter(b => {
                const text = (b.bandName || "") + (b.title || "") + (b.userName || "");
                const matchesKeyword = text.toLowerCase().includes(keyword);
                
                if (onlyMyBands) {
                    // ã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆã¯é™¤å¤–ã™ã‚‹ã‹ã€ã‚ã‚‹ã„ã¯è‡ªåˆ†ãŒå‚åŠ ã—ã¦ã„ã‚‹ã¨ã¿ãªã™ã‹è¦æ¤œè¨ã ãŒã€
                    // ã“ã“ã§ã¯ãƒãƒ³ãƒ‰ç·´ç¿’ã®äºˆç´„ã§è‡ªåˆ†ã®ãƒãƒ³ãƒ‰IDã¨ä¸€è‡´ã™ã‚‹ã‚‚ã®ã®ã¿ã¨ã™ã‚‹
                    if (b.type === 'event') return false; 
                    return matchesKeyword && myBandIds.includes(b.bandId);
                }
                
                return matchesKeyword;
            });

            if (filtered.length === 0) {
                container.innerHTML = "<div style='text-align:center; color:#999; padding:20px;'>è©²å½“ã™ã‚‹äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“</div>";
                return;
            }

            filtered.sort((a,b)=>new Date(a.startTime)-new Date(b.startTime));

            filtered.forEach(d => {
                const div = document.createElement('div');
                div.className = "card";
                div.style.cursor = "pointer";
                const s = new Date(d.startTime);
                const dateStr = `${s.getMonth()+1}/${s.getDate()}`;
                const timeStr = `${s.getHours()}:${String(s.getMinutes()).padStart(2,'0')}`;
                
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between;">
                        <div style="font-weight:bold;">${dateStr} ${timeStr}</div>
                        <div style="font-size:12px; color:#666;">${d.type==='event'?'ã‚¤ãƒ™ãƒ³ãƒˆ':'ç·´ç¿’'}</div>
                    </div>
                    <div style="font-weight:bold; color:#0b57d0;">${d.type==='event'?d.title:d.bandName}</div>
                    <div style="font-size:12px;">${d.userName||''}</div>
                `;
                div.onclick = () => {
                    closeModal('modal-search');
                    displayDate.setTime(s.getTime());
                    renderCalendar(); 
                    setTimeout(() => openEditBookingModal(d.id, d), 300);
                };
                container.appendChild(div);
            });
        };

        function loadDayBookings(){ const sD=new Date(displayDate), eD=new Date(displayDate); sD.setHours(0,0,0,0); eD.setHours(23,59,59,999); onSnapshot(query(collection(db,"bookings"),where("startTime",">=",sD),where("startTime","<=",eD)),(qs)=>{ document.querySelectorAll('.event-block').forEach(el=>el.remove()); const evs=[]; qs.forEach(snap=>{const d=snap.data(); d.id=snap.id; evs.push(d);}); if(evs.length===0)return; evs.sort((a,b)=>a.startTime.toDate()-a.startTime.toDate()); const clusters=[]; let curC=[], curE=0; evs.forEach(ev=>{const sT=ev.startTime.toDate().getTime(), eT=ev.endTime.toDate().getTime(); if(curC.length===0||sT<curE){curC.push(ev); if(eT>curE)curE=eT;} else {clusters.push(curC); curC=[ev]; curE=eT;} }); if(curC.length>0)clusters.push(curC); clusters.forEach(cl=>{ let pts=[]; cl.forEach(e=>{pts.push({t:e.startTime.toDate().getTime(),type:1}); pts.push({t:e.endTime.toDate().getTime(),type:-1});}); pts.sort((a,b)=>a.t-b.t||a.type-b.type); let maxC=0, curCon=0; pts.forEach(p=>{curCon+=p.type; if(curCon>maxC)maxC=curCon;}); if(maxC>3)renderSummaryBlock(cl,new Date(Math.min(...cl.map(e=>e.startTime.toDate().getTime()))),new Date(Math.max(...cl.map(e=>e.endTime.toDate().getTime())))); else { const cols=[]; cl.forEach(e=>{ let ok=false; const s=e.startTime.toDate().getTime(), end=e.endTime.toDate().getTime(); for(let i=0; i<cols.length;i++){if(cols[i]<=s){e.colIndex=i; cols[i]=end; ok=true; break;}} if(!ok){e.colIndex=cols.length; cols.push(end);} }); const wP=85/cols.length; cl.forEach(e=>renderEventBlock(e,e.colIndex*wP,wP)); } }); }); }
        function renderEventBlock(d,l,w){ const s=d.startTime.toDate(), e=d.endTime.toDate(), sM=(s.getHours()-9)*60+s.getMinutes(), eM=(e.getHours()-9)*60+e.getMinutes(), slots=document.querySelectorAll('.time-slot'); if(slots[s.getHours()-9]){ const cA=slots[s.getHours()-9].querySelector('.time-content'), div=document.createElement('div'); div.className='event-block'; div.style.top=(s.getMinutes()+1)+"px"; div.style.height=(eM-sM-2)+"px"; div.style.left=l+"%"; div.style.width=w+"%"; if(d.type==='event'){div.classList.add('special-event'); div.innerHTML=`<div class="event-title">${d.title}</div>`;} else { div.innerHTML=`<div class="event-title">${d.bandName}</div><div style="font-size:10px; opacity:0.8;">${d.userName||''}</div>`; if(d.status==='pending')div.classList.add('pending'); const myB=myBandsAll.map(b=>b.id); if(myB.includes(d.bandId)){if(d.status!=='pending'){div.style.backgroundColor="#e6f4ea"; div.style.borderLeftColor="#34A853"; div.style.color="#0d652d";}} else if(d.status!=='pending'){div.style.backgroundColor="#f1f3f4"; div.style.borderLeftColor="#9aa0a6"; div.style.color="#5f6368";} if(d.source==='lottery'){div.classList.add('lottery-confirmed'); div.style.backgroundColor="#f3e5f5"; div.style.borderLeftColor="#ab47bc"; div.style.color="#4a148c";} } div.onclick=(ev)=>{ev.stopPropagation(); openEditBookingModal(d.id,d);}; cA.appendChild(div); } }
        function renderSummaryBlock(evs,sT,eT){ const sM=(sT.getHours()-9)*60+sT.getMinutes(), eM=(eT.getHours()-9)*60+eT.getMinutes(), slots=document.querySelectorAll('.time-slot'); if(slots[sT.getHours()-9]){ const cA=slots[sT.getHours()-9].querySelector('.time-content'), div=document.createElement('div'); div.className='event-block cluster'; div.style.top=(sT.getMinutes()+1)+"px"; div.style.height=(eM-sM-2)+"px"; div.style.width="85%"; div.innerHTML=`<div class="event-title">äºˆç´„ ${evs.length}ä»¶</div>`; div.onclick=(e)=>{e.stopPropagation(); openEventListModal(evs);}; cA.appendChild(div); } }
        window.saveBooking=async()=>{ const eid=document.getElementById('editingBookingId').value, t=document.querySelector('input[name="bookingType"]:checked')?.value||'normal'; let bd={creatorId:currentUser,userName:currentProfile.displayName,type:t,createdAt:new Date()}; if(t==='normal'){const bS=document.getElementById('selectBookingBand'); if(!bS.value)return await showCustomAlert("äºˆç´„ã™ã‚‹ãƒãƒ³ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚", "å…¥åŠ›ã‚¨ãƒ©ãƒ¼"); bd.bandId=bS.value; bd.bandName=bS.options[bS.selectedIndex].text;} else {const tit=document.getElementById('inputEventTitle').value.trim(); if(!tit)return await showCustomAlert("ã‚¤ãƒ™ãƒ³ãƒˆåã¾ãŸã¯ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", "å…¥åŠ›ã‚¨ãƒ©ãƒ¼"); bd.title=tit; bd.bandName=tit;} let sH,sM,eH,eM; if(document.getElementById('checkAllDay').checked){sH=9;sM=0;eH=20;eM=0;} else {const sTS=document.getElementById('selectStartTime').value, eTS=document.getElementById('selectEndTime').value; [sH,sM]=sTS.split(':').map(Number); [eH,eM]=eTS.split(':').map(Number);} const st=new Date(displayDate), et=new Date(displayDate); st.setHours(sH,sM,0,0); et.setHours(eH,eM,0,0); if(st>=et)return await showCustomAlert("çµ‚äº†æ™‚é–“ã¯é–‹å§‹æ™‚é–“ã‚ˆã‚Šå¾Œã®æ™‚é–“ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚", "æ™‚é–“ä¸æ­£"); bd.startTime=st; bd.endTime=et; const mode=currentSystemSettings.bookingMode||'first_come'; if(mode==='first_come'){ const q=query(collection(db,"bookings"),where("startTime",">=",new Date(st).setHours(0,0,0,0)),where("startTime","<=",new Date(st).setHours(23,59,59,999))); try{ const snap=await getDocs(q); let over=false; snap.forEach(d=>{if(eid&&d.id===eid)return; const e=d.data().startTime.toDate(), f=d.data().endTime.toDate(); if(e<et&&f>st)over=true;}); if(over)return await showCustomAlert("ã“ã®æ™‚é–“å¸¯ã«ã¯æ—¢ã«ä»–ã®äºˆç´„ãŒå…¥ã£ã¦ã„ã¾ã™ã€‚", "é‡è¤‡ã‚ã‚Š"); bd.status='confirmed'; }catch(e){return await showCustomAlert(e.message, "ã‚¨ãƒ©ãƒ¼")} } else bd.status='pending'; try{ if(eid){delete bd.createdAt; await updateDoc(doc(db,"bookings",eid),bd); await showCustomAlert("äºˆç´„å†…å®¹ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");} else {await addDoc(collection(db,"bookings"),bd); await showCustomAlert(mode==='lottery'?"å¸Œæœ›ã‚’æå‡ºã—ã¾ã—ãŸã€‚ç®¡ç†è€…ã®æ‰¿èªã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚":"äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸã€‚");} closeModal('modal-booking'); }catch(e){await showCustomAlert(e.message, "ã‚¨ãƒ©ãƒ¼")} };
        window.addToGoogleCalendar=()=>{ if(!editingBookingData)return; const t=editingBookingData.bandName||"ç·´ç¿’", s=editingBookingData.startTime.toDate().toISOString().replace(/-|:|\.\d\d\d/g,""), e=editingBookingData.endTime.toDate().toISOString().replace(/-|:|\.\d\d\d/g,""); window.open(`https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(t)}&dates=${s}/${e}`, '_blank'); };
        window.deleteBooking=async()=>{ const eid=document.getElementById('editingBookingId').value; if(eid && await showCustomConfirm("ã“ã®äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ", "äºˆç´„å‰Šé™¤")){try{await deleteDoc(doc(db,"bookings",eid)); await showCustomAlert("äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚"); closeModal('modal-booking');}catch(e){await showCustomAlert(e.message, "ã‚¨ãƒ©ãƒ¼")}} };
        
        main();
    </script>
</body>
</html>
