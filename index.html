<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LMC Mobile - ãƒã‚¤ãƒãƒ³ãƒ‰</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; font-family: 'Roboto', 'Noto Sans JP', sans-serif; background-color: rgb(241, 244, 249); color: #1f1f1f; min-height: 100vh; padding-bottom: 88px; overscroll-behavior-y: none; user-select: none; -webkit-user-select: none; }
        .container { max-width: 480px; margin: 0 auto; height: 100%; display: flex; flex-direction: column; } .hidden { display: none !important; }
        .app-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: rgb(241, 244, 249); flex-shrink: 0; z-index: 500; }
        .header-title { font-size: 22px; font-weight: bold; color: #1f1f1f; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .header-avatar { width: 36px; height: 36px; border-radius: 50%; display: flex; justify-content: center; align-items: center; background: #dadce0; cursor: pointer; position: relative; }
        .header-avatar img { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid white; z-index: 2; }
        .ring-sound { background: #1a73e8; box-shadow: 0 0 5px rgba(26,115,232,0.5); } .ring-light { background: #fa7b17; box-shadow: 0 0 5px rgba(250,123,23,0.5); }
        .ring-stage { background: #34A853; box-shadow: 0 0 5px rgba(52,168,83,0.5); } .ring-video { background: #EA4335; box-shadow: 0 0 5px rgba(234,67,53,0.5); }
        .ring-rainbow { background: linear-gradient(135deg, #EA4335, #FBBC05, #34A853, #4285F4); animation: spin 4s linear infinite; }
        .ring-birthday { background: linear-gradient(45deg, #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000); background-size: 400%; animation: birthday-glow 3s linear infinite; box-shadow: 0 0 8px rgba(255, 215, 0, 0.8); }
        @keyframes spin { 100% { transform: rotate(360deg); } } @keyframes birthday-glow { 0% { background-position: 0 0; } 50% { background-position: 400% 0; } 100% { background-position: 0 0; } }
        /* Modified scroll-content for slider */
        .scroll-content { flex-grow: 1; overflow-y: auto; overflow-x: hidden; padding-bottom: 100px; -webkit-overflow-scrolling: touch; position: relative; }
        .card { background: white; border-radius: 16px; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); margin-bottom: 12px; transition: background-color 0.2s; } .card.band-card:active { background-color: #f5f5f5; }
        .band-item { display: flex; align-items: center; border-bottom: 1px solid #f0f0f0; padding-bottom: 12px; margin-bottom: 12px; } .band-item:last-child { border: none; margin: 0; padding: 0; }
        .band-icon { width: 48px; height: 48px; background: #e0e3e7; border-radius: 12px; display: flex; justify-content: center; align-items: center; margin-right: 12px; font-size: 20px; color: #5f6368; font-weight: bold; overflow: hidden; } .band-icon img { width: 100%; height: 100%; object-fit: cover; }
        .band-info { flex-grow: 1; } .band-name { font-weight: bold; font-size: 16px; } .band-members { font-size: 12px; color: #5f6368; }
        .band-tabs { display: flex; background: white; border-radius: 12px; padding: 4px; margin: 0 16px 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); flex-shrink: 0; z-index: 10; position: relative; } .band-tab { flex: 1; text-align: center; padding: 10px; font-size: 14px; font-weight: bold; border-radius: 8px; cursor: pointer; color: #5f6368; transition: all 0.3s ease; } .band-tab.active { background: #e8f0fe; color: #0b57d0; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #ffffff; border-top: 1px solid #e0e3e7; display: flex; justify-content: space-around; padding: 12px 0 28px; z-index: 2000; box-shadow: 0 -1px 3px rgba(0,0,0,0.05); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #444746; font-size: 12px; width: 72px; cursor: pointer; gap: 4px; font-weight: 500; }
        .nav-icon { font-size: 24px; padding: 4px 20px; border-radius: 16px; transition: background-color 0.2s ease-in-out, color 0.2s; } .nav-item.active .nav-icon { background-color: #c2e7ff; color: #001d35; } .nav-item#nav-admin.active .nav-icon { background-color: #ffd8e4; color: #31111d; } .nav-item.active span { color: #1f1f1f; font-weight: bold; }
        .fab { position: fixed; bottom: 100px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background: #c2e7ff; color: #001d35; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; z-index: 900; }
        .btn-primary { background: #0b57d0; color: white; border: none; padding: 12px 20px; border-radius: 24px; width: 100%; font-weight: bold; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .btn-secondary { background: #f1f3f4; color: #1f1f1f; border: none; padding: 12px 20px; border-radius: 24px; width: 100%; margin-top: 8px; cursor: pointer; font-weight: bold; }
        .btn-danger { background: #fee2e2; color: #d93025; border: none; padding: 12px 20px; border-radius: 24px; width: 100%; margin-top: 8px; cursor: pointer; font-weight: bold; }
        .btn-outline { background: white; color: #0b57d0; border: 1px solid #dadce0; padding: 6px 12px; border-radius: 16px; font-size: 12px; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; margin-left: auto; }
        .image-picker-area { display: flex; justify-content: center; margin-bottom: 20px; } .image-picker { width: 80px; height: 80px; background: #f1f3f4; border-radius: 16px; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #0b57d0; cursor: pointer; overflow: hidden; position: relative; }
        .image-picker img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; } .image-picker i { font-size: 24px; z-index: 1; } .image-picker span { font-size: 10px; z-index: 1; margin-top: 4px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9000; display: none; justify-content: center; align-items: flex-end; } .modal-overlay.open { display: flex; }
        .modal-content { background: white; width: 100%; max-width: 480px; border-radius: 24px 24px 0 0; padding: 24px; box-sizing: border-box; max-height: 85vh; overflow-y: auto; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .form-group { margin-bottom: 16px; } .form-label { display: block; font-size: 12px; color: #5f6368; margin-bottom: 4px; font-weight: bold; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #dadce0; border-radius: 8px; box-sizing: border-box; font-size: 16px; background: white; }
        .member-select-list { max-height: 200px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; } .member-option { padding: 10px; display: flex; align-items: center; border-bottom: 1px solid #eee; cursor: pointer; }
        .member-option.selected { background: #e8f0fe; } .member-check { margin-right: 10px; color: #0b57d0; }
        .member-list-edit { margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; } .member-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
        .btn-remove-member { font-size: 11px; color: #d93025; border: 1px solid #d93025; background: white; border-radius: 4px; padding: 2px 8px; cursor: pointer; }
        .user-status-card { text-align: center; padding: 20px; } .user-status-icon { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; border: 4px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); } .user-status-name { font-size: 18px; font-weight: bold; margin-bottom: 20px; } .fee-status-row { display: flex; gap: 10px; justify-content: center; margin-top: 10px; } .fee-status-badge { flex: 1; padding: 10px; border-radius: 8px; font-size: 14px; font-weight: bold; } .fee-paid { background-color: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; } .fee-unpaid { background-color: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
        .band-name-input:focus { outline: none; border-bottom: 2px solid #0b57d0; background: rgba(255,255,255,0.5); }
        .member-row-rich { display: flex; align-items: center; padding: 12px 16px; border-bottom: 1px solid #f0f0f0; } .member-row-rich:last-child { border-bottom: none; }
        .member-avatar-small { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; margin-right: 12px; background: #eee; }
        .member-info-rich { flex-grow: 1; } .member-name-rich { font-size: 14px; font-weight: bold; color: #1f1f1f; }
        .member-role-badge { font-size: 10px; background: #e8f0fe; color: #0b57d0; padding: 2px 8px; border-radius: 10px; margin-left: 6px; }
        .booking-history-item { padding: 12px 16px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; justify-content: space-between; } .booking-history-item:last-child { border-bottom: none; }
        .booking-date { font-weight: bold; font-size: 14px; color: #1f1f1f; } .booking-status { font-size: 11px; padding: 2px 8px; border-radius: 4px; }
        .stat-badge { background: #f8f9fa; padding: 6px 12px; border-radius: 12px; display: flex; flex-direction: column; align-items: center; border: 1px solid #eee; flex: 1; }
        .stat-value { font-size: 15px; font-weight: bold; color: #0b57d0; }
        .stat-label { font-size: 9px; color: #5f6368; font-weight: bold; }
        .dialog-content { background: white; width: 85%; max-width: 320px; border-radius: 20px; padding: 24px; text-align: center; animation: zoomIn 0.2s ease; margin: auto; }
        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .dialog-title { font-weight: bold; font-size: 18px; margin-bottom: 12px; color: #1f1f1f; }
        .dialog-message { font-size: 14px; color: #444746; margin-bottom: 24px; line-height: 1.5; white-space: pre-wrap; }
        .dialog-buttons { display: flex; gap: 12px; }
        .dialog-btn { flex: 1; padding: 12px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 14px; }
        .btn-dialog-cancel { background: #f1f3f4; color: #1f1f1f; }
        .btn-dialog-ok { background: #0b57d0; color: white; }

        /* --- Slider Styles --- */
        .band-slider {
            display: flex;
            width: 200%;
            transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }
        .band-slide {
            width: 50%;
            padding: 16px;
            box-sizing: border-box;
        }

        /* --- Notification Styles --- */
        .header-right { display: flex; align-items: center; gap: 16px; }
        .notification-btn { position: relative; width: 36px; height: 36px; display: flex; justify-content: center; align-items: center; cursor: pointer; border-radius: 50%; transition: background 0.2s; }
        .notification-btn:active { background: #f1f3f4; }
        .notification-icon { font-size: 24px; color: #5f6368; }
        .notification-badge { position: absolute; top: 4px; right: 4px; width: 10px; height: 10px; background: #d93025; border-radius: 50%; border: 2px solid white; display: none; }
        .notification-badge.show { display: block; }
        
        .notification-list { list-style: none; padding: 0; margin: 0; }
        .notification-item { padding: 16px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: flex-start; gap: 12px; }
        .notification-item:last-child { border-bottom: none; }
        .notification-item.unread { background: #f0f8ff; }
        .notification-item.clickable { cursor: pointer; }
        .notification-item.clickable:active { background-color: #e8f0fe; }
        .notif-icon-box { width: 32px; height: 32px; border-radius: 50%; background: #e8f0fe; display: flex; align-items: center; justify-content: center; color: #0b57d0; flex-shrink: 0; }
        .notif-icon-box.warning { background: #fce8e6; color: #d93025; }
        .notif-content { flex-grow: 1; }
        .notif-text { font-size: 13px; color: #1f1f1f; line-height: 1.5; margin-bottom: 4px; }
        .notif-date { font-size: 11px; color: #5f6368; }
    </style>
</head>
<body>
    <div id="modal-custom-dialog" class="modal-overlay" style="align-items: center; z-index: 10000;">
        <div class="dialog-content">
            <div id="dialogTitle" class="dialog-title">ç¢ºèª</div>
            <div id="dialogMessage" class="dialog-message">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
            <div class="dialog-buttons">
                <button id="dialogBtnCancel" class="dialog-btn btn-dialog-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="dialogBtnOk" class="dialog-btn btn-dialog-ok">OK</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="app-header">
            <div class="header-title">
                ãƒã‚¤ãƒãƒ³ãƒ‰
                <span id="displayActiveEvent" style="display:none; font-size:11px; font-weight:bold; background:#fff3e0; color:#e65100; padding:4px 8px; border-radius:12px; margin-left:4px;"></span>
            </div>
            <div class="header-right">
                <div class="notification-btn" onclick="openNotificationModal()">
                    <span class="material-icons notification-icon">notifications</span>
                    <span class="notification-badge" id="headerNotifBadge"></span>
                </div>
                <div class="header-avatar" id="headerIconBands"></div>
            </div>
        </div>
        <div class="band-tabs"><div class="band-tab active" onclick="switchBandTab('active')">æ´»å‹•ä¸­</div><div class="band-tab" onclick="switchBandTab('archived')">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</div></div>
        
        <div class="scroll-content">
            <div id="bandSlider" class="band-slider">
                <div id="activeBandList" class="band-slide">
                    <div style="text-align:center; color:#999; margin-top:40px;">èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
                <div id="archivedBandList" class="band-slide">
                    <div style="text-align:center; color:#999; margin-top:40px;">èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
            </div>
        </div>
        
        <div class="fab" onclick="openBandModal()"><span class="material-icons">add</span></div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="window.location.href='/index.html'"><span class="material-icons nav-icon">groups</span><span>ãƒã‚¤ãƒãƒ³ãƒ‰</span></div>
        <div class="nav-item" onclick="window.location.href='/booking.html'"><span class="material-icons nav-icon">calendar_month</span><span>åˆã‚ã›äºˆç´„</span></div>
        <div class="nav-item" onclick="window.location.href='/cue.html'"><span class="material-icons nav-icon">description</span><span>Cueã‚·ãƒ¼ãƒˆ</span></div>
        <div class="nav-item hidden" id="nav-admin" onclick="window.location.href='/manage.html'"><span class="material-icons nav-icon">admin_panel_settings</span><span>ç®¡ç†</span></div>
        <div class="nav-item" onclick="goToMyPage()"><span class="material-icons nav-icon">account_circle</span><span>ãƒã‚¤ãƒšãƒ¼ã‚¸</span></div>
    </div>

    <!-- Modals -->
    <div id="modal-band" class="modal-overlay" onclick="if(event.target===this) closeModal('modal-band')"><div class="modal-content"><h3 style="margin-top:0;">ãƒãƒ³ãƒ‰çµæˆ</h3><p style="font-size:12px; color:#5f6368; margin-bottom:20px;">ãƒªã‚¹ãƒˆã‹ã‚‰é¸ã¶ã‹ã€å¾Œã‹ã‚‰æ‹›å¾…ãƒªãƒ³ã‚¯ã‚’é€ã£ã¦ãã ã•ã„ã€‚</p><div class="image-picker-area"><div class="image-picker" onclick="document.getElementById('bandIconInput').click()"><i class="material-icons">add_a_photo</i><span>å†™çœŸ</span><img id="previewBandIcon" class="hidden" src=""></div><input type="file" id="bandIconInput" accept="image/*" hidden onchange="handleImageSelect(this, 'previewBandIcon')"></div><div class="form-group"><label class="form-label">ãƒãƒ³ãƒ‰å</label><input type="text" id="inputBandName" class="form-input" placeholder="ä¾‹: æ”¾èª²å¾Œãƒ†ã‚£ãƒ¼ã‚¿ã‚¤ãƒ "></div><div class="form-group"><label class="form-label">ãƒ¡ãƒ³ãƒãƒ¼ã‚’æ¤œç´¢</label><input type="text" id="bandMemberSearchInput" class="form-input" placeholder="æ°åã¾ãŸã¯ã‹ãªã§æ¤œç´¢..."></div><div class="form-group"><label class="form-label">ãƒ¡ãƒ³ãƒãƒ¼é¸æŠ (ç™»éŒ²æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼)</label><div class="member-select-list" id="userSelectList"></div></div><button class="btn-primary" onclick="saveBand()">ä½œæˆã™ã‚‹</button><button class="btn-secondary" onclick="closeModal('modal-band')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></div></div>
    <div id="modal-band-detail" class="modal-overlay" onclick="if(event.target===this) closeModal('modal-band-detail')">
        <div class="modal-content" style="padding: 0; overflow: hidden; display: flex; flex-direction: column; max-height: 90vh;">
            <div class="band-detail-header" style="background: white; padding: 24px 20px; border-bottom: 1px solid #f0f0f0; position: relative;">
                <button onclick="closeModal('modal-band-detail')" style="position: absolute; top: 16px; left: 16px; background: rgba(0,0,0,0.05); border: none; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10;"><span class="material-icons" style="font-size: 20px; color: #5f6368;">close</span></button>
                <div style="display: flex; align-items: flex-start; gap: 20px; margin-top: 20px;">
                    <div class="image-picker-area" style="position: relative; width: 88px; height: 88px; flex-shrink: 0; overflow: visible; margin: 0;">
                        <div class="image-picker" id="detailIconPicker" style="width: 88px; height: 88px; border-radius: 50%; border: 1px solid #eee; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow: visible; position: relative; background: #fafafa; padding: 0;">
                            <img id="detailBandIcon" src="" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%; display: block; aspect-ratio: 1/1;">
                            <div class="edit-badge" style="position: absolute; bottom: 0; right: 0; background: #0b57d0; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 20; transform: translate(15%, 15%);"><span class="material-icons" style="font-size: 16px;">edit</span></div>
                        </div>
                        <input type="file" id="editBandIconInput" accept="image/*" hidden onchange="handleImageEdit(this)">
                    </div>
                    <div style="flex-grow: 1; padding-top: 4px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; gap: 8px;">
                            <div style="position: relative; flex-grow: 1; min-width: 0;">
                                <input type="text" id="detailBandName" class="band-name-input" value="ãƒãƒ³ãƒ‰å" readonly style="font-size: 18px; font-weight: bold; border: none; background: transparent; width: 100%; color: #1f1f1f; padding: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            </div>
                            <button class="btn-outline" id="btnInviteInModal" style="border-radius: 12px; border: 1px solid #dadce0; padding: 4px 10px; font-size: 11px; font-weight: bold; color: #1f1f1f; background: white; white-space: nowrap; flex-shrink: 0;"><span class="material-icons" style="font-size: 14px; margin-right: 4px;">share</span>æ‹›å¾…</button>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <div class="stat-badge"><span class="stat-value" id="stat-booking-count">--</span><span class="stat-label">æ¼”å¥å›æ•°</span></div>
                            <div class="stat-badge"><span class="stat-value" id="stat-song-count">--</span><span class="stat-label">æ¼”å¥æ›²æ•°</span></div>
                        </div>
                    </div>
                </div>
            </div>
            <div style="padding: 20px; overflow-y: auto; flex-grow: 1; background: #fafafa;">
                <input type="hidden" id="detailBandId">
                <div class="section-title" style="font-size: 13px; font-weight: bold; color: #5f6368; margin-bottom: 10px; display: flex; align-items: center;"><span class="material-icons" style="font-size: 16px; margin-right: 6px;">groups</span>ãƒ¡ãƒ³ãƒãƒ¼</div>
                <div class="card" style="padding: 0; overflow: hidden; margin-bottom: 24px;">
                    <div class="member-list-edit" id="detailMemberList" style="border: none; padding: 0; margin: 0;"></div>
                    <button id="btnAddMemberToBand" class="btn-flat" onclick="openAddMemberModal()" style="width: 100%; padding: 12px; text-align: center; color: #0b57d0; font-weight: bold; border: none; background: white; border-top: 1px solid #f0f0f0; cursor: pointer; display: flex; align-items: center; justify-content: center;"><span class="material-icons" style="font-size: 18px; margin-right: 6px;">person_add</span>ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ </button>
                </div>
                <div id="bandSongsArea">
                    <div class="section-title" style="font-size: 13px; font-weight: bold; color: #5f6368; margin-bottom: 10px; display: flex; align-items: center;"><span class="material-icons" style="font-size: 16px; margin-right: 6px;">music_note</span>æ¼”å¥æ›²</div>
                    <div class="card" style="padding: 0; overflow: hidden; margin-bottom: 24px;">
                        <div id="bandSongsList" style="padding: 0;"></div>
                        <div id="bandSongAddArea" class="hidden" style="padding: 10px; background: #fff; border-top: 1px solid #f0f0f0; display: flex; gap: 8px; align-items: center;">
                            <input type="text" id="inputNewSong" class="form-input" style="padding: 8px; font-size: 14px; flex-grow: 1;" placeholder="æ›²åã‚’å…¥åŠ›...">
                            <button class="btn-primary" style="width: auto; padding: 8px 16px; font-size: 13px; margin: 0; border-radius: 8px;" onclick="addSongToBand()">è¿½åŠ </button>
                        </div>
                    </div>
                </div>
                <div id="adminBandBookingsArea">
                    <div class="section-title" style="font-size: 13px; font-weight: bold; color: #5f6368; margin-bottom: 10px; display: flex; align-items: center;"><span class="material-icons" style="font-size: 16px; margin-right: 6px;">calendar_today</span>ç›´è¿‘ã®ã‚ã‚ã›</div>
                    <div class="card" style="padding: 0; overflow: hidden; margin-bottom: 24px; min-height: 40px;"><div id="adminBandBookingsList" style="max-height: 150px; overflow-y: auto;"></div></div>
                </div>
                <div id="bandCreatorActions" class="hidden" style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="btn-secondary" onclick="updateBandName()" style="background: #f1f3f4; color: #1f1f1f; border: none;">åå‰ã‚’ä¿å­˜</button>
                    <div style="display: flex; gap: 10px;">
                        <button id="btnArchive" class="btn-secondary" onclick="archiveBand()" style="flex: 1; background: #fff8e1; color: #f57f17; margin: 0;">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</button>
                        <button id="btnRestore" class="btn-secondary hidden" onclick="restoreBand()" style="flex: 1; background: #fff8e1; color: #f57f17; margin: 0;">å¾©å…ƒ</button>
                        <button class="btn-danger" onclick="deleteBand()" style="flex: 1; margin: 0;">è§£æ•£</button>
                    </div>
                </div>
                <div id="bandMemberActions" class="hidden"><button class="btn-danger" onclick="leaveBand()" style="width: 100%;">è„±é€€ã™ã‚‹</button></div>
            </div>
        </div>
    </div>
    <div id="modal-add-member" class="modal-overlay" onclick="if(event.target===this) closeModal('modal-add-member')"><div class="modal-content"><h3 style="margin-top:0;">ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ </h3><p style="font-size:12px; color:#5f6368; margin-bottom:20px;">è¿½åŠ ã—ãŸã„ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p><div class="form-group"><div class="member-select-list" id="addMemberSelectList"></div></div><button class="btn-primary" onclick="saveAddedMembers()">è¿½åŠ ã™ã‚‹</button><button class="btn-secondary" onclick="closeModal('modal-add-member')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></div></div>
    <div id="modal-user-status" class="modal-overlay" onclick="if(event.target===this) closeModal('modal-user-status')"><div class="modal-content"><h3 style="margin-top:0; text-align:center; font-size:16px; color:#5f6368;">ãƒã‚¤ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3><div class="user-status-card"><img id="modalUserIcon" src="" class="user-status-icon"><div id="modalUserName" class="user-status-name"></div><div style="background:#f9f9f9; padding:15px; border-radius:12px;"><div id="statusFeeYear" style="font-size:12px; color:#666; margin-bottom:10px; font-weight:bold;">2025å¹´åº¦ éƒ¨è²»</div><div class="fee-status-row"><div id="statusFeeTerm1" class="fee-status-badge">å‰æœŸ: -</div><div id="statusFeeTerm2" class="fee-status-badge">å¾ŒæœŸ: -</div></div></div><div style="margin-top:20px;"><div style="font-size:12px; color:#999; margin-bottom:5px;">ä¼šå“¡QRã‚³ãƒ¼ãƒ‰</div><div id="myQRCodeArea" style="width:150px; height:150px; background:#eee; margin:0 auto; display:flex; align-items:center; justify-content:center;"><span class="material-icons" style="font-size:48px; color:#ccc;">qr_code_2</span></div></div></div><button class="btn-secondary" onclick="closeModal('modal-user-status')">é–‰ã˜ã‚‹</button></div></div>

    <!-- Notification Modal -->
    <div id="modal-notification" class="modal-overlay" onclick="if(event.target===this) closeModal('modal-notification')">
        <div class="modal-content">
            <h3 style="margin-top:0; margin-bottom:10px; font-size:18px;">é€šçŸ¥</h3>
            <div class="scroll-content" style="padding:0; max-height:60vh; overflow-y:auto;">
                <div id="notificationList" class="notification-list">
                    <!-- JS populated -->
                </div>
            </div>
            <button class="btn-secondary" onclick="closeModal('modal-notification')">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <!-- Email Register Modal -->
    <div id="modal-email-register" class="modal-overlay" onclick="if(event.target===this) closeModal('modal-email-register')">
        <div class="modal-content">
            <h3 style="margin-top:0;">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç™»éŒ²</h3>
            <p style="font-size:12px; color:#5f6368; margin-bottom:20px;">é‡è¦ãªãŠçŸ¥ã‚‰ã›ã‚„é€£çµ¡ã®ãŸã‚ã«ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç™»éŒ²ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚</p>
            <div class="form-group">
                <label class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                <input type="email" id="inputUserEmail" class="form-input" placeholder="example@example.com">
            </div>
            <button class="btn-primary" onclick="saveUserEmail()">ä¿å­˜ã™ã‚‹</button>
            <button class="btn-secondary" onclick="closeModal('modal-email-register')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, setDoc, updateDoc, deleteDoc, query, where, orderBy, onSnapshot, Timestamp, arrayUnion, arrayRemove, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, updateProfile } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        const firebaseConfig = { apiKey: "AIzaSyAWtITnn5uMOPBgOY0Bd7Rt5IN1ry8XoJI", authDomain: "urakata-app.firebaseapp.com", projectId: "urakata-app", storageBucket: "urakata-app.firebasestorage.app", messagingSenderId: "407777765696", appId: "1:407777765696:web:045c2d94729022b4eab2a5", measurementId: "G-9ZRMD26XNJ" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app);
        const MY_LIFF_ID = "2008162165-vVODNp12"; const MY_PAGE_URL = "https://mypage.sorairosystem.com";
        
        // Cache Keys
        const CACHE_KEY_USER = 'lmc_user_cache';
        const CACHE_KEY_BANDS = 'lmc_bands_cache';

        let currentUser=null, currentProfile=null, currentUserData=null, myBandsAll=[], currentBandTab='active', currentEditingBandId=null, currentEditingBandMembers=[], tempBandIconBlob=null, allUsersCache=[], currentFeeSettings={ year:new Date().getFullYear(), term1_amount:0, term2_amount:0 };

        window.showCustomAlert = async function(message, title = "é€šçŸ¥") { return new Promise((resolve) => { const modal = document.getElementById('modal-custom-dialog'); document.getElementById('dialogTitle').innerText = title; document.getElementById('dialogMessage').innerText = message; const okBtn = document.getElementById('dialogBtnOk'); const cancelBtn = document.getElementById('dialogBtnCancel'); cancelBtn.classList.add('hidden'); okBtn.onclick = () => { modal.classList.remove('open'); resolve(); }; modal.classList.add('open'); }); }
        window.showCustomConfirm = async function(message, title = "ç¢ºèª") { return new Promise((resolve) => { const modal = document.getElementById('modal-custom-dialog'); document.getElementById('dialogTitle').innerText = title; document.getElementById('dialogMessage').innerText = message; const okBtn = document.getElementById('dialogBtnOk'); const cancelBtn = document.getElementById('dialogBtnCancel'); cancelBtn.classList.remove('hidden'); okBtn.onclick = () => { modal.classList.remove('open'); resolve(true); }; cancelBtn.onclick = () => { modal.classList.remove('open'); resolve(false); }; modal.classList.add('open'); }); }
        window.openModal=(id)=>document.getElementById(id).classList.add('open');
        window.closeModal=(id)=>document.getElementById(id).classList.remove('open');
        window.goToMyPage=()=>window.location.href=MY_PAGE_URL;
        function getPartLabel(p){ return {vocal:"Vo",guitar:"Gt",bass:"Ba",drums:"Dr",keyboard:"Key"}[p]||""; }
        async function refreshAllUsersCache(){ const qs=await getDocs(collection(db,"users")); allUsersCache=[]; qs.forEach(doc=>allUsersCache.push({id:doc.id,...doc.data()})); }
        
        function getFiscalYear() {
            const now = new Date();
            return now.getMonth() < 3 ? now.getFullYear() - 1 : now.getFullYear();
        }

        async function loadSystemSettings() {
            try {
                const snap = await getDoc(doc(db, "system", "settings"));
                let year = getFiscalYear();
                let eventName = "";

                if (snap.exists()) {
                    const d = snap.data();
                    if (d.currentYear) year = d.currentYear;
                    if (d.activeEventId) {
                        try {
                            const evSnap = await getDoc(doc(db, "events", d.activeEventId));
                            if (evSnap.exists()) {
                                eventName = evSnap.data().event || evSnap.data().name;
                            }
                        } catch (e) { console.error(e); }
                    }
                }
                
                const eEl = document.getElementById('displayActiveEvent');
                if (eEl && eventName) {
                    eEl.innerText = eventName;
                    eEl.style.display = "inline-block";
                } else if (eEl) {
                    eEl.style.display = "none";
                }

            } catch (e) {
                console.error("Settings load error", e);
            }
        }

        async function main(){ 
            try{ 
                // [é«˜é€ŸåŒ– 1] ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¡¨ç¤º
                const cachedUserStr = localStorage.getItem(CACHE_KEY_USER);
                if (cachedUserStr) {
                    try {
                        const u = JSON.parse(cachedUserStr);
                        currentUserData = u; // ä¸€æ™‚ã‚»ãƒƒãƒˆ
                        renderHeaderIcons(u);
                    } catch (e) { console.error("User cache error", e); }
                }

                // [é«˜é€ŸåŒ– 2] ãƒãƒ³ãƒ‰ä¸€è¦§ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¡¨ç¤º
                const cachedBandsStr = localStorage.getItem(CACHE_KEY_BANDS);
                if (cachedBandsStr) {
                    try {
                        myBandsAll = JSON.parse(cachedBandsStr);
                        renderBandList(); 
                    } catch (e) { console.error("Bands cache error", e); }
                }

                // é€šå¸¸ãƒ•ãƒ­ãƒ¼
                try{ if(typeof __initial_auth_token!=='undefined'&&__initial_auth_token)await signInWithCustomToken(auth,__initial_auth_token); else await signInAnonymously(auth); }catch(ae){console.warn(ae)} 
                
                await liff.init({liffId:MY_LIFF_ID}); 
                if(!liff.isLoggedIn()){liff.login();return;} 
                
                const profile=await liff.getProfile(); 
                currentUser=profile.userId; 
                currentProfile=profile;
                
                // Auth Profile Sync
                if (auth.currentUser) {
                    try {
                        await updateProfile(auth.currentUser, {
                            displayName: profile.displayName,
                            photoURL: profile.pictureUrl
                        });
                    } catch (e) {
                        console.error("Auth profile update error", e);
                    }
                }
                
                const userRef=doc(db,"users",currentUser), userSnap=await getDoc(userRef); 
                if(!userSnap.exists()){await showCustomAlert("ã”åˆ©ç”¨ã„ãŸã ãã«ã¯ä¼šå“¡ç™»éŒ²ãŒå¿…è¦ã§ã™ã€‚ä¼šå“¡ç™»éŒ²ç”»é¢ã¸ç§»å‹•ã—ã¾ã™ã€‚"); window.location.href=MY_PAGE_URL; return;} 
                
                // Update Firestore User with firebaseUid
                await setDoc(userRef, {
                    lastLogin: serverTimestamp(),
                    firebaseUid: auth.currentUser ? auth.currentUser.uid : null
                }, {merge:true}); 
                
                currentUserData=userSnap.data(); 
                
                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°ã¨å†æç”»
                localStorage.setItem(CACHE_KEY_USER, JSON.stringify(currentUserData));
                renderHeaderIcons(currentUserData); 
                
                await refreshAllUsersCache(); 
                
                // System Settings Load
                loadSystemSettings();

                // Check Notifications
                checkNotifications();

                const urlParams=new URLSearchParams(window.location.search), act=urlParams.get('action'), iBid=urlParams.get('bandId'); 
                if(act==='invite'&&iBid){await handleInvite(iBid); window.history.replaceState(null,null,window.location.pathname);} 
                
                loadMyBands(); 
            }catch(e){console.error(e)} 
        }

        function renderHeaderIcons(d){ let r=""; const aff=d.affiliations||[], isU=aff.includes("urakata"); if(d.birthday){const t=new Date(), b=new Date(d.birthday); if(t.getMonth()===b.getMonth()&&t.getDate()===b.getDate())r="ring-birthday";} if(!r&&isU)r=d.job?`ring-${d.job}`:"ring-rainbow"; const h=`<img src="${d.icon||'https://ul.h3z.jp/Vnukmtvq.jpg'}">`; const el=document.getElementById('headerIconBands'); if(el){el.innerHTML=h; el.className="header-avatar "+r; el.onclick=openUserStatusModal;} if(isU&&d.role)document.getElementById('nav-admin').classList.remove('hidden'); }
        window.openUserStatusModal=async()=>{ if(!currentUserData)return; if(!currentFeeSettings.year){ try{ const snap=await getDoc(doc(db,"system","fees")); if(snap.exists())currentFeeSettings=snap.data(); }catch(e){console.error(e)} } const year=currentFeeSettings.year||new Date().getFullYear(); const status=currentUserData.feeStatus||{}; document.getElementById('modalUserIcon').src=currentUserData.icon||'https://ul.h3z.jp/Vnukmtvq.jpg'; document.getElementById('modalUserName').innerText=currentUserData.name+" ã•ã‚“"; const isPaid1=!!status[`${year}_1`], isPaid2=!!status[`${year}_2`], t1Text=isPaid1?'æ¸ˆ':'æœªç´', t2Text=isPaid2?'æ¸ˆ':'æœªç´', t1El=document.getElementById('statusFeeTerm1'), t2El=document.getElementById('statusFeeTerm2'); t1El.innerText=`å‰æœŸ: ${t1Text}`; t1El.className=`fee-status-badge ${isPaid1?'fee-paid':'fee-unpaid'}`; t2El.innerText=`å¾ŒæœŸ: ${t2Text}`; t2El.className=`fee-status-badge ${isPaid2?'fee-paid':'fee-unpaid'}`; document.getElementById('statusFeeYear').innerText=`${year}å¹´åº¦ éƒ¨è²»çŠ¶æ³`; if(currentUser){ const qrUrl=`https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${currentUser}`; document.getElementById('myQRCodeArea').innerHTML=`<img src="${qrUrl}" style="width:100%;height:100%;">`; } openModal('modal-user-status'); };

        // Notification Functions
        window.openNotificationModal = () => {
            const list = document.getElementById('notificationList');
            list.innerHTML = "";
            
            const notifications = [];
            
            // Check for Email Registration
            const hasEmail = currentUserData && (currentUserData.Email || currentUserData.email);
            if (!hasEmail) {
                notifications.push({
                    id: 'email_req',
                    type: 'action_required', // custom type
                    text: 'ã€é‡è¦ã€‘ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒæœªç™»éŒ²ã§ã™ã€‚ã“ã“ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚',
                    date: '---',
                    read: false,
                    action: true
                });
            }

            // Mock Data
            notifications.push({ id: 99, type: 'info', text: 'åˆã‚ã¾ã—ã¦ï¼LMC Mobileã¸ã‚ˆã†ã“ãğŸ‰', date: '2025/04/01 12:00', read: false });

            if(notifications.length === 0) {
                list.innerHTML = '<div style="padding:20px; text-align:center; color:#999; font-size:12px;">é€šçŸ¥ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
            } else {
                notifications.forEach(n => {
                    const div = document.createElement('div');
                    div.className = `notification-item ${n.read ? '' : 'unread'} ${n.action ? 'clickable' : ''}`;
                    if(n.action) {
                        div.onclick = () => openEmailRegisterModal();
                    }
                    
                    let icon = 'notifications';
                    let iconClass = '';
                    if(n.type === 'action_required') { icon = 'warning'; iconClass = 'warning'; }
                    else if(n.type === 'check') icon = 'check_circle';
                    
                    div.innerHTML = `
                        <div class="notif-icon-box ${iconClass}"><span class="material-icons" style="font-size:18px;">${icon}</span></div>
                        <div class="notif-content">
                            <div class="notif-text">${n.text}</div>
                            <div class="notif-date">${n.date}</div>
                        </div>
                    `;
                    list.appendChild(div);
                });
            }
            
            // Mark as read (Mock - but keep email warning)
            const hasUnread = notifications.some(n => !n.read && n.id !== 'email_req');
            if(!hasUnread) document.getElementById('headerNotifBadge').classList.remove('show');
            
            openModal('modal-notification');
        };

        window.openEmailRegisterModal = () => {
            closeModal('modal-notification');
            document.getElementById('inputUserEmail').value = "";
            openModal('modal-email-register');
        };

        window.saveUserEmail = async () => {
            const email = document.getElementById('inputUserEmail').value.trim();
            if (!email) return await showCustomAlert("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            if (!email.includes('@')) return await showCustomAlert("æ­£ã—ã„å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");

            try {
                const btn = document.querySelector('#modal-email-register .btn-primary');
                btn.innerText = "ä¿å­˜ä¸­...";
                btn.disabled = true;

                await updateDoc(doc(db, "users", currentUser), {
                    Email: email
                });
                
                // Update local cache
                currentUserData.Email = email;
                localStorage.setItem(CACHE_KEY_USER, JSON.stringify(currentUserData));
                
                await showCustomAlert("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚");
                closeModal('modal-email-register');
                checkNotifications(); 
            } catch(e) {
                await showCustomAlert("ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + e.message, "ã‚¨ãƒ©ãƒ¼");
            } finally {
                const btn = document.querySelector('#modal-email-register .btn-primary');
                btn.innerText = "ä¿å­˜ã™ã‚‹";
                btn.disabled = false;
            }
        };

        function checkNotifications() {
            const hasEmail = currentUserData && (currentUserData.Email || currentUserData.email);
            const badge = document.getElementById('headerNotifBadge');
            
            if (!hasEmail) {
                badge.classList.add('show');
            } else {
                badge.classList.add('show');
            }
        }

        function loadMyBands(){ 
            const q=query(collection(db,"bands"),where("memberIds","array-contains",currentUser)); 
            onSnapshot(q,(snapshot)=>{ 
                myBandsAll=[]; 
                snapshot.forEach(docSnap=>myBandsAll.push({id:docSnap.id,...docSnap.data()})); 
                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°
                localStorage.setItem(CACHE_KEY_BANDS, JSON.stringify(myBandsAll));
                renderBandList(); 
            }); 
        }
        
        // --- Modified Switch Band Tab with Animation ---
        window.switchBandTab=(tab)=>{ 
            currentBandTab=tab; 
            document.querySelectorAll('.band-tab').forEach(el=>el.classList.remove('active')); 
            const idx=(tab==='active')?0:1; 
            document.querySelectorAll('.band-tab')[idx].classList.add('active'); 
            
            const slider = document.getElementById('bandSlider');
            if (tab === 'active') {
                slider.style.transform = 'translateX(0)';
            } else {
                slider.style.transform = 'translateX(-50%)';
            }
        };

        function renderBandList(){ 
            const activeList = document.getElementById('activeBandList');
            const archivedList = document.getElementById('archivedBandList');
            
            activeList.innerHTML = "";
            archivedList.innerHTML = "";
            
            const activeBands = myBandsAll.filter(b => !b.isArchived);
            const archivedBands = myBandsAll.filter(b => b.isArchived);
            
            const createBandItem = (b) => {
                const div=document.createElement('div'); 
                div.className='card band-card'; 
                div.onclick=()=>openBandDetail(b.id,b); 
                let iconH=b.icon?`<div class="band-icon"><img src="${b.icon}"></div>`:`<div class="band-icon">${b.name.charAt(0)}</div>`; 
                div.innerHTML=`<div class="band-item" style="border:none; margin:0; padding:0;">${iconH}<div class="band-info"><div class="band-name">${b.name}</div></div><span class="material-icons" style="color:#ccc;">chevron_right</span></div>`; 
                return div;
            };

            if(activeBands.length === 0) {
                activeList.innerHTML = `<div style="text-align:center; padding:40px; color:#999;">ãªã—</div>`;
            } else {
                activeBands.forEach(b => activeList.appendChild(createBandItem(b)));
            }

            if(archivedBands.length === 0) {
                archivedList.innerHTML = `<div style="text-align:center; padding:40px; color:#999;">ãªã—</div>`;
            } else {
                archivedBands.forEach(b => archivedList.appendChild(createBandItem(b)));
            }
        }
        
        window.openBandModal=()=>{ document.getElementById('inputBandName').value=""; document.getElementById('bandMemberSearchInput').value=""; document.getElementById('userSelectList').innerHTML="èª­ã¿è¾¼ã¿ä¸­..."; tempBandIconBlob=null; document.getElementById('previewBandIcon').classList.add('hidden'); loadUserList('userSelectList'); openModal('modal-band'); };
        async function loadUserList(tid='userSelectList',ex=[]){ const list=document.getElementById(tid), qs=await getDocs(collection(db,"users")); list.innerHTML=""; let c=0; qs.forEach(doc=>{ const u=doc.data(); if(doc.id===currentUser||ex.includes(doc.id))return; const div=document.createElement('div'); div.className='member-option'; div.dataset.uid=doc.id; div.dataset.uname=u.name; div.dataset.ukana=u.kana||""; div.onclick=()=>{div.classList.toggle('selected'); div.querySelector('.material-icons').innerText=div.classList.contains('selected')?'check_box':'check_box_outline_blank';}; div.innerHTML=`<span class="material-icons member-check">check_box_outline_blank</span><img src="${u.icon||'https://ul.h3z.jp/Vnukmtvq.jpg'}" style="width:32px; height:32px; border-radius:50%; margin-right:10px; object-fit:cover;"><div>${u.name} <span style="font-size:10px; color:#999;">${u.part?`(${getPartLabel(u.part)})`:''}</span></div>`; list.appendChild(div); c++; }); if(c===0)list.innerHTML='<div style="padding:10px; color:#999;">ãªã—</div>'; }
        document.getElementById('bandMemberSearchInput')?.addEventListener('input',(e)=>{ const t=e.target.value.trim().toLowerCase(); document.querySelectorAll('#userSelectList .member-option').forEach(el=>{ const n=el.dataset.uname.toLowerCase(), k=(el.dataset.ukana||"").toLowerCase(); el.style.display=(n.includes(t)||k.includes(t))?'flex':'none'; }); });
        
        window.saveBand=async()=>{ const name=document.getElementById('inputBandName').value.trim(); if(!name)return await showCustomAlert("ãƒãƒ³ãƒ‰åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", "å…¥åŠ›ã‚¨ãƒ©ãƒ¼"); const selected=document.querySelectorAll('#userSelectList .member-option.selected'), mIds=[currentUser], mNames=[currentProfile.displayName]; selected.forEach(el=>{mIds.push(el.dataset.uid); mNames.push(el.dataset.uname);}); const btn=document.querySelector('#modal-band .btn-primary'); btn.innerText="å‡¦ç†ä¸­..."; btn.disabled=true; try{ const docRef=await addDoc(collection(db,"bands"),{name:name,memberIds:mIds,memberNames:mNames,creatorId:currentUser,isArchived:false,createdAt:new Date()}); if(tempBandIconBlob){ try{ const url=await uploadImageToExternal(tempBandIconBlob); await updateDoc(doc(db,"bands",docRef.id),{icon:url}); }catch(ie){await showCustomAlert("ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");} } closeModal('modal-band'); if(await showCustomConfirm("ä½œæˆã—ãŸãƒãƒ³ãƒ‰ã«ãƒ¡ãƒ³ãƒãƒ¼ã‚’æ‹›å¾…ã—ã¾ã™ã‹ï¼Ÿ", "ä½œæˆå®Œäº†"))shareBandInvite(docRef.id,name); }catch(e){await showCustomAlert(e.message, "ã‚¨ãƒ©ãƒ¼")}finally{btn.innerText="ä½œæˆã™ã‚‹"; btn.disabled=false;} };
        async function uploadImageToExternal(blob){ const fd=new FormData(); fd.append('files',blob,'image.jpg'); try{ const res=await fetch('https://ul.h3z.jp/uploader-work/work.php',{method:'POST',body:fd}); if(!res.ok)throw new Error(res.status); const json=await res.json(); if(json.files?.[0]?.url)return json.files[0].url; else throw new Error(); }catch(e){throw new Error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—')} }
        window.handleImageSelect=async(inp,pid)=>{ if(inp.files?.[0]){ compressImage(inp.files[0]).then(b=>{tempBandIconBlob=b; const i=document.getElementById(pid); i.src=URL.createObjectURL(b); i.classList.remove('hidden');}).catch(async(e)=>await showCustomAlert(e.message, "ã‚¨ãƒ©ãƒ¼")); } };
        const compressImage=(f)=>{ return new Promise((res,rej)=>{ const i=new Image(); i.src=URL.createObjectURL(f); i.onload=()=>{ const c=document.createElement('canvas'), ctx=c.getContext('2d'), s=200; c.width=s; c.height=s; let w=i.width, h=i.height, sx=0, sy=0; if(w>h){w=h; sx=(i.width-h)/2;} else {h=w; sy=(i.height-w)/2;} ctx.drawImage(i,sx,sy,w,h,0,0,s,s); c.toBlob(b=>b?res(b):rej(),'image/jpeg',0.8); }; i.onerror=rej; }); };
        
        window.shareBandInvite=async(bid,bn)=>{ const invU=`https://liff.line.me/${MY_LIFF_ID}/?bandId=${bid}&action=invite`; if(liff.isApiAvailable('shareTargetPicker')){ try{await liff.shareTargetPicker([{type:"flex",altText:bn+"ã¸ã®æ‹›å¾…",contents:{type:"bubble",body:{type:"box",layout:"vertical",contents:[{type:"text",text:"ğŸ¸ ãƒãƒ³ãƒ‰æ‹›å¾…",weight:"bold",color:"#1DB446",size:"sm"},{type:"text",text:bn,weight:"bold",size:"xl",margin:"md",wrap:true},{type:"text",text:"æ‹›å¾…ã•ã‚Œã¾ã—ãŸã€‚",size:"xs",color:"#aaaaaa",margin:"sm",wrap:true}]},footer:{type:"box",layout:"vertical",spacing:"sm",contents:[{type:"button",style:"primary",height:"sm",color:"#0b57d0",action:{type:"uri",label:"å‚åŠ ã™ã‚‹",uri:invU}}]}}}]);}catch(e){await showCustomAlert("æ‹›å¾…ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");} }else await showCustomAlert("ãŠä½¿ã„ã®ç’°å¢ƒã§ã¯æ‹›å¾…æ©Ÿèƒ½ã‚’åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚"); };
        async function handleInvite(bid){ try{ const snap=await getDoc(doc(db,"bands",bid)); if(!snap.exists())return await showCustomAlert("æ‹›å¾…ã•ã‚ŒãŸãƒãƒ³ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"); const d=snap.data(); if(d.memberIds.includes(currentUser))return await showCustomAlert("æ—¢ã«å‚åŠ ã—ã¦ã„ã‚‹ãƒãƒ³ãƒ‰ã§ã™ã€‚"); if(await showCustomConfirm(`${d.name} ã«å‚åŠ ã—ã¾ã™ã‹ï¼Ÿ`, "ãƒãƒ³ãƒ‰å‚åŠ ")){ await updateDoc(doc(db,"bands",bid),{memberIds:arrayUnion(currentUser),memberNames:arrayUnion(currentProfile.displayName)}); await showCustomAlert(`${d.name} ã«å‚åŠ ã—ã¾ã—ãŸï¼`); } }catch(e){await showCustomAlert(e.message, "ã‚¨ãƒ©ãƒ¼")} }

        window.openBandDetail=async(bid,data)=>{ 
            document.getElementById('detailBandId').value=bid; 
            document.getElementById('detailBandName').value=data.name; 
            document.getElementById('btnInviteInModal').onclick=()=>shareBandInvite(bid,data.name); 
            currentEditingBandId=bid; 
            currentEditingBandMembers=data.memberIds; 
            const dIcon=document.getElementById('detailBandIcon'), dPick=document.getElementById('detailIconPicker'); 
            dIcon.src=data.icon||'https://ul.h3z.jp/Vnukmtvq.jpg'; 
            const isAdmin=currentUserData?.affiliations.includes('urakata')&&currentUserData.role, canE=(data.creatorId===currentUser)||isAdmin; 
            if(canE&&!data.isArchived)dPick.onclick=()=>document.getElementById('editBandIconInput').click(); else dPick.onclick=null; 
            const mList=document.getElementById('detailMemberList'), nInp=document.getElementById('detailBandName'), bArc=document.getElementById('btnArchive'), bRes=document.getElementById('btnRestore'), bAdd=document.getElementById('btnAddMemberToBand'); 
            mList.innerHTML=""; 
            if(data.isArchived){bArc.classList.add('hidden'); bRes.classList.remove('hidden'); nInp.readOnly=true; bAdd.classList.add('hidden');} else {bArc.classList.remove('hidden'); bRes.classList.add('hidden'); if(canE){nInp.readOnly=false; bAdd.classList.remove('hidden');} else bAdd.classList.add('hidden');} 
            if(canE){document.getElementById('bandCreatorActions').classList.remove('hidden'); document.getElementById('bandMemberActions').classList.add('hidden');} else {nInp.readOnly=true; document.getElementById('bandCreatorActions').classList.add('hidden'); document.getElementById('bandMemberActions').classList.remove('hidden');} 
            
            // æ¼”å¥æ›²æƒ…å ±ã®å‡¦ç†
            const songs = data.songs || []; 
            document.getElementById('stat-song-count').innerText = songs.length; 
            
            // ã‚¤ãƒ™ãƒ³ãƒˆIDã®æŠ½å‡ºã¨æ¼”å¥å›æ•°ã®è¨­å®š
            const eventIds = [...new Set(songs.map(s => (typeof s === 'object' && s !== null) ? s.eventId : null).filter(id => id))];
            document.getElementById('stat-booking-count').innerText = eventIds.length;

            const songListEl = document.getElementById('bandSongsList'); 
            songListEl.innerHTML = "";
        
            const eventMap = {};
            if (eventIds.length > 0) { 
                try { 
                    const promises = eventIds.map(eid => getDoc(doc(db, 'events', eid))); 
                    const snapshots = await Promise.all(promises); 
                    snapshots.forEach(snap => { 
                        if (snap.exists()) { 
                            eventMap[snap.id] = { name: snap.data().event || snap.data().name || "ã‚¤ãƒ™ãƒ³ãƒˆ", date: snap.data().startDate || "0000-00-00" }; 
                        } 
                    }); 
                } catch (e) { console.error("Error fetching events for songs:", e); } 
            }
            
            if(songs.length === 0){ songListEl.innerHTML = '<div style="padding: 12px 16px; color: #999; font-size: 12px;">ç™»éŒ²ã•ã‚ŒãŸæ›²ã¯ã‚ã‚Šã¾ã›ã‚“</div>'; } else {
                const sortedSongs = songs.map(s => { const isObj = (typeof s === 'object' && s !== null); const title = isObj && s.title ? s.title : s; const eid = isObj ? s.eventId : null; const eventInfo = eid && eventMap[eid] ? eventMap[eid] : { name: "", date: "0000-00-00" }; return { original: s, title: title, eventId: eid, eventName: eventInfo.name, date: eventInfo.date }; }).sort((a, b) => { if (a.date < b.date) return 1; if (a.date > b.date) return -1; return 0; });
                sortedSongs.forEach((songData, index) => { const row = document.createElement('div'); row.className = 'member-row-rich'; if (index >= 5) { row.classList.add('hidden', 'song-overflow-item'); } const safeTitle = songData.title.replace(/'/g, "\\'"); const delBtn = canE ? `<button class="btn-remove-member" style="margin-left:auto;" onclick="removeSongFromBand('${safeTitle}')">å‰Šé™¤</button>` : ''; let htmlContent = `<div class="member-info-rich"><div class="member-name-rich">${songData.title}</div>`; if (songData.eventName) { htmlContent += `<div style="font-size:10px; color:#666; margin-top:2px;"><span class="material-icons" style="font-size:10px; vertical-align:middle; margin-right:2px;">event</span>${songData.eventName}</div>`; } htmlContent += `</div>`; row.innerHTML = `<span class="material-icons" style="color:#0b57d0; font-size:16px; margin-right:12px; background:#e8f0fe; padding:6px; border-radius:50%;">music_note</span>${htmlContent}${delBtn}`; songListEl.appendChild(row); });
                if (sortedSongs.length > 5) { const moreBtn = document.createElement('div'); moreBtn.id = 'btnShowMoreSongs'; moreBtn.style.cssText = 'text-align:center; padding:10px; cursor:pointer; color:#0b57d0; font-size:12px; border-top:1px dashed #eee;'; moreBtn.innerHTML = `<span class="material-icons" style="font-size:14px; vertical-align:middle;">expand_more</span> ã‚‚ã£ã¨è¦‹ã‚‹ (${sortedSongs.length - 5}ä»¶)`; moreBtn.onclick = function() { document.querySelectorAll('.song-overflow-item').forEach(el => el.classList.remove('hidden')); this.remove(); }; songListEl.appendChild(moreBtn); }
            }
            if(canE){ document.getElementById('bandSongAddArea').classList.remove('hidden'); document.getElementById('inputNewSong').value = ""; } else { document.getElementById('bandSongAddArea').classList.add('hidden'); }
            data.memberIds.forEach((uid)=>{ const u = allUsersCache.find(x => x.id === uid) || { name: 'ä¸æ˜', icon: 'https://ul.h3z.jp/Vnukmtvq.jpg' }; const row=document.createElement('div'); row.className='member-row-rich'; let roleBadge = (uid===data.creatorId) ? '<span class="member-role-badge">ãƒªãƒ¼ãƒ€ãƒ¼</span>' : ''; let deleteBtn = (canE && uid !== currentUser) ? `<button class="btn-remove-member" style="margin-left:auto;" onclick="removeMember('${bid}','${uid}','${u.name}')">å‰Šé™¤</button>` : ''; row.innerHTML=`<img src="${u.icon}" class="member-avatar-small"><div class="member-info-rich"><div class="member-name-rich">${u.name}${roleBadge}</div><div style="font-size:10px; color:#999;">${u.part?getPartLabel(u.part):''}</div></div>${deleteBtn}`; mList.appendChild(row); }); 
            
            document.getElementById('adminBandBookingsArea').classList.remove('hidden'); 
            loadBandBookings(bid); 
            
            openModal('modal-band-detail'); 
        };
        
        async function loadBandBookings(bid){ const list=document.getElementById('adminBandBookingsList'); if(!list)return; list.innerHTML="èª­ã¿è¾¼ã¿ä¸­..."; try{ const q=query(collection(db,"bookings"),where("bandId","==",bid)), qs=await getDocs(q); if(qs.empty){list.innerHTML="<div style='padding:12px 16px; color:#999; font-size:12px;'>ãªã—</div>";return;} const bks=[]; qs.forEach(doc=>bks.push(doc.data())); bks.sort((a,b)=>b.startTime.toDate()-a.startTime.toDate()); let h=""; bks.forEach(bk=>{ const d=bk.startTime.toDate(), dStr=`${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`, sL=(bk.status==='confirmed')?`<span class="booking-status" style="background:#e6f4ea; color:#0d652d;">ç¢ºå®š</span>`:`<span class="booking-status" style="background:#fff8e1; color:#b06000;">æ‰¿èªå¾…ã¡</span>`; h+=`<div class="booking-history-item"><div class="booking-date">${dStr}</div><div>${bk.type==='event'?'(ã‚¤ãƒ™ãƒ³ãƒˆ)':''} ${sL}</div></div>`; }); list.innerHTML=h; }catch(e){list.innerHTML=e.message} }
        window.addSongToBand = async () => { const songName = document.getElementById('inputNewSong').value.trim(); if(!songName) return; const bid = document.getElementById('detailBandId').value; try { await updateDoc(doc(db, "bands", bid), { songs: arrayUnion({ title: songName }) }); const snap = await getDoc(doc(db, "bands", bid)); openBandDetail(bid, {id: bid, ...snap.data()}); } catch(e) { await showCustomAlert("è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message, "ã‚¨ãƒ©ãƒ¼"); } };
        window.removeSongFromBand = async (songName) => { if(!await showCustomConfirm(`ã€Œ${songName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`, "å‰Šé™¤ç¢ºèª")) return; const bid = document.getElementById('detailBandId').value; try { const snap = await getDoc(doc(db, "bands", bid)); if(snap.exists()) { const currentSongs = snap.data().songs || []; const newSongs = currentSongs.filter(s => { const t = (typeof s === 'object' && s !== null && s.title) ? s.title : s; return t !== songName; }); await updateDoc(doc(db, "bands", bid), { songs: newSongs }); openBandDetail(bid, {id: bid, ...snap.data(), songs: newSongs}); } } catch(e) { await showCustomAlert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message, "ã‚¨ãƒ©ãƒ¼"); } };
        window.updateBandName=async()=>{ const bid=document.getElementById('detailBandId').value, nn=document.getElementById('detailBandName').value.trim(); if(!nn)return; try{await updateDoc(doc(db,"bands",bid),{name:nn}); await showCustomAlert("ãƒãƒ³ãƒ‰åã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚"); closeModal('modal-band-detail');}catch(e){await showCustomAlert(e.message, "ã‚¨ãƒ©ãƒ¼")} };
        window.archiveBand=async()=>{ const bid=document.getElementById('detailBandId').value; if(await showCustomConfirm("ã“ã®ãƒãƒ³ãƒ‰ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã¸ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ", "ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã®ç¢ºèª")){try{await updateDoc(doc(db,"bands",bid),{isArchived:true}); await showCustomAlert("ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã¸ç§»å‹•ã—ã¾ã—ãŸã€‚"); closeModal('modal-band-detail');}catch(e){await showCustomAlert(e.message, "ã‚¨ãƒ©ãƒ¼")}} };
        window.restoreBand=async()=>{ const bid=document.getElementById('detailBandId').value; if(await showCustomConfirm("ã“ã®ãƒãƒ³ãƒ‰ã‚’æ´»å‹•ä¸­ã«å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ", "å¾©å…ƒã®ç¢ºèª")){try{await updateDoc(doc(db,"bands",bid),{isArchived:false}); await showCustomAlert("æ´»å‹•ä¸­ã«å¾©å…ƒã—ã¾ã—ãŸã€‚"); closeModal('modal-band-detail');}catch(e){await showCustomAlert(e.message, "ã‚¨ãƒ©ãƒ¼")}} };
        window.deleteBand=async()=>{ const bid=document.getElementById('detailBandId').value; if(await showCustomConfirm("ã“ã®ãƒãƒ³ãƒ‰ã‚’è§£æ•£ï¼ˆå‰Šé™¤ï¼‰ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚", "è§£æ•£ã®ç¢ºèª")){try{await deleteDoc(doc(db,"bands",bid)); await showCustomAlert("ãƒãƒ³ãƒ‰ã‚’è§£æ•£ã—ã¾ã—ãŸã€‚"); closeModal('modal-band-detail');}catch(e){await showCustomAlert(e.message, "ã‚¨ãƒ©ãƒ¼")}} };
        window.leaveBand=async()=>{ const bid=document.getElementById('detailBandId').value; if(await showCustomConfirm("ã“ã®ãƒãƒ³ãƒ‰ã‹ã‚‰è„±é€€ã—ã¾ã™ã‹ï¼Ÿ", "è„±é€€ã®ç¢ºèª")){try{await updateDoc(doc(db,"bands",bid),{memberIds:arrayRemove(currentUser),memberNames:arrayRemove(currentProfile.displayName)}); await showCustomAlert("ãƒãƒ³ãƒ‰ã‹ã‚‰è„±é€€ã—ã¾ã—ãŸã€‚"); closeModal('modal-band-detail');}catch(e){await showCustomAlert(e.message, "ã‚¨ãƒ©ãƒ¼")}} };
        window.removeMember=async(bid,uid,n)=>{ if(await showCustomConfirm(`${n} ã•ã‚“ã‚’ãƒãƒ³ãƒ‰ãƒ¡ãƒ³ãƒãƒ¼ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`, "ãƒ¡ãƒ³ãƒãƒ¼å‰Šé™¤")){try{await updateDoc(doc(db,"bands",bid),{memberIds:arrayRemove(uid),memberNames:arrayRemove(n)}); await showCustomAlert("ãƒ¡ãƒ³ãƒãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚"); closeModal('modal-band-detail');}catch(e){await showCustomAlert(e.message, "ã‚¨ãƒ©ãƒ¼")}} };
        window.handleImageEdit=async(inp)=>{ if(inp.files?.[0] && await showCustomConfirm("ãƒãƒ³ãƒ‰ã‚¢ã‚¤ã‚³ãƒ³ã‚’å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ", "ã‚¢ã‚¤ã‚³ãƒ³å¤‰æ›´")){ const dIcon=document.getElementById('detailBandIcon'), old=dIcon.src; dIcon.style.opacity="0.5"; try{ const b=await compressImage(inp.files[0]), bid=document.getElementById('detailBandId').value, u=await uploadImageToExternal(b); await updateDoc(doc(db,"bands",bid),{icon:u}); dIcon.src=u; await showCustomAlert("ã‚¢ã‚¤ã‚³ãƒ³ã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚"); }catch(e){dIcon.src=old; await showCustomAlert(e.message, "ã‚¨ãƒ©ãƒ¼");}finally{dIcon.style.opacity="1";} } };
        window.openAddMemberModal=async()=>{ document.getElementById('addMemberSelectList').innerHTML="ä¸­..."; loadUserList('addMemberSelectList',currentEditingBandMembers); openModal('modal-add-member'); };
        window.saveAddedMembers=async()=>{ const sel=document.querySelectorAll('#addMemberSelectList .member-option.selected'); if(sel.length===0)return; const ids=[], nms=[]; sel.forEach(el=>{ids.push(el.dataset.uid); nms.push(el.dataset.uname);}); try{await updateDoc(doc(db,"bands",currentEditingBandId),{memberIds:arrayUnion(...ids),memberNames:arrayUnion(...nms)}); await showCustomAlert("ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚"); closeModal('modal-add-member'); closeModal('modal-band-detail');}catch(e){await showCustomAlert(e.message, "ã‚¨ãƒ©ãƒ¼")} };

        main();
    </script>
</body>
</html>
