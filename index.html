<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LMC Mobile</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script><script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; font-family: 'Roboto', 'Noto Sans JP', sans-serif; background-color: rgb(241, 244, 249); color: #1f1f1f; min-height: 100vh; padding-bottom: 88px; overscroll-behavior-y: none; user-select: none; -webkit-user-select: none; }
        .container { max-width: 480px; margin: 0 auto; height: 100%; display: flex; flex-direction: column; } .hidden { display: none !important; }
        .app-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: rgb(241, 244, 249); flex-shrink: 0; z-index: 500; }
        .header-title { font-size: 22px; font-weight: bold; color: #1f1f1f; display: flex; align-items: center; gap: 8px; }
        .header-avatar { width: 36px; height: 36px; border-radius: 50%; display: flex; justify-content: center; align-items: center; background: #dadce0; cursor: pointer; position: relative; }
        .header-avatar img { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid white; z-index: 2; }
        .ring-sound { background: #1a73e8; box-shadow: 0 0 5px rgba(26,115,232,0.5); } .ring-light { background: #fa7b17; box-shadow: 0 0 5px rgba(250,123,23,0.5); }
        .ring-stage { background: #34A853; box-shadow: 0 0 5px rgba(52,168,83,0.5); } .ring-video { background: #EA4335; box-shadow: 0 0 5px rgba(234,67,53,0.5); }
        .ring-rainbow { background: linear-gradient(135deg, #EA4335, #FBBC05, #34A853, #4285F4); animation: spin 4s linear infinite; }
        .ring-birthday { background: linear-gradient(45deg, #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000); background-size: 400%; animation: birthday-glow 3s linear infinite; box-shadow: 0 0 8px rgba(255, 215, 0, 0.8); }
        @keyframes spin { 100% { transform: rotate(360deg); } } @keyframes birthday-glow { 0% { background-position: 0 0; } 50% { background-position: 400% 0; } 100% { background-position: 0 0; } }
        .screen { display: none; flex-direction: column; height: 100%; width: 100%; } .screen.active { display: flex; }
        .scroll-content { flex-grow: 1; overflow-y: auto; padding: 16px; padding-bottom: 100px; -webkit-overflow-scrolling: touch; }
        .calendar-controls { display: flex; justify-content: space-between; align-items: center; background: white; padding: 12px 16px; border-radius: 12px; margin: 0 16px 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); flex-shrink: 0; z-index: 400; }
        .view-switcher { display: flex; position: relative; background: #f1f3f4; border-radius: 20px; padding: 2px; width: 90px; height: 32px; }
        .switcher-item { flex: 1; z-index: 2; font-size: 13px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: color 0.3s; color: #5f6368; }
        .switcher-item.active { color: #0b57d0; }
        .switcher-slide { position: absolute; width: 44px; height: 28px; background: white; border-radius: 18px; top: 2px; left: 2px; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 1px 3px rgba(0,0,0,0.1); z-index: 1; }
        .view-switcher.day-mode .switcher-slide { transform: translateX(42px); }
        .month-grid { background: white; border-radius: 12px; padding: 10px; display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; margin-bottom: 20px; }
        .weekday-label { font-size: 11px; color: #5f6368; padding-bottom: 8px; font-weight: bold; }
        .weekday-label.sun { color: #d93025; } .weekday-label.sat { color: #1a73e8; }
        .day-cell { height: 54px; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 4px; cursor: pointer; border: 1px solid transparent; transition: all 0.2s; background-color: #fafafa; }
        .day-num { font-size: 13px; width: 24px; height: 24px; line-height: 24px; border-radius: 50%; z-index: 2; margin-bottom: 2px; } 
        .day-cell.today { background-color: #e8f0fe; } .day-cell.today .day-num { background: #0b57d0; color: white; font-weight: bold; }
        .day-cell.other-month { opacity: 0.15; cursor: default; pointer-events: none; } 
        .day-cell.unavailable { background-color: #fff1f0; border-color: #ffccc7; } 
        .day-cell.unavailable .day-num { color: #cf1322; }
        .status-label { font-size: 8px; color: #cf1322; font-weight: bold; height: 12px; transform: scale(0.9); }
        .event-dots { display: flex; gap: 2px; margin-top: 2px; justify-content: center; min-height: 5px; } 
        .dot { width: 4px; height: 4px; border-radius: 50%; background: #34A853; } .dot.event { background: #137333; transform: scale(1.2); }
        .timeline-container { background: white; border-radius: 12px; padding: 10px 0; position: relative; height: auto; min-height: 600px; }
        .time-slot { height: 60px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: flex-start; position: relative; }
        .time-label { width: 50px; font-size: 12px; color: #5f6368; text-align: center; transform: translateY(-8px); }
        .time-content { flex-grow: 1; height: 100%; position: relative; border-left: 1px solid #f0f0f0; touch-action: pan-y; } .time-content.selecting { background-color: rgba(11, 87, 208, 0.2); }
        .event-block { position: absolute; left: 0; width: 100%; background: #e8f0fe; border-left: 4px solid #0b57d0; border-radius: 4px; padding: 4px 8px; font-size: 12px; color: #0b57d0; overflow: hidden; cursor: pointer; z-index: 10; box-shadow: 0 1px 2px rgba(0,0,0,0.1); box-sizing: border-box; }
        .event-title { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; } .event-block.special-event { background: #e6f4ea; border-left: 4px solid #137333; color: #0d652d; }
        .event-block.pending { opacity: 0.9; background: #fff8e1; border-left: 4px solid #ffb300; color: #b06000; border: 1px dashed #ffb300; border-left-style: solid; }
        .event-block.lottery-confirmed { background: #f3e5f5; border-left: 4px solid #ab47bc; color: #4a148c; }
        .event-block.cluster { background: #5f6368; color: white; border-left: 4px solid #3c4043; display: flex; justify-content: center; align-items: center; z-index: 25; } .event-block.cluster .event-title { white-space: normal; text-align: center; font-size: 13px; }
        .card { background: white; border-radius: 16px; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); margin-bottom: 12px; transition: background-color 0.2s; } .card.band-card:active { background-color: #f5f5f5; }
        .band-item { display: flex; align-items: center; border-bottom: 1px solid #f0f0f0; padding-bottom: 12px; margin-bottom: 12px; } .band-item:last-child { border: none; margin: 0; padding: 0; }
        .band-icon { width: 48px; height: 48px; background: #e0e3e7; border-radius: 12px; display: flex; justify-content: center; align-items: center; margin-right: 12px; font-size: 20px; color: #5f6368; font-weight: bold; overflow: hidden; } .band-icon img { width: 100%; height: 100%; object-fit: cover; }
        .band-info { flex-grow: 1; } .band-name { font-weight: bold; font-size: 16px; } .band-members { font-size: 12px; color: #5f6368; }
        .band-tabs { display: flex; background: white; border-radius: 12px; padding: 4px; margin: 0 16px 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); flex-shrink: 0; } .band-tab { flex: 1; text-align: center; padding: 10px; font-size: 14px; font-weight: bold; border-radius: 8px; cursor: pointer; color: #5f6368; } .band-tab.active { background: #e8f0fe; color: #0b57d0; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #ffffff; border-top: 1px solid #e0e3e7; display: flex; justify-content: space-around; padding: 12px 0 28px; z-index: 2000; box-shadow: 0 -1px 3px rgba(0,0,0,0.05); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #444746; font-size: 12px; width: 72px; cursor: pointer; gap: 4px; font-weight: 500; }
        .nav-icon { font-size: 24px; padding: 4px 20px; border-radius: 16px; transition: background-color 0.2s ease-in-out, color 0.2s; } .nav-item.active .nav-icon { background-color: #c2e7ff; color: #001d35; } .nav-item#nav-admin.active .nav-icon { background-color: #ffd8e4; color: #31111d; } .nav-item.active span { color: #1f1f1f; font-weight: bold; }
        .fab { position: fixed; bottom: 100px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background: #c2e7ff; color: #001d35; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; z-index: 900; }
        .btn-primary { background: #0b57d0; color: white; border: none; padding: 12px 20px; border-radius: 24px; width: 100%; font-weight: bold; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .btn-secondary { background: #f1f3f4; color: #1f1f1f; border: none; padding: 12px 20px; border-radius: 24px; width: 100%; margin-top: 8px; cursor: pointer; font-weight: bold; }
        .btn-danger { background: #fee2e2; color: #d93025; border: none; padding: 12px 20px; border-radius: 24px; width: 100%; margin-top: 8px; cursor: pointer; font-weight: bold; }
        .btn-outline { background: white; color: #0b57d0; border: 1px solid #dadce0; padding: 6px 12px; border-radius: 16px; font-size: 12px; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; margin-left: auto; }
        .btn-google { background: #fff; color: #3c4043; border: 1px solid #dadce0; padding: 10px; border-radius: 20px; font-weight: bold; width: 100%; margin-top: 16px; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-add-member { margin-top: 10px; width: 100%; padding: 10px; border: 1px dashed #0b57d0; background: #e8f0fe; color: #0b57d0; border-radius: 8px; font-size: 14px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .image-picker-area { display: flex; justify-content: center; margin-bottom: 20px; } .image-picker { width: 80px; height: 80px; background: #f1f3f4; border-radius: 16px; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #0b57d0; cursor: pointer; overflow: hidden; position: relative; }
        .image-picker img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; } .image-picker i { font-size: 24px; z-index: 1; } .image-picker span { font-size: 10px; z-index: 1; margin-top: 4px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; display: none; justify-content: center; align-items: flex-end; } .modal-overlay.open { display: flex; }
        .modal-content { background: white; width: 100%; max-width: 480px; border-radius: 24px 24px 0 0; padding: 24px; box-sizing: border-box; max-height: 85vh; overflow-y: auto; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .form-group { margin-bottom: 16px; } .form-label { display: block; font-size: 12px; color: #5f6368; margin-bottom: 4px; font-weight: bold; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #dadce0; border-radius: 8px; box-sizing: border-box; font-size: 16px; background: white; }
        .member-select-list { max-height: 200px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; } .member-option { padding: 10px; display: flex; align-items: center; border-bottom: 1px solid #eee; cursor: pointer; }
        .member-option.selected { background: #e8f0fe; } .member-check { margin-right: 10px; color: #0b57d0; }
        #selectionToast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 30px; z-index: 3500; font-size: 14px; pointer-events: none; opacity: 0; transition: opacity 0.2s; } #selectionToast.show { opacity: 1; }
        .radio-group { display: flex; gap: 15px; } .radio-label { display: flex; align-items: center; font-size: 16px; cursor: pointer; } .radio-label input { width: 20px; height: 20px; margin-right: 6px; }
        .checkbox-label { display: flex; align-items: center; font-size: 15px; font-weight: bold; color: #0b57d0; cursor: pointer; } .checkbox-label input { width: 20px; height: 20px; margin-right: 8px; }
        .member-list-edit { margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; } .member-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
        .btn-remove-member { font-size: 11px; color: #d93025; border: 1px solid #d93025; background: white; border-radius: 4px; padding: 2px 8px; cursor: pointer; }
        .menu-list { display: flex; flex-direction: column; gap: 12px; }
        .menu-btn { display: flex; align-items: center; justify-content: space-between; padding: 16px; background: #ffffff; border: none; width: 100%; text-align: left; cursor: pointer; border-radius: 24px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: transform 0.1s; } .menu-btn:active { transform: scale(0.98); background-color: #f8f9fa; }
        .menu-icon-wrapper { width: 48px; height: 48px; border-radius: 50%; display: flex; justify-content: center; align-items: center; margin-right: 16px; flex-shrink: 0; } .menu-icon-wrapper .material-icons { font-size: 24px; }
        .menu-content { flex-grow: 1; } .menu-title { font-size: 16px; font-weight: 500; color: #1f1f1f; display: block; margin-bottom: 4px; } .menu-subtitle { font-size: 12px; color: #444746; display: block; line-height: 1.4; }
        .menu-arrow { color: #c4c7c5; font-size: 24px; }
        .icon-admin-cal { background-color: #fce4ec; color: #c2185b; } .icon-admin-user { background-color: #e8eaf6; color: #283593; } .icon-admin-doc { background-color: #e0f2f1; color: #00695c; } .icon-admin-band { background-color: #f3e5f5; color: #7b1fa2; } .icon-admin-fee { background-color: #fff8e1; color: #f57f17; }
        .page-container { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgb(241, 244, 249); z-index: 2500; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.2, 0, 0, 1); overflow-y: auto; max-width: 480px; margin: 0 auto; } .page-container.open { transform: translateX(0); }
        .page-header { padding: 12px 16px; display: flex; align-items: center; background: rgb(241, 244, 249); position: sticky; top: 0; z-index: 10; }
        .back-btn { background: none; border: none; cursor: pointer; width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: #1f1f1f; margin-right: 8px; margin-left: -8px; }
        .page-title { font-size: 20px; font-weight: 400; color: #1f1f1f; } .content-area { padding: 0 16px 40px; }
        .search-bar { padding: 12px 16px; background:white; border-radius:30px; display:flex; align-items:center; margin-bottom:12px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); } .search-bar input { border:none; width:100%; outline:none; font-size:16px; margin-left:10px; padding:0; }
        .user-list-item { background: white; padding: 16px; border-radius: 16px; display: flex; align-items: center; margin-bottom: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); cursor: pointer; }
        .mini-icon { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 12px; background: #eee; }
        .user-info-main { flex-grow: 1; } .user-name { font-size: 16px; font-weight: bold; color: #1f1f1f; } .user-sub { font-size: 12px; color: #5f6368; }
        .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0; } .info-row .label { color: #5f6368; font-size: 13px; } .info-row .value { color: #1f1f1f; font-weight: 500; font-size: 15px; }
        .btn-admin-save { background: #c2185b; color: white; border: none; padding: 15px; border-radius: 12px; width: 100%; font-weight: bold; cursor: pointer; }
        .lottery-log-box { background: #2b2b2b; color: #fff; padding: 10px; border-radius: 8px; font-family: monospace; font-size: 11px; max-height: 200px; overflow-y: auto; margin-top: 10px; } .log-line { margin-bottom: 4px; border-bottom: 1px solid #444; padding-bottom: 2px; } .log-success { color: #8bc34a; } .log-warn { color: #ffeb3b; } .log-error { color: #f44336; }
        .booking-list-item { padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 13px; } .status-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 6px; } .status-confirmed { background: #e6f4ea; color: #0d652d; } .status-pending { background: #fff8e1; color: #b06000; }
        .fee-user-item { background: white; padding: 12px; border-radius: 12px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 1px 2px rgba(0,0,0,0.05); } .fee-check-group { display: flex; gap: 8px; } .fee-checkbox { display: flex; flex-direction: column; align-items: center; cursor: pointer; border: 1px solid #ddd; border-radius: 8px; padding: 8px; width: 60px; transition: all 0.2s; } .fee-checkbox.checked { background-color: #e8f5e9; border-color: #4caf50; color: #2e7d32; } .fee-checkbox input { display: none; } .fee-label { font-size: 10px; font-weight: bold; margin-bottom: 4px; } .fee-status-icon { font-size: 20px; color: #ddd; } .fee-checkbox.checked .fee-status-icon { color: #4caf50; }
        #video-container { width: 100%; border-radius: 12px; overflow: hidden; background: #000; position: relative; display: none; aspect-ratio: 1 / 1; } #camera-video { width: 100%; height: 100%; object-fit: cover; } #qr-canvas { display: none; }
        #scan-result-area { margin-top: 10px; padding: 10px; background: white; border-radius: 12px; display: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1); } .scan-success-msg { color: #2e7d32; font-weight: bold; text-align: center; } .overlay-guide { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 40px solid rgba(0,0,0,0.5); box-sizing: border-box; pointer-events: none; }
        .user-status-card { text-align: center; padding: 20px; } .user-status-icon { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; border: 4px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); } .user-status-name { font-size: 18px; font-weight: bold; margin-bottom: 20px; } .fee-status-row { display: flex; gap: 10px; justify-content: center; margin-top: 10px; } .fee-status-badge { flex: 1; padding: 10px; border-radius: 8px; font-size: 14px; font-weight: bold; } .fee-paid { background-color: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; } .fee-unpaid { background-color: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
        .band-name-input:focus { outline: none; border-bottom: 2px solid #0b57d0; background: rgba(255,255,255,0.5); }
        .member-row-rich { display: flex; align-items: center; padding: 12px 16px; border-bottom: 1px solid #f0f0f0; } .member-row-rich:last-child { border-bottom: none; }
        .member-avatar-small { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; margin-right: 12px; background: #eee; }
        .member-info-rich { flex-grow: 1; } .member-name-rich { font-size: 14px; font-weight: bold; color: #1f1f1f; }
        .member-role-badge { font-size: 10px; background: #e8f0fe; color: #0b57d0; padding: 2px 8px; border-radius: 10px; margin-left: 6px; }
        .booking-history-item { padding: 12px 16px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; justify-content: space-between; } .booking-history-item:last-child { border-bottom: none; }
        .booking-date { font-weight: bold; font-size: 14px; color: #1f1f1f; } .booking-status { font-size: 11px; padding: 2px 8px; border-radius: 4px; }
        /* Band Detail Instagram Style */
        .stat-badge { background: #f8f9fa; padding: 6px 12px; border-radius: 12px; display: flex; flex-direction: column; align-items: center; border: 1px solid #eee; flex: 1; }
        .stat-value { font-size: 15px; font-weight: bold; color: #0b57d0; }
        .stat-label { font-size: 9px; color: #5f6368; font-weight: bold; }
    </style>
</head>
<body>
    <div id="selectionToast">なぞって時間を選択...</div>
    <div id="screen-bands" class="screen active">
        <div class="app-header"><div class="header-title">マイバンド <span style="font-size:12px; font-weight:normal; background:#e8f0fe; color:#0b57d0; padding:4px 8px; border-radius:12px;">2025年度</span></div><div class="header-avatar" id="headerIconBands"></div></div>
        <div class="band-tabs"><div class="band-tab active" onclick="switchBandTab('active')">活動中</div><div class="band-tab" onclick="switchBandTab('archived')">アーカイブ</div></div>
        <div class="scroll-content"><div id="bandListContainer"><div style="text-align:center; color:#999; margin-top:40px;">読み込み中...</div></div></div>
        <div class="fab" onclick="openBandModal()"><span class="material-icons">add</span></div>
    </div>
    <div id="screen-calendar" class="screen">
        <div class="app-header"><div class="header-title">合わせ予約</div><div class="header-avatar" id="headerIconCal"></div></div>
        <div class="calendar-controls">
            <div class="view-switcher" id="viewSwitcher">
                <div class="switcher-slide"></div>
                <div class="switcher-item active" data-mode="month" onclick="switchCalendarView('month')">月</div>
                <div class="switcher-item" data-mode="day" onclick="switchCalendarView('day')">日</div>
            </div>
            <div style="display:flex; align-items:center;"><span class="material-icons" style="cursor:pointer; padding:5px;" onclick="changeDate(-1)">chevron_left</span><div class="date-display" id="calHeaderDate" style="margin:0 10px; font-size:16px;"></div><span class="material-icons" style="cursor:pointer; padding:5px;" onclick="changeDate(1)">chevron_right</span></div>
        </div>
        <div class="scroll-content"><div id="calMonthView"><div class="month-grid" id="monthGrid"></div></div><div id="calDayView" class="hidden"><div style="text-align:center; margin-bottom:10px; font-weight:bold; color:#0b57d0;" id="dayViewDateLabel"></div><div id="bookingModeBanner" style="margin:0 10px 10px; padding:10px; border-radius:8px; font-size:13px; text-align:center; line-height:1.4;"></div><div style="font-size:12px; color:#999; text-align:center; margin-bottom:5px;">空き時間を長押し＆なぞって予約 / 予約をタップして編集</div><div class="timeline-container" id="timeline"></div></div></div>
    </div>
    <div id="screen-cuesheet" class="screen">
        <div class="app-header"><div class="header-title">Cueシート</div><div class="header-avatar" id="headerIconCue"></div></div>
        <div class="scroll-content"><div id="cuesheetBandListContainer"><div style="padding: 10px 4px; font-size: 12px; color: #5f6368;">閲覧するバンドを選択</div><div id="cuesheetBandList"></div></div><div id="cuesheetDetailView" class="hidden"><div style="margin-bottom: 16px; display: flex; align-items: center; background: white; padding: 10px; border-radius: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);"><button onclick="closeCuesheetDetail()" style="background:#f1f3f4; border:none; padding:8px; border-radius:50%; margin-right:12px; cursor:pointer; display:flex; align-items:center; justify-content:center;"><span class="material-icons" style="font-size:20px; color:#5f6368;">arrow_back</span></button><div><div style="font-size:10px; color:#5f6368;">Selected Band</div><div id="cuesheetTargetBandName" style="font-weight:bold; font-size:16px;">Band Name</div></div></div><div id="cuesheetContainer" style="display:flex; flex-direction:column; align-items:center; min-height: 100%;"><div id="cuesheetLoading" style="margin-top:50px; color:#5f6368; display:none;">読み込み中...</div><div id="cuesheetContent" class="hidden" style="width:100%; box-sizing:border-box;"><img id="cuesheetImage" src="" referrerpolicy="no-referrer" style="width:100%; height:auto; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1);" onclick="window.open(this.src, '_blank')"><div style="margin-top:10px; font-size:12px; color:#999; text-align:center;">タップで拡大表示</div></div><div id="cuesheetEmpty" class="hidden" style="margin-top:50px; text-align:center; color:#5f6368;"><span class="material-icons" style="font-size:48px; margin-bottom:10px; color:#e0e0e0;">image_not_supported</span><br>Cueシートはまだありません</div><div id="cuesheetDebug" style="margin-top:20px; padding:10px; font-size:10px; color:#999; width:90%; word-break:break-all; border-top:1px dashed #eee;"></div></div></div></div>
    </div>
    <div id="screen-admin" class="screen">
        <div class="app-header"><div class="header-title">データの管理</div><div class="header-avatar" id="headerIconAdmin"></div></div>
        <div class="scroll-content"><div class="menu-list"><button class="menu-btn" onclick="openAdminFeesMenu()"><div class="menu-icon-wrapper icon-admin-fee"><span class="material-icons">attach_money</span></div><div class="menu-content"><span class="menu-title">部費の管理</span><span class="menu-subtitle">金額設定、徴収状況の管理</span></div><span class="material-icons menu-arrow">chevron_right</span></button><button class="menu-btn" onclick="openAdminSettings()"><div class="menu-icon-wrapper icon-admin-cal"><span class="material-icons">edit_calendar</span></div><div class="menu-content"><span class="menu-title">予約システム管理</span><span class="menu-subtitle">予約設定、先着/抽選の切り替えなど</span></div><span class="material-icons menu-arrow">chevron_right</span></button><button class="menu-btn" onclick="openAdminUsers()"><div class="menu-icon-wrapper icon-admin-user"><span class="material-icons">manage_accounts</span></div><div class="menu-content"><span class="menu-title">個人の管理</span><span class="menu-subtitle">ユーザー情報の閲覧、役職の変更</span></div><span class="material-icons menu-arrow">chevron_right</span></button><button class="menu-btn" onclick="openAdminBands()"><div class="menu-icon-wrapper icon-admin-band"><span class="material-icons">groups</span></div><div class="menu-content"><span class="menu-title">バンドの管理</span><span class="menu-subtitle">全バンドの編集、合わせ状況の確認</span></div><span class="material-icons menu-arrow">chevron_right</span></button><button class="menu-btn" onclick="openPage('admin-docs-stub')"><div class="menu-icon-wrapper icon-admin-doc"><span class="material-icons">description</span></div><div class="menu-content"><span class="menu-title">提出書類の作成</span><span class="menu-subtitle">各種申請書類のエクスポート</span></div><span class="material-icons menu-arrow">chevron_right</span></button></div></div>
    </div>
    <div class="bottom-nav"><div class="nav-item active" onclick="switchScreen('bands', this)"><span class="material-icons nav-icon">groups</span><span>マイバンド</span></div><div class="nav-item" onclick="switchScreen('calendar', this)"><span class="material-icons nav-icon">calendar_month</span><span>合わせ予約</span></div><div class="nav-item" onclick="switchScreen('cuesheet', this)"><span class="material-icons nav-icon">description</span><span>Cueシート</span></div><div class="nav-item hidden" id="nav-admin" onclick="switchScreen('admin', this)"><span class="material-icons nav-icon">admin_panel_settings</span><span>管理</span></div><div class="nav-item" onclick="goToMyPage()"><span class="material-icons nav-icon">account_circle</span><span>マイページ</span></div></div>
    <div id="page-admin-fees-menu" class="page-container"><div class="page-header"><button class="back-btn" onclick="closePage('admin-fees-menu')"><span class="material-icons">arrow_back</span></button><div class="page-title">部費の管理</div></div><div class="content-area"><div class="menu-list"><button class="menu-btn" onclick="openAdminFeeSettings()"><div class="menu-icon-wrapper" style="background:#f3e5f5; color:#7b1fa2;"><span class="material-icons">settings</span></div><div class="menu-content"><span class="menu-title">部費の設定</span><span class="menu-subtitle">前期・後期の金額設定</span></div><span class="material-icons menu-arrow">chevron_right</span></button><button class="menu-btn" onclick="openAdminFeeList()"><div class="menu-icon-wrapper" style="background:#e8eaf6; color:#283593;"><span class="material-icons">list_alt</span></div><div class="menu-content"><span class="menu-title">部費の徴収リスト</span><span class="menu-subtitle">徴収状況の確認・更新</span></div><span class="material-icons menu-arrow">chevron_right</span></button><button class="menu-btn" onclick="openAdminFeeHistory()"><div class="menu-icon-wrapper" style="background:#e0f2f1; color:#00695c;"><span class="material-icons">qr_code_scanner</span></div><div class="menu-content"><span class="menu-title">QRで徴収する</span><span class="menu-subtitle">QRスキャンで徴収記録をつける</span></div><span class="material-icons menu-arrow">chevron_right</span></button></div></div></div>
    <div id="page-admin-fees-settings" class="page-container"><div class="page-header"><button class="back-btn" onclick="closePage('admin-fees-settings')"><span class="material-icons">arrow_back</span></button><div class="page-title">部費の設定</div></div><div class="content-area" style="padding-top:20px;"><div class="card" style="background: linear-gradient(135deg, #6366F1, #8B5CF6); color: white; padding: 20px; text-align: center; margin-bottom: 20px; border: none; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);"><div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;"><span id="feeSummaryYearLabel" style="font-weight:bold; font-size:15px; margin-right:4px;">--</span>年度 徴収合計</div><div style="font-size: 32px; font-weight: bold; margin-bottom: 16px;">¥ <span id="feeTotalAmount">0</span></div><div style="display: flex; justify-content: space-around; align-items: center;"><div class="pie-chart" id="feeProgressChart" style="width: 80px; height: 80px; border-radius: 50%; background: conic(rgba(255,255,255,0.8) 0% 0%, rgba(255,255,255,0.2) 0% 100%); position: relative; display: flex; justify-content: center; align-items: center;"><div style="width: 64px; height: 64px; background: #7C5DF3; border-radius: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 10px;"><span>徴収率</span><span id="feeProgressPercent" style="font-size: 14px; font-weight: bold;">0%</span></div></div><div style="text-align: left; font-size: 13px;"><div style="margin-bottom: 6px;">前期: <span id="feeTotalTerm1" style="font-weight:bold;">¥0</span> <span id="feeCountTerm1" style="font-size:10px; opacity:0.8;">(0人)</span></div><div>後期: <span id="feeTotalTerm2" style="font-weight:bold;">¥0</span> <span id="feeCountTerm2" style="font-size:10px; opacity:0.8;">(0人)</span></div></div></div></div><div class="card"><div class="form-group"><label class="form-label">対象年度</label><input type="number" id="feeSettingYear" class="form-input" placeholder="例: 2025"></div><div class="form-group"><label class="form-label">前期の部費 (円)</label><input type="number" id="feeSettingTerm1" class="form-input" placeholder="0"></div><div class="form-group"><label class="form-label">後期の部費 (円)</label><input type="number" id="feeSettingTerm2" class="form-input" placeholder="0"></div><button class="btn-primary" onclick="saveFeeSettings()">設定を保存</button></div></div></div>
    <div id="page-admin-fees-list" class="page-container"><div class="page-header"><button class="back-btn" onclick="closePage('admin-fees-list')"><span class="material-icons">arrow_back</span></button><div class="page-title">徴収リスト</div></div><div class="content-area"><div style="background:#fff3e0; padding:10px; border-radius:8px; margin-bottom:15px; font-size:12px; color:#e65100;"><span id="feeListYearLabel" style="font-weight:bold;">2025</span>年度の徴収状況</div><div class="search-bar"><span class="material-icons" style="color:#5f6368;">search</span><input type="text" id="feeListSearchInput" placeholder="名前で検索..."></div><div id="feeUserList">読み込み中...</div></div></div>
    <div id="page-admin-fees-history" class="page-container"><div class="page-header"><button class="back-btn" onclick="closePage('admin-fees-history'); stopQRScanner();"><span class="material-icons">arrow_back</span></button><div class="page-title">QR徴収</div></div><div class="content-area"><div class="card" style="margin-top:16px;"><div class="form-group"><label class="form-label">徴収する部費の対象</label><div style="display:flex; gap:10px;"><select id="scanFeeYear" class="form-input" style="flex:1;"></select><select id="scanFeeTerm" class="form-input" style="flex:1;"><option value="1">前期</option><option value="2">後期</option></select></div></div><div id="video-container"><video id="camera-video" playsinline></video><div class="overlay-guide"></div></div><canvas id="qr-canvas"></canvas><div id="scan-result-area"><div class="scan-success-msg"><span class="material-icons" style="font-size:48px;">check_circle</span><br><span id="scannedUserName">ユーザー名</span><br>徴収完了！</div></div><div id="scan-start-btn-area" style="text-align:center; padding:20px;"><button class="btn-primary" onclick="startQRScanner()"><span class="material-icons" style="vertical-align:middle; margin-right:4px;">photo_camera</span>カメラを起動する</button><div style="margin-top:10px; font-size:12px; color:#666;">部員の会員QRコード（LINE ID）をスキャンしてください</div></div></div></div></div>
    <div id="page-admin-users" class="page-container"><div class="page-header"><button class="back-btn" onclick="closePage('admin-users')"><span class="material-icons">arrow_back</span></button><div class="page-title">個人の管理</div></div><div class="content-area"><div class="search-bar"><span class="material-icons" style="color:#5f6368;">search</span><input type="text" id="adminSearchInput" placeholder="ユーザー検索..."></div><div style="display:flex; gap:8px; margin-bottom:16px;"><button class="btn-outline" onclick="sortUsers('year')"><span class="material-icons" style="font-size:14px;">sort</span> 学年順</button><button class="btn-outline" onclick="sortUsers('kana')"><span class="material-icons" style="font-size:14px;">sort_by_alpha</span> 五十音順</button></div><div id="adminUserList"></div></div></div>
    <div id="page-admin-bands" class="page-container"><div class="page-header"><button class="back-btn" onclick="closePage('admin-bands')"><span class="material-icons">arrow_back</span></button><div class="page-title">バンドの管理</div></div><div class="content-area"><div class="search-bar"><span class="material-icons" style="color:#5f6368;">search</span><input type="text" id="adminBandSearchInput" placeholder="バンド名検索..."></div><div id="adminBandList"></div></div></div>
    <div id="page-admin-calendar-stub" class="page-container"><div class="page-header"><button class="back-btn" onclick="closePage('admin-calendar-stub')"><span class="material-icons">arrow_back</span></button><div class="page-title">予約システム管理</div></div><div class="content-area" style="padding-top: 20px;"><div class="card"><h3 style="font-size:16px; margin:0 0 16px; color:#0b57d0; display:flex; align-items:center;"><span class="material-icons" style="margin-right:8px;">tune</span>現在の予約モード</h3><div class="form-group"><div class="radio-group" style="flex-direction: column; gap: 16px;"><label class="radio-label" style="background:#f8f9fa; padding:12px; border-radius:12px; border:1px solid #eee;"><input type="radio" name="adminBookingMode" value="first_come" checked onchange="toggleLotterySettings()"><div><div style="font-weight:bold;">早い者勝ち (即時確定)</div><div style="font-size:11px; color:#5f6368; margin-top:4px;">予約を入れるとすぐに確定します。<br>時間が被る予約はできません。</div></div></label><label class="radio-label" style="background:#f8f9fa; padding:12px; border-radius:12px; border:1px solid #eee;"><input type="radio" name="adminBookingMode" value="lottery" onchange="toggleLotterySettings()"><div><div style="font-weight:bold;">抽選式 (希望提出)</div><div style="font-size:11px; color:#5f6368; margin-top:4px;">ユーザーは「希望」を提出します。<br>時間が被っていても提出でき、管理者が後で確定させます。</div></div></label></div></div><div id="lotterySettingsArea" class="hidden" style="margin-top:20px; border-top:1px solid #eee; padding-top:20px;"><h3 style="font-size:14px; margin:0 0 12px; color:#0b57d0;">抽選実行設定</h3><div class="form-group"><label class="form-label">実行タイミング</label><div class="radio-group" style="flex-direction: column; gap: 10px;"><label class="radio-label"><input type="radio" name="lotteryExecMode" value="auto" checked onchange="toggleLotteryExecUI()">自動 (指定日時に実行)</label><div id="lotteryAutoConfig" style="padding-left: 28px; margin-bottom: 10px;"><select id="lotteryAutoDays" class="form-input" style="width:auto; display:inline-block; padding:8px;"><option value="1">1日前</option><option value="2" selected>2日前</option><option value="3">3日前</option><option value="7">7日前</option></select> の <select id="lotteryAutoTime" class="form-input" style="width:auto; display:inline-block; padding:8px;"><option value="0">0:00</option><option value="9">9:00</option><option value="12">12:00</option><option value="18">18:00</option><option value="21">21:00</option></select> に確定</div><label class="radio-label"><input type="radio" name="lotteryExecMode" value="manual" onchange="toggleLotteryExecUI()">手動 (管理者がボタンで実行)</label><div id="lotteryManualConfig" class="hidden" style="padding-left: 28px; background:#fff3e0; padding:10px; border-radius:8px;"><div style="font-size:12px; margin-bottom:8px;">対象日を選んで実行します</div><input type="date" id="manualLotteryDate" class="form-input"><button class="btn-primary" style="margin-top:8px; background:#e65100;" onclick="runManualLottery()">今すぐ抽選を実行</button><div id="lotteryLog" class="lottery-log-box hidden"></div><button id="btnApplyLottery" class="btn-primary hidden" style="margin-top:8px;" onclick="applyLotteryResults()">この結果で確定する</button></div></div></div></div><button class="btn-primary" style="margin-top:20px;" onclick="saveSystemSettings()">設定を保存</button></div><div style="margin-top:20px; font-size:12px; color:#5f6368; padding:0 10px;">※ 設定を変更すると部員全員のアプリの挙動が切り替わります。</div></div></div>
    <div id="page-admin-docs-stub" class="page-container"><div class="page-header"><button class="back-btn" onclick="closePage('admin-docs-stub')"><span class="material-icons">arrow_back</span></button><div class="page-title">提出書類の作成</div></div><div class="content-area" style="text-align:center; padding-top:50px; color:#5f6368;"><span class="material-icons" style="font-size:48px; margin-bottom:10px;">print</span><br>準備中: 書類PDF出力機能</div></div>
    <div id="page-admin-edit" class="page-container"><div class="page-header"><button class="back-btn" onclick="closePage('admin-edit')"><span class="material-icons">arrow_back</span></button><div class="page-title">ユーザー詳細</div></div><div class="content-area"><div style="text-align:center; margin-bottom:20px;"><img id="admin-user-icon" src="" style="width:80px; height:80px; border-radius:50%; object-fit:cover; background:#eee;"><div id="admin-user-lineName" style="font-size:12px; color:#999; margin-top:8px;"></div></div><div class="card" style="padding:20px;"><h3 style="font-size:14px; margin:0 0 12px; color:#0b57d0;">基本情報</h3><div class="info-row"><span class="label">氏名</span><span id="admin-show-name" class="value"></span></div><div class="info-row"><span class="label">ふりがな</span><span id="admin-show-kana" class="value"></span></div><div class="info-row"><span class="label">学籍番号</span><span id="admin-show-studentId" class="value"></span></div><div class="info-row"><span class="label">学年</span><span id="admin-show-year" class="value"></span></div><div class="info-row"><span class="label">所属</span><span id="admin-show-aff" class="value"></span></div><div class="info-row"><span class="label">パート</span><span id="admin-show-part" class="value"></span></div></div><div class="card" style="padding:20px;"><h3 style="font-size:14px; margin:0 0 12px; color:#0b57d0;">権限設定</h3><div class="form-group"><label class="form-label">役職</label><input type="text" id="admin-edit-role" class="form-input" placeholder="部長, 会計 など"></div><button id="btn-save-user-role" class="btn-admin-save">役職を保存</button></div><div class="card" style="padding:20px;"><h3 style="font-size:14px; margin:0 0 12px; color:#0b57d0;">所属バンド</h3><div id="admin-user-band-list" style="font-size:14px;">読み込み中...</div></div><div style="font-size:10px; color:#999; text-align:center; margin-top:20px;">USER ID: <span id="admin-edit-docId"></span></div></div></div>
    <div id="modal-band" class="modal-overlay" onclick="if(event.target===this) closeModal('modal-band')"><div class="modal-content"><h3 style="margin-top:0;">バンド結成</h3><p style="font-size:12px; color:#5f6368; margin-bottom:20px;">リストから選ぶか、後から招待リンクを送ってください。</p><div class="image-picker-area"><div class="image-picker" onclick="document.getElementById('bandIconInput').click()"><i class="material-icons">add_a_photo</i><span>写真</span><img id="previewBandIcon" class="hidden" src=""></div><input type="file" id="bandIconInput" accept="image/*" hidden onchange="handleImageSelect(this, 'previewBandIcon')"></div><div class="form-group"><label class="form-label">バンド名</label><input type="text" id="inputBandName" class="form-input" placeholder="例: 放課後ティータイム"></div><div class="form-group"><label class="form-label">メンバーを検索</label><input type="text" id="bandMemberSearchInput" class="form-input" placeholder="氏名またはかなで検索..."></div><div class="form-group"><label class="form-label">メンバー選択 (登録済みユーザー)</label><div class="member-select-list" id="userSelectList"></div></div><button class="btn-primary" onclick="saveBand()">作成する</button><button class="btn-secondary" onclick="closeModal('modal-band')">キャンセル</button></div></div>
    <div id="modal-band-detail" class="modal-overlay" onclick="if(event.target===this) closeModal('modal-band-detail')">
        <div class="modal-content" style="padding: 0; overflow: hidden; display: flex; flex-direction: column; max-height: 90vh;">
            <div class="band-detail-header" style="background: white; padding: 24px 20px; border-bottom: 1px solid #f0f0f0; position: relative;">
                <button onclick="closeModal('modal-band-detail')" style="position: absolute; top: 16px; left: 16px; background: rgba(0,0,0,0.05); border: none; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10;"><span class="material-icons" style="font-size: 20px; color: #5f6368;">close</span></button>
                
                <div style="display: flex; align-items: flex-start; gap: 20px; margin-top: 20px;">
                    <!-- Left: Avatar (Strictly Square container for Round image) -->
                    <div class="image-picker-area" style="position: relative; width: 88px; height: 88px; flex-shrink: 0; overflow: visible; margin: 0;">
                        <div class="image-picker" id="detailIconPicker" style="width: 88px; height: 88px; border-radius: 50%; border: 1px solid #eee; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow: visible; position: relative; background: #fafafa; padding: 0;">
                            <img id="detailBandIcon" src="" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%; display: block; aspect-ratio: 1/1;">
                            <div class="edit-badge" style="position: absolute; bottom: 0; right: 0; background: #0b57d0; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 20; transform: translate(15%, 15%);">
                                <span class="material-icons" style="font-size: 16px;">edit</span>
                            </div>
                        </div>
                        <input type="file" id="editBandIconInput" accept="image/*" hidden onchange="handleImageEdit(this)">
                    </div>

                    <!-- Right: Info -->
                    <div style="flex-grow: 1; padding-top: 4px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; gap: 8px;">
                            <div style="position: relative; flex-grow: 1; min-width: 0;">
                                <input type="text" id="detailBandName" class="band-name-input" value="バンド名" readonly style="font-size: 18px; font-weight: bold; border: none; background: transparent; width: 100%; color: #1f1f1f; padding: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            </div>
                            <button class="btn-outline" id="btnInviteInModal" style="border-radius: 12px; border: 1px solid #dadce0; padding: 4px 10px; font-size: 11px; font-weight: bold; color: #1f1f1f; background: white; white-space: nowrap; flex-shrink: 0;"><span class="material-icons" style="font-size: 14px; margin-right: 4px;">share</span>招待</button>
                        </div>
                        
                        <div style="display: flex; gap: 8px;">
                            <div class="stat-badge">
                                <span class="stat-value" id="stat-booking-count">--</span>
                                <span class="stat-label">演奏回数</span>
                            </div>
                            <div class="stat-badge">
                                <span class="stat-value" id="stat-song-count">--</span>
                                <span class="stat-label">演奏曲数</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="padding: 20px; overflow-y: auto; flex-grow: 1; background: #fafafa;">
                <input type="hidden" id="detailBandId">
                
                <!-- Members Section -->
                <div class="section-title" style="font-size: 13px; font-weight: bold; color: #5f6368; margin-bottom: 10px; display: flex; align-items: center;">
                    <span class="material-icons" style="font-size: 16px; margin-right: 6px;">groups</span>メンバー
                </div>
                <div class="card" style="padding: 0; overflow: hidden; margin-bottom: 24px;">
                    <div class="member-list-edit" id="detailMemberList" style="border: none; padding: 0; margin: 0;"></div>
                    <button id="btnAddMemberToBand" class="btn-flat" onclick="openAddMemberModal()" style="width: 100%; padding: 12px; text-align: center; color: #0b57d0; font-weight: bold; border: none; background: white; border-top: 1px solid #f0f0f0; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                        <span class="material-icons" style="font-size: 18px; margin-right: 6px;">person_add</span>メンバーを追加
                    </button>
                </div>

                <!-- Upcoming Rehearsals Section -->
                <div id="adminBandBookingsArea">
                    <div class="section-title" style="font-size: 13px; font-weight: bold; color: #5f6368; margin-bottom: 10px; display: flex; align-items: center;">
                        <span class="material-icons" style="font-size: 16px; margin-right: 6px;">calendar_today</span>直近のあわせ
                    </div>
                    <div class="card" style="padding: 0; overflow: hidden; margin-bottom: 24px; min-height: 40px;">
                        <div id="adminBandBookingsList" style="max-height: 150px; overflow-y: auto;"></div>
                    </div>
                </div>

                <!-- Performance Records Section (Dummy) -->
                <div class="section-title" style="font-size: 13px; font-weight: bold; color: #5f6368; margin-bottom: 10px; display: flex; align-items: center;">
                    <span class="material-icons" style="font-size: 16px; margin-right: 6px;">mic_external_on</span>演奏記録(仮)
                </div>
                <div class="card" style="padding: 0; overflow: hidden; margin-bottom: 24px;">
                    <div id="performanceRecordsList">
                        <div class="booking-history-item">
                            <div class="booking-date">2024/12/20</div>
                            <div style="font-size: 13px; color: #1f1f1f;">冬の定期演奏会 <span style="font-size: 10px; color: #999;">@大ホール</span></div>
                        </div>
                        <div class="booking-history-item" style="opacity: 0.6;">
                            <div class="booking-date">----/--/--</div>
                            <div style="font-size: 13px; color: #999;">データなし</div>
                        </div>
                    </div>
                </div>

                <!-- Actions Section -->
                <div id="bandCreatorActions" class="hidden" style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="btn-secondary" onclick="updateBandName()" style="background: #f1f3f4; color: #1f1f1f; border: none;">名前を保存</button>
                    <div style="display: flex; gap: 10px;">
                        <button id="btnArchive" class="btn-secondary" onclick="archiveBand()" style="flex: 1; background: #fff8e1; color: #f57f17; margin: 0;">アーカイブ</button>
                        <button id="btnRestore" class="btn-secondary hidden" onclick="restoreBand()" style="flex: 1; background: #fff8e1; color: #f57f17; margin: 0;">復元</button>
                        <button class="btn-danger" onclick="deleteBand()" style="flex: 1; margin: 0;">解散</button>
                    </div>
                </div>
                <div id="bandMemberActions" class="hidden">
                    <button class="btn-danger" onclick="leaveBand()" style="width: 100%;">脱退する</button>
                </div>
            </div>
        </div>
    </div>
    <div id="modal-add-member" class="modal-overlay" onclick="if(event.target===this) closeModal('modal-add-member')"><div class="modal-content"><h3 style="margin-top:0;">メンバーを追加</h3><p style="font-size:12px; color:#5f6368; margin-bottom:20px;">追加したいメンバーを選択してください。</p><div class="form-group"><div class="member-select-list" id="addMemberSelectList"></div></div><button class="btn-primary" onclick="saveAddedMembers()">追加する</button><button class="btn-secondary" onclick="closeModal('modal-add-member')">キャンセル</button></div></div>
    <div id="modal-booking" class="modal-overlay" onclick="if(event.target===this) closeModal('modal-booking')"><div class="modal-content"><h3 style="margin-top:0;" id="bookingModalTitle">予約の確認</h3><input type="hidden" id="editingBookingId"><div class="form-group"><label class="form-label">日付</label><div style="font-weight:bold; font-size:16px; margin-bottom:10px;" id="bookingDateDisplay"></div></div><div class="form-group"><label class="checkbox-label"><input type="checkbox" id="checkAllDay" onchange="toggleAllDay()"> 終日 (9:00 - 20:00)</label></div><div class="form-group" id="timeSelectArea" style="display:flex; gap:10px; align-items:center;"><div style="flex:1;"><label class="form-label">開始</label><select id="selectStartTime" class="form-input"></select></div><span>〜</span><div style="flex:1;"><label class="form-label">終了</label><select id="selectEndTime" class="form-input"></select></div></div><div id="bookingTypeSelector" class="form-group hidden" style="background:#f8f9fa; padding:10px; border-radius:8px;"><label class="form-label">登録種別</label><div class="radio-group"><label class="radio-label"><input type="radio" name="bookingType" value="normal" checked onchange="toggleBookingInputs()"> バンド練習</label><label class="radio-label" style="color:#137333; font-weight:bold;"><input type="radio" name="bookingType" value="event" onchange="toggleBookingInputs()"> イベント・不可日</label></div></div><div id="groupBandSelect" class="form-group"><label class="form-label">予約するバンド</label><select id="selectBookingBand" class="form-input"></select></div><div id="groupEventTitle" class="form-group hidden"><label class="form-label">イベント名 / 理由</label><input type="text" id="inputEventTitle" class="form-input" placeholder="例: 定期演奏会"></div><button id="btnSaveBooking" class="btn-primary" onclick="saveBooking()">予約を確定する</button><button id="btnAddToGCal" class="btn-google hidden" onclick="addToGoogleCalendar()"><span class="material-icons" style="color:#34A853;">calendar_today</span> Googleカレンダーに追加</button><button id="btnDeleteBooking" class="btn-danger hidden" onclick="deleteBooking()">この予約を削除</button><button class="btn-secondary" onclick="closeModal('modal-booking')">キャンセル</button></div></div>
    <div id="modal-user-status" class="modal-overlay" onclick="if(event.target===this) closeModal('modal-user-status')"><div class="modal-content"><h3 style="margin-top:0; text-align:center; font-size:16px; color:#5f6368;">マイステータス</h3><div class="user-status-card"><img id="modalUserIcon" src="" class="user-status-icon"><div id="modalUserName" class="user-status-name"></div><div style="background:#f9f9f9; padding:15px; border-radius:12px;"><div id="statusFeeYear" style="font-size:12px; color:#666; margin-bottom:10px; font-weight:bold;">2025年度 部費</div><div class="fee-status-row"><div id="statusFeeTerm1" class="fee-status-badge">前期: -</div><div id="statusFeeTerm2" class="fee-status-badge">後期: -</div></div></div><div style="margin-top:20px;"><div style="font-size:12px; color:#999; margin-bottom:5px;">会員QRコード</div><div id="myQRCodeArea" style="width:150px; height:150px; background:#eee; margin:0 auto; display:flex; align-items:center; justify-content:center;"><span class="material-icons" style="font-size:48px; color:#ccc;">qr_code_2</span></div></div></div><button class="btn-secondary" onclick="closeModal('modal-user-status')">閉じる</button></div></div>
    <div id="modal-event-list" class="modal-overlay" onclick="if(event.target===this) closeModal('modal-event-list')"><div class="modal-content"><h3 style="margin-top:0;">予約一覧</h3><p style="font-size:12px; color:#5f6368; margin-bottom:20px;">詳細を確認・編集したい予約をタップしてください。</p><div id="eventListContainer" style="max-height: 400px; overflow-y: auto;"></div><button class="btn-secondary" onclick="closeModal('modal-event-list')">閉じる</button></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, setDoc, updateDoc, deleteDoc, query, where, orderBy, onSnapshot, Timestamp, arrayUnion, arrayRemove, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        const firebaseConfig = { apiKey: "AIzaSyAWtITnn5uMOPBgOY0Bd7Rt5IN1ry8XoJI", authDomain: "urakata-app.firebaseapp.com", projectId: "urakata-app", storageBucket: "urakata-app.firebasestorage.app", messagingSenderId: "407777765696", appId: "1:407777765696:web:045c2d94729022b4eab2a5", measurementId: "G-9ZRMD26XNJ" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app);
        const MY_LIFF_ID = "2008162165-vVODNp12"; const MY_PAGE_URL = "https://liff.line.me/2008162165-znd24peg";
        let currentUser=null, currentProfile=null, currentUserData=null, displayDate=new Date(), selectedTimeSlot=null, selectionStartHour=null, selectionEndHour=null;
        let myBandsAll=[], currentBandTab='active', calendarMode='month', isSelecting=false, selectionTimer=null, editingBookingData=null;
        let currentEditingBandId=null, currentEditingBandMembers=[], tempBandIconBlob=null, allUsersCache=[], adminEditingUserId=null, allBandsCache=[], tempLotterySchedule=null;
        let currentSystemSettings={ bookingMode:'first_come', lotteryConfig:{ mode:'auto', daysBefore:2, time:0 } };
        let currentFeeSettings={ year:new Date().getFullYear(), term1_amount:0, term2_amount:0 };
        function getNameById(uid){ const u=allUsersCache.find(x=>x.id===uid); return u?u.name:"不明"; }
        window.openUserStatusModal=async()=>{ if(!currentUserData)return; if(!currentFeeSettings.year){ try{ const snap=await getDoc(doc(db,"system","fees")); if(snap.exists())currentFeeSettings=snap.data(); else currentFeeSettings={year:new Date().getFullYear(),term1_amount:0,term2_amount:0}; }catch(e){console.error(e)} } const year=currentFeeSettings.year||new Date().getFullYear(); const status=currentUserData.feeStatus||{}; document.getElementById('modalUserIcon').src=currentUserData.icon||'https://ul.h3z.jp/Vnukmtvq.jpg'; document.getElementById('modalUserName').innerText=currentUserData.name+" さん"; const isPaid1=!!status[`${year}_1`], isPaid2=!!status[`${year}_2`], t1Text=isPaid1?'済':'未納', t2Text=isPaid2?'済':'未納', t1El=document.getElementById('statusFeeTerm1'), t2El=document.getElementById('statusFeeTerm2'); t1El.innerText=`前期: ${t1Text}`; t1El.className=`fee-status-badge ${isPaid1?'fee-paid':'fee-unpaid'}`; t2El.innerText=`後期: ${t2Text}`; t2El.className=`fee-status-badge ${isPaid2?'fee-paid':'fee-unpaid'}`; document.getElementById('statusFeeYear').innerText=`${year}年度 部費状況`; if(currentUser){ const qrUrl=`https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${currentUser}`; document.getElementById('myQRCodeArea').innerHTML=`<img src="${qrUrl}" style="width:100%;height:100%;">`; } openModal('modal-user-status'); };
        window.openAdminFeesMenu=()=>openPage('admin-fees-menu');
        window.openAdminFeeHistory=async()=>{ openPage('admin-fees-history'); const yearSelect=document.getElementById('scanFeeYear'); yearSelect.innerHTML=""; const currentYear=new Date().getFullYear(); [currentYear-1,currentYear,currentYear+1].forEach(y=>{ const op=document.createElement('option'); op.value=y; op.text=`${y}年度`; if(y===currentYear)op.selected=true; yearSelect.appendChild(op); }); await refreshAllUsersCache(); };
        window.openAdminFeeSettings=async()=>{ openPage('admin-fees-settings'); try{ const docSnap=await getDoc(doc(db,"system","fees")); if(docSnap.exists())currentFeeSettings=docSnap.data(); else currentFeeSettings={year:new Date().getFullYear(),term1_amount:0,term2_amount:0}; document.getElementById('feeSettingYear').value=currentFeeSettings.year; document.getElementById('feeSettingTerm1').value=currentFeeSettings.term1_amount; document.getElementById('feeSettingTerm2').value=currentFeeSettings.term2_amount; loadFeeSummary(); }catch(e){console.error(e)} };
        async function refreshAllUsersCache(){ const qs=await getDocs(collection(db,"users")); allUsersCache=[]; qs.forEach(doc=>allUsersCache.push({id:doc.id,...doc.data()})); }
        async function loadFeeSummary(){ if(allUsersCache.length===0)await refreshAllUsersCache(); const year=currentFeeSettings.year||new Date().getFullYear(); const yearLabel=document.getElementById('feeSummaryYearLabel'); if(yearLabel)yearLabel.innerText=year; const t1=parseInt(currentFeeSettings.term1_amount)||0, t2=parseInt(currentFeeSettings.term2_amount)||0, k1=`${year}_1`, k2=`${year}_2`; let count1=0, count2=0, totalUsers=allUsersCache.length; allUsersCache.forEach(u=>{ if(u.feeStatus){ if(u.feeStatus[k1])count1++; if(u.feeStatus[k2])count2++; } }); const sum1=count1*t1, sum2=count2*t2, total=sum1+sum2; let maxTotal=0; if(t1>0)maxTotal+=totalUsers*t1; if(t2>0)maxTotal+=totalUsers*t2; let percent=(maxTotal>0)?Math.round((total/maxTotal)*100):0; document.getElementById('feeTotalAmount').innerText=total.toLocaleString(); document.getElementById('feeTotalTerm1').innerText='¥'+sum1.toLocaleString(); document.getElementById('feeCountTerm1').innerText=`(${count1}/${totalUsers}人)`; document.getElementById('feeTotalTerm2').innerText='¥'+sum2.toLocaleString(); document.getElementById('feeCountTerm2').innerText=`(${count2}/${totalUsers}人)`; document.getElementById('feeProgressPercent').innerText=`${percent}%`; document.getElementById('feeProgressChart').style.background=`conic-gradient(rgba(255,255,255,0.9) 0% ${percent}%, rgba(255,255,255,0.2) ${percent}% 100%)`; }
        window.saveFeeSettings=async()=>{ const year=parseInt(document.getElementById('feeSettingYear').value), t1=parseInt(document.getElementById('feeSettingTerm1').value), t2=parseInt(document.getElementById('feeSettingTerm2').value); if(!year)return alert("年度を入力してください"); try{ await setDoc(doc(db,"system","fees"),{year:year,term1_amount:t1||0,term2_amount:t2||0,updatedAt:serverTimestamp()},{merge:true}); currentFeeSettings={year,term1_amount:t1,term2_amount:t2}; alert("保存しました"); loadFeeSummary(); }catch(e){alert("保存エラー: "+e.message)} };
        window.openAdminFeeList=async()=>{ openPage('admin-fees-list'); document.getElementById('feeUserList').innerHTML="読み込み中..."; await getDoc(doc(db,"system","fees")).then(snap=>{if(snap.exists())currentFeeSettings=snap.data()}); document.getElementById('feeListYearLabel').innerText=currentFeeSettings.year||new Date().getFullYear(); loadFeeUserList(); };
        async function loadFeeUserList(){ const container=document.getElementById('feeUserList'); container.innerHTML="ユーザー取得中..."; try{ const q=query(collection(db,"users"),orderBy("studentId","asc")); const qs=await getDocs(q); allUsersCache=[]; qs.forEach(doc=>allUsersCache.push({id:doc.id,...doc.data()})); renderFeeUserList(allUsersCache); }catch(e){container.innerHTML="エラー: "+e.message} }
        function renderFeeUserList(users){ const container=document.getElementById('feeUserList'); container.innerHTML=""; if(users.length===0){container.innerHTML='<div style="padding:20px; text-align:center;">ユーザーがいません</div>'; return;} const targetYear=currentFeeSettings.year||new Date().getFullYear(), k1=`${targetYear}_1`, k2=`${targetYear}_2`; users.forEach(u=>{ const status=u.feeStatus||{}, div=document.createElement('div'); div.className='fee-user-item'; div.innerHTML=`<div><div style="font-weight:bold;">${u.name}</div><div style="font-size:11px; color:#888;">${u.studentId||'-'} ${u.part?'('+getPartLabel(u.part)+')':''}</div></div><div class="fee-check-group"><div class="fee-checkbox ${status[k1]?'checked':''}" onclick="toggleFeeStatus('${u.id}','${k1}',this)"><div class="fee-label">前期</div><div class="fee-label" style="font-weight:normal;">¥${currentFeeSettings.term1_amount||0}</div><span class="material-icons fee-status-icon">check_circle</span></div><div class="fee-checkbox ${status[k2]?'checked':''}" onclick="toggleFeeStatus('${u.id}','${k2}',this)"><div class="fee-label">後期</div><div class="fee-label" style="font-weight:normal;">¥${currentFeeSettings.term2_amount||0}</div><span class="material-icons fee-status-icon">check_circle</span></div></div>`; container.appendChild(div); }); }
        document.getElementById('feeListSearchInput')?.addEventListener('input',(e)=>{ const term=e.target.value.trim(); renderFeeUserList(term?allUsersCache.filter(u=>u.name.includes(term)||(u.kana&&u.kana.includes(term))):allUsersCache); });
        window.toggleFeeStatus=async(uid,key,element)=>{ const isChecked=element.classList.contains('checked'); if(isChecked)element.classList.remove('checked'); else element.classList.add('checked'); const newVal=!isChecked; try{ const updateData={}; updateData[`feeStatus.${key}`]=newVal; await updateDoc(doc(db,"users",uid),updateData); const user=allUsersCache.find(u=>u.id===uid); if(user){ if(!user.feeStatus)user.feeStatus={}; user.feeStatus[key]=newVal; } }catch(e){console.error(e); alert("更新失敗: "+e.message); if(isChecked)element.classList.add('checked'); else element.classList.remove('checked'); } };
        let videoStream=null, isScanning=false, scanLock=false;
        window.startQRScanner=async()=>{ const video=document.getElementById('camera-video'), resultArea=document.getElementById('scan-result-area'), btnArea=document.getElementById('scan-start-btn-area'); document.getElementById('video-container').style.display='block'; btnArea.style.display='none'; resultArea.style.display='none'; try{ videoStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}); video.srcObject=videoStream; video.setAttribute("playsinline",true); video.play(); isScanning=true; requestAnimationFrame(scanLoop); }catch(e){alert("カメラ起動失敗: "+e.message); window.stopQRScanner();} };
        window.stopQRScanner=()=>{ isScanning=false; if(videoStream){videoStream.getTracks().forEach(t=>t.stop()); videoStream=null;} document.getElementById('video-container').style.display='none'; document.getElementById('scan-start-btn-area').style.display='block'; document.getElementById('scan-result-area').style.display='none'; };
        function scanLoop(){ if(!isScanning)return; const video=document.getElementById('camera-video'), canvasElement=document.getElementById('qr-canvas'), canvas=canvasElement.getContext('2d'); if(video.readyState===video.HAVE_ENOUGH_DATA){ canvasElement.height=video.videoHeight; canvasElement.width=video.videoWidth; canvas.drawImage(video,0,0,canvasElement.width,canvasElement.height); const code=jsQR(canvas.getImageData(0,0,canvasElement.width,canvasElement.height).data,canvasElement.width,canvasElement.height,{inversionAttempts:"dontInvert"}); if(code&&!scanLock)handleScanSuccess(code.data); } requestAnimationFrame(scanLoop); }
        async function handleScanSuccess(data){ scanLock=true; const userId=data, targetUser=allUsersCache.find(u=>u.id===userId), resultArea=document.getElementById('scan-result-area'), nameSpan=document.getElementById('scannedUserName'); resultArea.style.display='block'; if(targetUser){ nameSpan.innerText=targetUser.name; nameSpan.style.color='#1f1f1f'; const year=document.getElementById('scanFeeYear').value, term=document.getElementById('scanFeeTerm').value, key=`${year}_${term}`; try{ const updateData={}; updateData[`feeStatus.${key}`]=true; await updateDoc(doc(db,"users",userId),updateData); if(!targetUser.feeStatus)targetUser.feeStatus={}; targetUser.feeStatus[key]=true; if(navigator.vibrate)navigator.vibrate([100,50,100]); }catch(e){alert("更新エラー: "+e.message)} }else{ nameSpan.innerText="未登録 ("+userId.substring(0,6)+"...)"; nameSpan.style.color='red'; if(navigator.vibrate)navigator.vibrate(500); } setTimeout(()=>{scanLock=false; resultArea.style.display='none';},2000); }
        window.openAdminSettings=async()=>{ openPage('admin-calendar-stub'); try{ const docSnap=await getDoc(doc(db,"system","settings")); if(docSnap.exists())currentSystemSettings=docSnap.data(); const mode=currentSystemSettings.bookingMode||'first_come'; document.getElementsByName('adminBookingMode').forEach(r=>{if(r.value===mode)r.checked=true}); if(currentSystemSettings.lotteryConfig){ const lc=currentSystemSettings.lotteryConfig; document.getElementsByName('lotteryExecMode').forEach(r=>{if(r.value===(lc.mode||'auto'))r.checked=true}); document.getElementById('lotteryAutoDays').value=lc.daysBefore||2; document.getElementById('lotteryAutoTime').value=lc.time||0; } toggleLotterySettings(); }catch(e){console.error(e)} };
        window.toggleLotterySettings=()=>{ const isL=document.querySelector('input[name="adminBookingMode"][value="lottery"]').checked, area=document.getElementById('lotterySettingsArea'); if(isL){area.classList.remove('hidden'); toggleLotteryExecUI();} else area.classList.add('hidden'); };
        window.toggleLotteryExecUI=()=>{ const mode=document.querySelector('input[name="lotteryExecMode"]:checked').value, autoC=document.getElementById('lotteryAutoConfig'), manuC=document.getElementById('lotteryManualConfig'); if(mode==='auto'){autoC.classList.remove('hidden'); manuC.classList.add('hidden');} else {autoC.classList.add('hidden'); manuC.classList.remove('hidden');} };
        window.runManualLottery=async()=>{ const dVal=document.getElementById('manualLotteryDate').value; if(!dVal)return alert("日付を選択"); if(!confirm(dVal+" の抽選を実行？"))return; const logB=document.getElementById('lotteryLog'); logB.innerHTML='<div class="log-line">データ取得中...</div>'; logB.classList.remove('hidden'); document.getElementById('btnApplyLottery').classList.add('hidden'); const targetD=new Date(dVal), startD=new Date(targetD), endD=new Date(targetD); startD.setHours(0,0,0,0); endD.setHours(23,59,59,999); try{ const q=query(collection(db,"bookings"),where("startTime",">=",startD),where("startTime","<=",endD)); const snapshot=await getDocs(q); let candidates=[], locked=[]; snapshot.forEach(doc=>{ const d=doc.data(); if(d.status==='pending'&&d.type!=='event')candidates.push({id:doc.id,...d}); else if(d.status==='confirmed'||d.type==='event')locked.push({start:d.startTime.toDate(),end:d.endTime.toDate(),title:d.bandName||d.title}); }); if(candidates.length===0){logB.innerHTML+='<div class="log-line log-warn">候補なし</div>'; return;} const bandReqs={}; candidates.forEach(c=>{ if(!bandReqs[c.bandId])bandReqs[c.bandId]={id:c.bandId,name:c.bandName,requests:[],docIds:[]}; bandReqs[c.bandId].requests.push({start:c.startTime.toDate(),end:c.endTime.toDate()}); bandReqs[c.bandId].docIds.push(c.id); }); const bands=Object.values(bandReqs); logB.innerHTML+=`<div class="log-line">候補:${candidates.length} エントリー:${bands.length}</div>`; let schedule=attemptSchedule(bands,60,locked); if(schedule.successCount<bands.length)schedule=attemptSchedule(bands,30,locked); else schedule=extendSchedule(schedule,bands,90); logB.innerHTML+='<div class="log-line" style="border-top:1px dashed #666;">結果</div>'; schedule.assignments.forEach(a=>{ const sStr=`${a.start.getHours()}:${String(a.start.getMinutes()).padStart(2,'0')}`, eStr=`${a.end.getHours()}:${String(a.end.getMinutes()).padStart(2,'0')}`; logB.innerHTML+=`<div class="log-line log-success">✔ ${a.bandName}: ${sStr}-${eStr}</div>`; }); schedule.failedBands.forEach(b=>{logB.innerHTML+=`<div class="log-line log-error">✖ ${b.name}: 不可</div>`}); tempLotterySchedule=schedule; document.getElementById('btnApplyLottery').classList.remove('hidden'); }catch(e){console.error(e); logB.innerHTML+='<div class="log-line log-error">エラー</div>';} };
        function attemptSchedule(bands,dur,locked){ const TOTAL_M=(20-9)*60, timeline=new Array(TOTAL_M).fill(null); if(locked)locked.forEach(l=>{ const sM=(l.start.getHours()-9)*60+l.start.getMinutes(), eM=(l.end.getHours()-9)*60+l.end.getMinutes(); for(let t=Math.max(0,sM);t<Math.min(TOTAL_M,eM);t++)timeline[t]="LOCKED"; }); const shuffB=[...bands].sort(()=>Math.random()-0.5), assign=[], failed=[]; shuffB.forEach(b=>{ let ok=false; const reqs=[...b.requests].sort(()=>Math.random()-0.5); for(let r of reqs){ if(ok)break; const rsM=(r.start.getHours()-9)*60+r.start.getMinutes(), reM=(r.end.getHours()-9)*60+r.end.getMinutes(); for(let t=rsM;t<=reM-dur;t+=30){ let free=true; for(let k=0;k<dur;k++){if(t+k>=TOTAL_M||timeline[t+k]!==null){free=false; break;}} if(free){ for(let k=0;k<dur;k++)timeline[t+k]=b.name; const sT=new Date(r.start); sT.setHours(9+Math.floor(t/60),t%60,0,0); const eT=new Date(sT); eT.setMinutes(sT.getMinutes()+dur); assign.push({bandId:b.id,bandName:b.name,start:sT,end:eT,originalDocIds:b.docIds}); ok=true; break; } } } if(!ok)failed.push(b); }); return {assignments:assign,failedBands:failed,successCount:assign.length,timeline,startHour:9}; }
        function extendSchedule(base,bands,target){ const assign=base.assignments, timeline=base.timeline, extra=target-60; [...assign].sort(()=>Math.random()-0.5).forEach(a=>{ const cEM=(a.end.getHours()-9)*60+a.end.getMinutes(); let can=true; for(let k=0;k<extra;k++){if(cEM+k>=timeline.length||timeline[cEM+k]!==null){can=false; break;}} if(can){ const band=bands.find(b=>b.name===a.bandName), nET=new Date(a.end); nET.setMinutes(nET.getMinutes()+extra); let inR=false; for(let r of band.requests){if(r.start<=a.start&&r.end>=nET){inR=true; break;}} if(!inR)can=false; } if(can){ for(let k=0;k<extra;k++)timeline[cEM+k]=a.bandName; a.end.setMinutes(a.end.getMinutes()+extra); } }); return base; }
        window.applyLotteryResults=async()=>{ if(!tempLotterySchedule||!confirm("反映しますか？"))return; const batch=writeBatch(db); tempLotterySchedule.assignments.forEach(a=>{ const ref=doc(collection(db,"bookings")); batch.set(ref,{bandId:a.bandId,bandName:a.bandName,creatorId:currentUser,userName:"抽選確定",startTime:a.start,endTime:a.end,type:'normal',status:'confirmed',source:'lottery',createdAt:new Date()}); a.originalDocIds.forEach(oldId=>batch.delete(doc(db,"bookings",oldId))); }); tempLotterySchedule.failedBands.forEach(b=>b.docIds.forEach(oldId=>batch.delete(doc(db,"bookings",oldId)))); try{await batch.commit(); alert("反映完了"); closePage('admin-calendar-stub');}catch(e){alert(e.message)} };
        window.saveSystemSettings=async()=>{ const mode=document.querySelector('input[name="adminBookingMode"]:checked').value, eMode=document.querySelector('input[name="lotteryExecMode"]:checked').value, days=parseInt(document.getElementById('lotteryAutoDays').value), time=parseInt(document.getElementById('lotteryAutoTime').value); try{ await setDoc(doc(db,"system","settings"),{bookingMode:mode,lotteryConfig:{mode:eMode,daysBefore:days,time:time},updatedAt:serverTimestamp(),updatedBy:currentUser},{merge:true}); alert("保存完了"); closePage('admin-calendar-stub'); }catch(e){alert(e.message)} };
        async function loadSystemConfig(){ try{ const snap=await getDoc(doc(db,"system","settings")); if(snap.exists())currentSystemSettings=snap.data(); }catch(e){} }
        window.switchScreen=(screenId,navEl)=>{ document.querySelectorAll('.screen').forEach(el=>el.classList.remove('active')); document.getElementById('screen-'+screenId).classList.add('active'); document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active')); navEl.classList.add('active'); if(screenId==='calendar'){calendarMode='month'; updateViewMenuUI(); renderCalendar();} if(screenId==='cuesheet'){closeCuesheetDetail(); renderCuesheetBandList();} };
        window.goToMyPage=()=>window.location.href=MY_PAGE_URL;
        window.openPage=(id)=>document.getElementById('page-'+id).classList.add('open');
        window.closePage=(id)=>document.getElementById('page-'+id).classList.remove('open');
        window.openModal=(id)=>document.getElementById(id).classList.add('open');
        window.closeModal=(id)=>document.getElementById(id).classList.remove('open');
        window.openAdminUsers=async()=>{ openPage('admin-users'); document.getElementById('adminUserList').innerHTML='<div style="text-align:center; padding:20px;">読み込み中...</div>'; try{ const q=query(collection(db,"users"),orderBy("createdAt","desc")), qs=await getDocs(q); allUsersCache=[]; qs.forEach(doc=>{ const d=doc.data(); d.affiliations=d.affiliations||(d.org?[d.org]:[]); allUsersCache.push({id:doc.id,...d}); }); renderAdminList(allUsersCache); }catch(e){document.getElementById('adminUserList').innerHTML=e.message} };
        window.sortUsers=(type)=>{ if(type==='year')allUsersCache.sort((a,b)=>(a.year||99)-(b.year||99)); else if(type==='kana')allUsersCache.sort((a,b)=>(a.kana||"").localeCompare(b.kana||"","ja")); renderAdminList(allUsersCache); };
        function renderAdminList(users){ const container=document.getElementById('adminUserList'); container.innerHTML=""; if(users.length===0){container.innerHTML='<div style="padding:20px;">なし</div>';return;} users.forEach(u=>{ const div=document.createElement('div'); div.className='user-list-item'; div.onclick=()=>openAdminEdit(u); let badges=(u.affiliations.includes('urakata')?'<span style="color:#ea4335; font-size:10px; margin-right:4px;">●裏方</span>':'')+(u.affiliations.includes('lmc')?'<span style="color:#5f6368; font-size:10px;">●LMC</span>':''); let kanaHtml=u.kana?`<div style="font-size:9px; color:#888; margin-bottom:2px;">${u.kana}</div>`:''; div.innerHTML=`<img src="${u.icon||'https://ul.h3z.jp/Vnukmtvq.jpg'}" class="mini-icon"><div class="user-info-main">${kanaHtml}<div class="user-name">${u.name} ${u.role?`<span style="font-size:10px; background:#e0e3e7; padding:2px 6px; border-radius:10px; margin-left:5px;">${u.role}</span>`:''}</div><div class="user-sub">${badges} | ${u.year||'-'}年</div></div><span class="material-icons" style="color:#ccc;">chevron_right</span>`; container.appendChild(div); }); }
        document.getElementById('adminSearchInput').addEventListener('input',(e)=>{ const t=e.target.value.trim(); renderAdminList(t?allUsersCache.filter(u=>u.name.includes(t)||u.kana?.includes(t)):allUsersCache); });
        function openAdminEdit(u){ adminEditingUserId=u.id; openPage('admin-edit'); document.getElementById('admin-user-icon').src=u.icon||"https://ul.h3z.jp/Vnukmtvq.jpg"; document.getElementById('admin-user-lineName').innerText="LINE: "+u.lineDisplayName; document.getElementById('admin-edit-docId').innerText=u.id; document.getElementById('admin-show-name').innerText=u.name; document.getElementById('admin-show-kana').innerText=u.kana||"-"; document.getElementById('admin-show-studentId').innerText=u.studentId||"-"; document.getElementById('admin-show-year').innerText=(u.year||"-")+"年"; let affText=(u.affiliations.includes('urakata')?"裏方部 ":"")+(u.affiliations.includes('lmc')?"LMC ":""); document.getElementById('admin-show-aff').innerText=affText; document.getElementById('admin-show-part').innerText=getPartLabel(u.part)||"-"; document.getElementById('admin-edit-role').value=u.role||""; loadAdminUserBands(u.id); }
        async function loadAdminUserBands(uid){ const container=document.getElementById('admin-user-band-list'); container.innerHTML="読み込み中..."; try{ const q=query(collection(db,"bands"),where("memberIds","array-contains",uid)), qs=await getDocs(q); if(qs.empty)container.innerHTML="なし"; else { let h="<ul style='padding-left:20px; margin:0;'>"; qs.forEach(doc=>{ const b=doc.data(); h+=`<li>${b.name} ${b.creatorId===uid?'<span style="font-size:10px; color:#0b57d0;">(リーダー)</span>':''}</li>` }); h+="</ul>"; container.innerHTML=h; } }catch(e){container.innerHTML="エラー"} }
        document.getElementById('btn-save-user-role').addEventListener('click',async()=>{ if(!adminEditingUserId)return; const btn=document.getElementById('btn-save-user-role'); btn.innerText="保存中..."; try{await updateDoc(doc(db,"users",adminEditingUserId),{role:document.getElementById('admin-edit-role').value}); alert("保存完了"); closePage('admin-edit');}catch(e){alert(e.message)}finally{btn.innerText="役職を保存"} });
        window.openAdminBands=async()=>{ openPage('admin-bands'); document.getElementById('adminBandList').innerHTML='<div style="text-align:center; padding:20px;">読み込み中...</div>'; try{ const qs=await getDocs(collection(db,"bands")); allBandsCache=[]; qs.forEach(doc=>allBandsCache.push({id:doc.id,...doc.data()})); allBandsCache.sort((a,b)=>(b.createdAt?.toDate()||0)-(a.createdAt?.toDate()||0)); renderAdminBandList(allBandsCache); }catch(e){document.getElementById('adminBandList').innerHTML=e.message} };
        function renderAdminBandList(bands){ const container=document.getElementById('adminBandList'); container.innerHTML=""; if(bands.length===0){container.innerHTML='<div style="padding:20px;">なし</div>';return;} bands.forEach(b=>{ const div=document.createElement('div'); div.className='card band-card'; div.onclick=()=>openBandDetail(b.id,b); let iconHtml=b.icon?`<div class="band-icon"><img src="${b.icon}"></div>`:`<div class="band-icon">${b.name.charAt(0)}</div>`; const names = b.memberIds.map(id => getNameById(id)).join(', '); div.innerHTML=`<div class="band-item" style="border:none; margin:0; padding:0;">${iconHtml}<div class="band-info"><div class="band-name">${b.name}${b.isArchived?'<span style="font-size:10px; background:#eee; padding:2px 6px; border-radius:4px; margin-left:6px;">アーカイブ</span>':''}</div><div class="band-members">${names}</div></div><span class="material-icons" style="color:#ccc;">chevron_right</span></div>`; container.appendChild(div); }); }
        document.getElementById('adminBandSearchInput')?.addEventListener('input',(e)=>{ const t=e.target.value.trim(); renderAdminBandList(t?allBandsCache.filter(b=>b.name.includes(t)):allBandsCache); });
        async function loadBandBookings(bid){ const list=document.getElementById('adminBandBookingsList'); if(!list)return; list.innerHTML="読み込み中..."; try{ const q=query(collection(db,"bookings"),where("bandId","==",bid)), qs=await getDocs(q); if(qs.empty){list.innerHTML="<div style='padding:12px 16px; color:#999; font-size:12px;'>なし</div>";return;} const bks=[]; qs.forEach(doc=>bks.push(doc.data())); bks.sort((a,b)=>b.startTime.toDate()-a.startTime.toDate()); let h=""; bks.forEach(bk=>{ const d=bk.startTime.toDate(), dStr=`${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`, sL=(bk.status==='confirmed')?`<span class="booking-status" style="background:#e6f4ea; color:#0d652d;">確定</span>`:`<span class="booking-status" style="background:#fff8e1; color:#b06000;">承認待ち</span>`; h+=`<div class="booking-history-item"><div class="booking-date">${dStr}</div><div>${bk.type==='event'?'(イベント)':''} ${sL}</div></div>`; }); list.innerHTML=h; }catch(e){list.innerHTML=e.message} }
        async function main(){ try{ try{ if(typeof __initial_auth_token!=='undefined'&&__initial_auth_token)await signInWithCustomToken(auth,__initial_auth_token); else await signInAnonymously(auth); }catch(ae){console.warn(ae)} await liff.init({liffId:MY_LIFF_ID}); if(!liff.isLoggedIn()){liff.login();return;} const profile=await liff.getProfile(); currentUser=profile.userId; currentProfile=profile; const userRef=doc(db,"users",currentUser), userSnap=await getDoc(userRef); if(!userSnap.exists()){alert("要会員登録"); window.location.href=MY_PAGE_URL; return;} await setDoc(userRef,{lastLogin:serverTimestamp()},{merge:true}); currentUserData=userSnap.data(); renderHeaderIcons(currentUserData); await refreshAllUsersCache(); await loadSystemConfig(); const urlParams=new URLSearchParams(window.location.search), act=urlParams.get('action'), iBid=urlParams.get('bandId'), tP=urlParams.get('page'); if(tP){ const navIdx=(tP==='calendar')?2:(tP==='cuesheet')?3:1, navEl=document.querySelector(`.nav-item:nth-child(${navIdx})`); if(navEl)switchScreen(tP,navEl); } if(act==='invite'&&iBid){await handleInvite(iBid); window.history.replaceState(null,null,window.location.pathname);} loadMyBands(); }catch(e){console.error(e)} }
        function renderCuesheetBandList(){ const container=document.getElementById('cuesheetBandList'); if(!container)return; container.innerHTML=""; const active=myBandsAll.filter(b=>!b.isArchived); if(active.length===0){container.innerHTML='<div style="text-align:center; padding:40px; color:#999;">なし</div>';return;} active.forEach(b=>{ const div=document.createElement('div'); div.className='card band-card'; div.onclick=()=>openCuesheetDetail(b); let iconH=b.icon?`<div class="band-icon"><img src="${b.icon}"></div>`:`<div class="band-icon">${b.name.charAt(0)}</div>`; div.innerHTML=`<div class="band-item" style="border:none; margin:0; padding:0;">${iconH}<div class="band-info"><div class="band-name">${b.name}</div></div><span class="material-icons" style="color:#ccc;">chevron_right</span></div>`; container.appendChild(div); }); }
        window.openCuesheetDetail=function(b){ document.getElementById('cuesheetBandListContainer').classList.add('hidden'); document.getElementById('cuesheetDetailView').classList.remove('hidden'); document.getElementById('cuesheetTargetBandName').innerText=b.name; loadBandCuesheetData(b.id); };
        window.closeCuesheetDetail=function(){ document.getElementById('cuesheetDetailView').classList.add('hidden'); document.getElementById('cuesheetBandListContainer').classList.remove('hidden'); document.getElementById('cuesheetImage').src=""; document.getElementById('cuesheetContent').classList.add('hidden'); document.getElementById('cuesheetEmpty').classList.add('hidden'); if(currentCuesheetUnsub){currentCuesheetUnsub();currentCuesheetUnsub=null;} };
        let currentCuesheetUnsub=null; function loadBandCuesheetData(bid){ if(!bid)return; if(currentCuesheetUnsub)currentCuesheetUnsub(); const loading=document.getElementById('cuesheetLoading'), content=document.getElementById('cuesheetContent'), empty=document.getElementById('cuesheetEmpty'), img=document.getElementById('cuesheetImage'); loading.style.display='block'; content.classList.add('hidden'); empty.classList.add('hidden'); currentCuesheetUnsub=onSnapshot(doc(db,"bands",bid),(docSnap)=>{ loading.style.display='none'; if(docSnap.exists()){ const d=docSnap.data(); if(d.latestCuesheetUrl){img.src=d.latestCuesheetUrl; content.classList.remove('hidden'); empty.classList.add('hidden');} else {content.classList.add('hidden'); empty.classList.remove('hidden');} } else {content.classList.add('hidden'); empty.classList.remove('hidden');} },(e)=>{loading.innerText="エラー"}); }
        function loadMyBands(){ const q=query(collection(db,"bands"),where("memberIds","array-contains",currentUser)); onSnapshot(q,(snapshot)=>{ myBandsAll=[]; snapshot.forEach(docSnap=>myBandsAll.push({id:docSnap.id,...docSnap.data()})); renderBandList(); if(document.getElementById('screen-cuesheet').classList.contains('active')&&!document.getElementById('cuesheetBandListContainer').classList.contains('hidden'))renderCuesheetBandList(); }); }
        window.switchBandTab=(tab)=>{ currentBandTab=tab; document.querySelectorAll('.band-tab').forEach(el=>el.classList.remove('active')); const idx=(tab==='active')?0:1; document.querySelectorAll('.band-tab')[idx].classList.add('active'); renderBandList(); };
        function renderBandList(){ const container=document.getElementById('bandListContainer'); container.innerHTML=""; const target=myBandsAll.filter(b=>(currentBandTab==='active')?!b.isArchived:b.isArchived); if(target.length===0){container.innerHTML=`<div style="text-align:center; padding:40px; color:#999;">なし</div>`;return;} target.forEach(b=>{ const div=document.createElement('div'); div.className='card band-card'; div.onclick=()=>openBandDetail(b.id,b); let iconH=b.icon?`<div class="band-icon"><img src="${b.icon}"></div>`:`<div class="band-icon">${b.name.charAt(0)}</div>`; div.innerHTML=`<div class="band-item" style="border:none; margin:0; padding:0;">${iconH}<div class="band-info"><div class="band-name">${b.name}</div></div><span class="material-icons" style="color:#ccc;">chevron_right</span></div>`; container.appendChild(div); }); }
        async function uploadImageToExternal(blob){ const fd=new FormData(); fd.append('files',blob,'image.jpg'); try{ const res=await fetch('https://ul.h3z.jp/uploader-work/work.php',{method:'POST',body:fd}); if(!res.ok)throw new Error(res.status); const json=await res.json(); if(json.files?.[0]?.url)return json.files[0].url; else throw new Error(); }catch(e){throw new Error('アップロード失敗')} }
        window.openBandModal=()=>{ document.getElementById('inputBandName').value=""; document.getElementById('bandMemberSearchInput').value=""; document.getElementById('userSelectList').innerHTML="読み込み中..."; tempBandIconBlob=null; document.getElementById('previewBandIcon').classList.add('hidden'); loadUserList('userSelectList'); openModal('modal-band'); };
        window.saveBand=async()=>{ const name=document.getElementById('inputBandName').value.trim(); if(!name)return alert("名前を入力"); const selected=document.querySelectorAll('#userSelectList .member-option.selected'), mIds=[currentUser], mNames=[currentProfile.displayName]; selected.forEach(el=>{mIds.push(el.dataset.uid); mNames.push(el.dataset.uname);}); const btn=document.querySelector('#modal-band .btn-primary'); btn.innerText="処理中..."; btn.disabled=true; try{ const docRef=await addDoc(collection(db,"bands"),{name:name,memberIds:mIds,memberNames:mNames,creatorId:currentUser,isArchived:false,createdAt:new Date()}); if(tempBandIconBlob){ try{ const url=await uploadImageToExternal(tempBandIconBlob); await updateDoc(doc(db,"bands",docRef.id),{icon:url}); }catch(ie){alert("画像失敗")} } closeModal('modal-band'); if(confirm("招待状を送りますか？"))shareBandInvite(docRef.id,name); else alert("作成完了"); }catch(e){alert(e.message)}finally{btn.innerText="作成する"; btn.disabled=false;} };
        window.shareBandInvite=async(bid,bn)=>{ const invU=`https://liff.line.me/${MY_LIFF_ID}/?bandId=${bid}&action=invite`; if(liff.isApiAvailable('shareTargetPicker')){ try{await liff.shareTargetPicker([{type:"flex",altText:bn+"への招待",contents:{type:"bubble",body:{type:"box",layout:"vertical",contents:[{type:"text",text:"🎸 バンド招待",weight:"bold",color:"#1DB446",size:"sm"},{type:"text",text:bn,weight:"bold",size:"xl",margin:"md",wrap:true},{type:"text",text:"招待されました。",size:"xs",color:"#aaaaaa",margin:"sm",wrap:true}]},footer:{type:"box",layout:"vertical",spacing:"sm",contents:[{type:"button",style:"primary",height:"sm",color:"#0b57d0",action:{type:"uri",label:"参加する",uri:invU}}]}}}]);}catch(e){alert("失敗")} }else alert("不可"); };
        async function handleInvite(bid){ try{ const snap=await getDoc(doc(db,"bands",bid)); if(!snap.exists())return alert("なし"); const d=snap.data(); if(d.memberIds.includes(currentUser))return alert("既に参加"); if(confirm(d.name+" に参加？")){ await updateDoc(doc(db,"bands",bid),{memberIds:arrayUnion(currentUser),memberNames:arrayUnion(currentProfile.displayName)}); alert("参加完了"); } }catch(e){alert(e.message)} }
        window.openBandDetail=async(bid,data)=>{ 
            document.getElementById('detailBandId').value=bid; 
            document.getElementById('detailBandName').value=data.name; 
            document.getElementById('btnInviteInModal').onclick=()=>shareBandInvite(bid,data.name); 
            currentEditingBandId=bid; 
            currentEditingBandMembers=data.memberIds; 
            const dIcon=document.getElementById('detailBandIcon'), dPick=document.getElementById('detailIconPicker'); 
            dIcon.src=data.icon||'https://ul.h3z.jp/Vnukmtvq.jpg'; 
            const isAdmin=currentUserData?.affiliations.includes('urakata')&&currentUserData.role, canE=(data.creatorId===currentUser)||isAdmin; 
            if(canE&&!data.isArchived)dPick.onclick=()=>document.getElementById('editBandIconInput').click(); else dPick.onclick=null; 
            const mList=document.getElementById('detailMemberList'), nInp=document.getElementById('detailBandName'), bArc=document.getElementById('btnArchive'), bRes=document.getElementById('btnRestore'), bAdd=document.getElementById('btnAddMemberToBand'); 
            mList.innerHTML=""; 
            if(data.isArchived){bArc.classList.add('hidden'); bRes.classList.remove('hidden'); nInp.readOnly=true; bAdd.classList.add('hidden');} else {bArc.classList.remove('hidden'); bRes.classList.add('hidden'); if(canE){nInp.readOnly=false; bAdd.classList.remove('hidden');} else bAdd.classList.add('hidden');} 
            if(canE){document.getElementById('bandCreatorActions').classList.remove('hidden'); document.getElementById('bandMemberActions').classList.add('hidden');} else {nInp.readOnly=true; document.getElementById('bandCreatorActions').classList.add('hidden'); document.getElementById('bandMemberActions').classList.remove('hidden');}
            
            // Stats fetching
            document.getElementById('stat-booking-count').innerText = "0";
            document.getElementById('stat-song-count').innerText = "0";

            data.memberIds.forEach((uid)=>{ 
                const u = allUsersCache.find(x => x.id === uid) || { name: '不明', icon: 'https://ul.h3z.jp/Vnukmtvq.jpg' };
                const row=document.createElement('div'); row.className='member-row-rich'; 
                let roleBadge = (uid===data.creatorId) ? '<span class="member-role-badge">リーダー</span>' : '';
                let deleteBtn = (canE && uid !== currentUser) ? `<button class="btn-remove-member" style="margin-left:auto;" onclick="removeMember('${bid}','${uid}','${u.name}')">削除</button>` : '';
                row.innerHTML=`<img src="${u.icon}" class="member-avatar-small"><div class="member-info-rich"><div class="member-name-rich">${u.name}${roleBadge}</div><div style="font-size:10px; color:#999;">${u.part?getPartLabel(u.part):''}</div></div>${deleteBtn}`;
                mList.appendChild(row); 
            });
            document.getElementById('adminBandBookingsArea').classList.remove('hidden'); 
            loadBandBookings(bid); 
            
            // Real stats logic example
            const bookingQS = await getDocs(query(collection(db, "bookings"), where("bandId", "==", bid), where("status", "==", "confirmed")));
            document.getElementById('stat-booking-count').innerText = bookingQS.size;
            
            openModal('modal-band-detail'); 
        };
        window.archiveBand=async()=>{ const bid=document.getElementById('detailBandId').value; if(confirm("アーカイブ？")){try{await updateDoc(doc(db,"bands",bid),{isArchived:true}); alert("完了"); closeModal('modal-band-detail');}catch(e){alert(e.message)}} };
        window.restoreBand=async()=>{ const bid=document.getElementById('detailBandId').value; if(confirm("復元？")){try{await updateDoc(doc(db,"bands",bid),{isArchived:false}); alert("完了"); closeModal('modal-band-detail');}catch(e){alert(e.message)}} };
        window.updateBandName=async()=>{ const bid=document.getElementById('detailBandId').value, nn=document.getElementById('detailBandName').value.trim(); if(!nn)return; try{await updateDoc(doc(db,"bands",bid),{name:nn}); alert("変更完了"); closeModal('modal-band-detail');}catch(e){alert(e.message)} };
        window.removeMember=async(bid,uid,n)=>{ if(confirm(n+" を削除？")){try{await updateDoc(doc(db,"bands",bid),{memberIds:arrayRemove(uid),memberNames:arrayRemove(n)}); alert("削除完了"); closeModal('modal-band-detail');}catch(e){alert(e.message)}} };
        window.deleteBand=async()=>{ const bid=document.getElementById('detailBandId').value; if(confirm("解散？")){try{await deleteDoc(doc(db,"bands",bid)); alert("解散完了"); closeModal('modal-band-detail');}catch(e){alert(e.message)}} };
        window.leaveBand=async()=>{ const bid=document.getElementById('detailBandId').value; if(confirm("脱退？")){try{await updateDoc(doc(db,"bands",bid),{memberIds:arrayRemove(currentUser),memberNames:arrayRemove(currentProfile.displayName)}); alert("脱退完了"); closeModal('modal-band-detail');}catch(e){alert(e.message)}} };
        window.openAddMemberModal=async()=>{ document.getElementById('addMemberSelectList').innerHTML="中..."; loadUserList('addMemberSelectList',currentEditingBandMembers); openModal('modal-add-member'); };
        window.saveAddedMembers=async()=>{ const sel=document.querySelectorAll('#addMemberSelectList .member-option.selected'); if(sel.length===0)return; const ids=[], nms=[]; sel.forEach(el=>{ids.push(el.dataset.uid); nms.push(el.dataset.uname);}); try{await updateDoc(doc(db,"bands",currentEditingBandId),{memberIds:arrayUnion(...ids),memberNames:arrayUnion(...nms)}); alert("追加完了"); closeModal('modal-add-member'); closeModal('modal-band-detail');}catch(e){alert(e.message)} };
        window.handleImageSelect=(inp,pid)=>{ if(inp.files?.[0]){ compressImage(inp.files[0]).then(b=>{tempBandIconBlob=b; const i=document.getElementById(pid); i.src=URL.createObjectURL(b); i.classList.remove('hidden');}).catch(e=>alert(e.message)); } };
        window.handleImageEdit=async(inp)=>{ if(inp.files?.[0]&&confirm("変更？")){ const dIcon=document.getElementById('detailBandIcon'), old=dIcon.src; dIcon.style.opacity="0.5"; try{ const b=await compressImage(inp.files[0]), bid=document.getElementById('detailBandId').value, u=await uploadImageToExternal(b); await updateDoc(doc(db,"bands",bid),{icon:u}); dIcon.src=u; alert("変更完了"); }catch(e){dIcon.src=old; alert(e.message);}finally{dIcon.style.opacity="1";} } };
        const compressImage=(f)=>{ return new Promise((res,rej)=>{ const i=new Image(); i.src=URL.createObjectURL(f); i.onload=()=>{ const c=document.createElement('canvas'), ctx=c.getContext('2d'), s=200; c.width=s; c.height=s; let w=i.width, h=i.height, sx=0, sy=0; if(w>h){w=h; sx=(i.width-h)/2;} else {h=w; sy=(i.height-w)/2;} ctx.drawImage(i,sx,sy,w,h,0,0,s,s); c.toBlob(b=>b?res(b):rej(),'image/jpeg',0.8); }; i.onerror=rej; }); };
        async function loadUserList(tid='userSelectList',ex=[]){ const list=document.getElementById(tid), qs=await getDocs(collection(db,"users")); list.innerHTML=""; let c=0; qs.forEach(doc=>{ const u=doc.data(); if(doc.id===currentUser||ex.includes(doc.id))return; const div=document.createElement('div'); div.className='member-option'; div.dataset.uid=doc.id; div.dataset.uname=u.name; div.dataset.ukana=u.kana||""; div.onclick=()=>{div.classList.toggle('selected'); div.querySelector('.material-icons').innerText=div.classList.contains('selected')?'check_box':'check_box_outline_blank';}; div.innerHTML=`<span class="material-icons member-check">check_box_outline_blank</span><img src="${u.icon||'https://ul.h3z.jp/Vnukmtvq.jpg'}" style="width:32px; height:32px; border-radius:50%; margin-right:10px; object-fit:cover;"><div>${u.name} <span style="font-size:10px; color:#999;">${u.part?`(${getPartLabel(u.part)})`:''}</span></div>`; list.appendChild(div); c++; }); if(c===0)list.innerHTML='<div style="padding:10px; color:#999;">なし</div>'; }
        document.getElementById('bandMemberSearchInput')?.addEventListener('input',(e)=>{ const t=e.target.value.trim().toLowerCase(); document.querySelectorAll('#userSelectList .member-option').forEach(el=>{ const n=el.dataset.uname.toLowerCase(), k=(el.dataset.ukana||"").toLowerCase(); el.style.display=(n.includes(t)||k.includes(t))?'flex':'none'; }); });
        function getPartLabel(p){ return {vocal:"Vo",guitar:"Gt",bass:"Ba",drums:"Dr",keyboard:"Key"}[p]||""; }
        window.toggleViewMenu=()=>document.getElementById('viewMenu').classList.toggle('open');
        window.switchCalendarView=(m)=>{
            calendarMode=m;
            if(m==='day'){
                const t=new Date();
                if(displayDate.getMonth()===t.getMonth()&&displayDate.getFullYear()===t.getFullYear()) {
                   // Same month, keep current date
                } else {
                    // Different month, default to 1st
                   displayDate.setDate(1);
                }
            }
            updateViewMenuUI();
            renderCalendar();
        };
        function updateViewMenuUI(){ const isMonth = (calendarMode === 'month'); document.getElementById('calMonthView').classList.toggle('hidden', !isMonth); document.getElementById('calDayView').classList.toggle('hidden', isMonth); const switcher = document.getElementById('viewSwitcher'); switcher.classList.toggle('day-mode', !isMonth); document.querySelectorAll('.switcher-item').forEach(el => { el.classList.toggle('active', el.dataset.mode === calendarMode); }); }
        window.changeDate=(d)=>{ if(calendarMode==='month')displayDate.setMonth(displayDate.getMonth()+d); else displayDate.setDate(displayDate.getDate()+d); renderCalendar(); };
        function renderCalendar(){ const y=displayDate.getFullYear(), m=displayDate.getMonth()+1; if(calendarMode==='month'){document.getElementById('calHeaderDate').innerText=`${y}年 ${m}月`; renderMonthView();} else {const d=displayDate.getDate(), w=['日','月','火','水','木','金','土'][displayDate.getDay()]; document.getElementById('calHeaderDate').innerText=`${m}月`; document.getElementById('dayViewDateLabel').innerText=`${m}/${d} (${w})`; renderDayView();} }
        function renderMonthView(){ const grid=document.getElementById('monthGrid'); grid.innerHTML=""; ['日','月','火','水','木','金','土'].forEach(wd=>{const div=document.createElement('div'); div.className='weekday-label'; div.innerText=wd; if(wd==='日')div.classList.add('sun'); if(wd==='土')div.classList.add('sat'); grid.appendChild(div);}); const y=displayDate.getFullYear(), m=displayDate.getMonth(), firstD=new Date(y,m,1), lastD=new Date(y,m+1,0), today=new Date(); for(let i=0; i<firstD.getDay(); i++)grid.appendChild(document.createElement('div')); for(let d=1; d<=lastD.getDate(); d++){ const div=document.createElement('div'); div.className='day-cell'; div.id=`day-${y}-${m+1}-${d}`; if(y===today.getFullYear()&&m===today.getMonth()&&d===today.getDate())div.classList.add('today'); div.onclick=()=>{displayDate.setDate(d); switchCalendarView('day');}; div.innerHTML=`<div class="day-num">${d}</div><div class="status-label"></div><div class="event-dots" id="dots-${y}-${m+1}-${d}"></div>`; grid.appendChild(div); } loadMonthBookings(y,m); }
        function loadMonthBookings(y,m){ onSnapshot(query(collection(db,"bookings"),where("startTime",">=",new Date(y,m,1)),where("startTime","<=",new Date(y,m+1,0,23,59,59))),(qs)=>{ document.querySelectorAll('.event-dots').forEach(el=>el.innerHTML=""); document.querySelectorAll('.day-cell.unavailable').forEach(el=>{ el.classList.remove('unavailable'); const st = el.querySelector('.status-label'); if(st) st.innerHTML = ""; }); qs.forEach(docSnap=>{ const d=docSnap.data().startTime.toDate(); const cell = document.getElementById(`day-${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`); if(docSnap.data().type==='event' && cell){ cell.classList.add('unavailable'); const st = cell.querySelector('.status-label'); if(st) st.innerText = "🚫不可"; } else if(cell) { const c=document.getElementById(`dots-${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`); if(c&&c.children.length<3){const dot=document.createElement('div'); dot.className='dot'; c.appendChild(dot);} } }); }); }
        function renderDayView(){ const banner=document.getElementById('bookingModeBanner'), mode=currentSystemSettings.bookingMode||'first_come'; if(mode==='lottery'){banner.style.backgroundColor='#fff3e0'; banner.style.color='#e65100'; banner.style.border='1px solid #ffe0b2'; banner.innerHTML=`<div style="font-weight:bold; font-size:14px;"><span class="material-icons" style="font-size:18px;">casino</span> 抽選受付中</div><div style="font-size:11px;">希望を提出してください。</div>`;} else {banner.style.backgroundColor='#e8f0fe'; banner.style.color='#1967d2'; banner.style.border='1px solid #d2e3fc'; banner.innerHTML=`<div style="font-weight:bold; font-size:14px;"><span class="material-icons" style="font-size:18px;">flash_on</span> 先着順モード</div><div style="font-size:11px;">即時確定します。</div>`;} const container=document.getElementById('timeline'); container.innerHTML=""; for(let h=9;h<20;h++){ const slot=document.createElement('div'); slot.className='time-slot'; slot.innerHTML=`<div class="time-label">${h}:00</div>`; const content=document.createElement('div'); content.className='time-content'; content.dataset.hour=h; content.addEventListener('touchstart',handleTouchStart,{passive:false}); content.addEventListener('touchmove',handleTouchMove,{passive:false}); content.addEventListener('touchend',handleTouchEnd); content.addEventListener('mousedown',handleMouseDown); slot.appendChild(content); container.appendChild(slot); } container.addEventListener('mousemove',handleMouseMove); container.addEventListener('mouseup',handleMouseUp); loadDayBookings(); }
        function handleTouchStart(e){ if(e.target.classList.contains('event-block'))return; const h=parseInt(e.target.dataset.hour); if(isNaN(h))return; selectionTimer=setTimeout(()=>{isSelecting=true; selectionStartHour=h; selectionEndHour=h; updateSelectionUI(); document.getElementById('selectionToast').classList.add('show'); if(navigator.vibrate)navigator.vibrate(50);},500); }
        function handleTouchMove(e){ if(!isSelecting){clearTimeout(selectionTimer);return;} e.preventDefault(); const t=document.elementFromPoint(e.touches[0].clientX,e.touches[0].clientY); if(t&&t.classList.contains('time-content')){selectionEndHour=parseInt(t.dataset.hour); updateSelectionUI();} }
        function handleTouchEnd(e){ clearTimeout(selectionTimer); if(isSelecting){isSelecting=false; document.getElementById('selectionToast').classList.remove('show'); openBookingModalRange();} }
        function handleMouseDown(e){ if(!e.target.classList.contains('time-content'))return; isSelecting=true; selectionStartHour=parseInt(e.target.dataset.hour); selectionEndHour=selectionStartHour; updateSelectionUI(); }
        function handleMouseMove(e){ if(isSelecting&&e.target.classList.contains('time-content')){selectionEndHour=parseInt(e.target.dataset.hour); updateSelectionUI();} }
        function handleMouseUp(){ if(isSelecting){isSelecting=false; openBookingModalRange();} }
        function updateSelectionUI(){ document.querySelectorAll('.time-content').forEach(el=>el.classList.remove('selecting')); if(selectionStartHour===null||selectionEndHour===null)return; const s=Math.min(selectionStartHour,selectionEndHour), e=Math.max(selectionStartHour,selectionEndHour); for(let h=s; h<=e; h++)document.querySelector(`.time-content[data-hour="${h}"]`)?.classList.add('selecting'); }
        window.toggleAllDay=()=>{ const isA=document.getElementById('checkAllDay').checked, area=document.getElementById('timeSelectArea'); if(isA){area.style.opacity="0.5"; area.style.pointerEvents="none"; document.getElementById('selectStartTime').value="9:00"; document.getElementById('selectEndTime').value="20:00";} else {area.style.opacity="1"; area.style.pointerEvents="auto";} };
        window.toggleBookingInputs=()=>{ const t=document.querySelector('input[name="bookingType"]:checked')?.value||'normal'; if(t==='event'){document.getElementById('groupBandSelect').classList.add('hidden'); document.getElementById('groupEventTitle').classList.remove('hidden');} else {document.getElementById('groupBandSelect').classList.remove('hidden'); document.getElementById('groupEventTitle').classList.add('hidden');} };
        function openBookingModalRange(){ document.querySelectorAll('.time-content').forEach(el=>el.classList.remove('selecting')); const s=Math.min(selectionStartHour,selectionEndHour), e=Math.max(selectionStartHour,selectionEndHour); document.getElementById('bookingModalTitle').innerText="新規予約"; document.getElementById('btnSaveBooking').innerText="確定する"; document.getElementById('btnDeleteBooking').classList.add('hidden'); document.getElementById('btnAddToGCal').classList.add('hidden'); document.getElementById('editingBookingId').value=""; const isAdmin=currentUserData?.affiliations.includes('urakata')&&currentUserData.role; document.getElementById('bookingTypeSelector').classList.toggle('hidden',!isAdmin); if(isAdmin)document.querySelector('input[name="bookingType"][value="normal"]').checked=true; toggleBookingInputs(); document.getElementById('bookingDateDisplay').innerText=`${displayDate.getMonth()+1}月 ${displayDate.getDate()}日`; setupTimeSelects(`${s}:00`,`${e+1}:00`); document.getElementById('checkAllDay').checked=false; toggleAllDay(); updateBandSelect(); openModal('modal-booking'); }
        function openEditBookingModal(id,data){ if(data.creatorId!==currentUser){ if(data.type==='event')alert(`【${data.title}】\n予定あり`); else alert("編集不可"); return; } document.getElementById('bookingModalTitle').innerText="予約の編集"; document.getElementById('btnSaveBooking').innerText="変更保存"; document.getElementById('btnDeleteBooking').classList.remove('hidden'); document.getElementById('btnAddToGCal').classList.remove('hidden'); document.getElementById('editingBookingId').value=id; editingBookingData=data; const isAdmin=currentUserData?.affiliations.includes('urakata')&&currentUserData.role; document.getElementById('bookingTypeSelector').classList.toggle('hidden',!isAdmin); if(isAdmin)document.querySelector(`input[name="bookingType"][value="${data.type||'normal'}"]`).checked=true; toggleBookingInputs(); const s=data.startTime.toDate(), e=data.endTime.toDate(), sStr=`${s.getHours()}:${String(s.getMinutes()).padStart(2,'0')}`, eStr=`${e.getHours()}:${String(e.getMinutes()).padStart(2,'0')}`; document.getElementById('bookingDateDisplay').innerText=`${s.getMonth()+1}月 ${s.getDate()}日`; document.getElementById('checkAllDay').checked=(sStr==="9:00"&&eStr==="20:00"); setupTimeSelects(sStr,eStr); toggleAllDay(); if(data.type==='event')document.getElementById('inputEventTitle').value=data.title||""; else updateBandSelect(data.bandId); openModal('modal-booking'); }
        function setupTimeSelects(ds,de){ const sSel=document.getElementById('selectStartTime'), eSel=document.getElementById('selectEndTime'), opts=[]; for(let h=9;h<=20;h++){ opts.push(`${h}:00`); if(h<20)opts.push(`${h}:30`); } sSel.innerHTML=""; eSel.innerHTML=""; opts.forEach(t=>{sSel.appendChild(new Option(t,t)); eSel.appendChild(new Option(t,t));}); if(ds)sSel.value=ds; if(de)eSel.value=de; }
        function updateBandSelect(bid=""){ const s=document.getElementById('selectBookingBand'); s.innerHTML=""; const active=myBandsAll.filter(b=>!b.isArchived); if(active.length===0)s.appendChild(new Option("なし","")); else active.forEach(b=>{const op=new Option(b.name,b.id); if(b.id===bid)op.selected=true; s.appendChild(op);}); }
        window.openEventListModal=(evs)=>{ const c=document.getElementById('eventListContainer'); c.innerHTML=""; evs.sort((a,b)=>a.startTime.toDate()-b.startTime.toDate()).forEach(d=>{ const div=document.createElement('div'); div.className="card"; div.style.cursor="pointer"; const s=d.startTime.toDate(), e=d.endTime.toDate(), tStr=`${s.getHours()}:${String(s.getMinutes()).padStart(2,'0')} - ${e.getHours()}:${String(e.getMinutes()).padStart(2,'0')}`; div.innerHTML=`<div style="font-weight:bold; color:#0b57d0;">${tStr}</div><div>${d.type==='event'?d.title:d.bandName}</div>`+(d.status==='pending'?'<div style="font-size:10px; color:#b06000;">●承認待ち</div>':''); div.onclick=()=>{closeModal('modal-event-list'); openEditBookingModal(d.id,d);}; c.appendChild(div); }); openModal('modal-event-list'); };
        function loadDayBookings(){ const sD=new Date(displayDate), eD=new Date(displayDate); sD.setHours(0,0,0,0); eD.setHours(23,59,59,999); onSnapshot(query(collection(db,"bookings"),where("startTime",">=",sD),where("startTime","<=",eD)),(qs)=>{ document.querySelectorAll('.event-block').forEach(el=>el.remove()); const evs=[]; qs.forEach(snap=>{const d=snap.data(); d.id=snap.id; evs.push(d);}); if(evs.length===0)return; evs.sort((a,b)=>a.startTime.toDate()-a.startTime.toDate()); const clusters=[]; let curC=[], curE=0; evs.forEach(ev=>{const sT=ev.startTime.toDate().getTime(), eT=ev.endTime.toDate().getTime(); if(curC.length===0||sT<curE){curC.push(ev); if(eT>curE)curE=eT;} else {clusters.push(curC); curC=[ev]; curE=eT;} }); if(curC.length>0)clusters.push(curC); clusters.forEach(cl=>{ let pts=[]; cl.forEach(e=>{pts.push({t:e.startTime.toDate().getTime(),type:1}); pts.push({t:e.endTime.toDate().getTime(),type:-1});}); pts.sort((a,b)=>a.t-b.t||a.type-b.type); let maxC=0, curCon=0; pts.forEach(p=>{curCon+=p.type; if(curCon>maxC)maxC=curCon;}); if(maxC>3)renderSummaryBlock(cl,new Date(Math.min(...cl.map(e=>e.startTime.toDate().getTime()))),new Date(Math.max(...cl.map(e=>e.endTime.toDate().getTime())))); else { const cols=[]; cl.forEach(e=>{ let ok=false; const s=e.startTime.toDate().getTime(), end=e.endTime.toDate().getTime(); for(let i=0; i<cols.length;i++){if(cols[i]<=s){e.colIndex=i; cols[i]=end; ok=true; break;}} if(!ok){e.colIndex=cols.length; cols.push(end);} }); const wP=85/cols.length; cl.forEach(e=>renderEventBlock(e,e.colIndex*wP,wP)); } }); }); }
        function renderEventBlock(d,l,w){ const s=d.startTime.toDate(), e=d.endTime.toDate(), sM=(s.getHours()-9)*60+s.getMinutes(), eM=(e.getHours()-9)*60+e.getMinutes(), slots=document.querySelectorAll('.time-slot'); if(slots[s.getHours()-9]){ const cA=slots[s.getHours()-9].querySelector('.time-content'), div=document.createElement('div'); div.className='event-block'; div.style.top=(s.getMinutes()+1)+"px"; div.style.height=(eM-sM-2)+"px"; div.style.left=l+"%"; div.style.width=w+"%"; if(d.type==='event'){div.classList.add('special-event'); div.innerHTML=`<div class="event-title">${d.title}</div>`;} else { div.innerHTML=`<div class="event-title">${d.bandName}</div><div style="font-size:10px; opacity:0.8;">${d.userName||''}</div>`; if(d.status==='pending')div.classList.add('pending'); const myB=myBandsAll.map(b=>b.id); if(myB.includes(d.bandId)){if(d.status!=='pending'){div.style.backgroundColor="#e6f4ea"; div.style.borderLeftColor="#34A853"; div.style.color="#0d652d";}} else if(d.status!=='pending'){div.style.backgroundColor="#f1f3f4"; div.style.borderLeftColor="#9aa0a6"; div.style.color="#5f6368";} if(d.source==='lottery'){div.classList.add('lottery-confirmed'); div.style.backgroundColor="#f3e5f5"; div.style.borderLeftColor="#ab47bc"; div.style.color="#4a148c";} } div.onclick=(ev)=>{ev.stopPropagation(); openEditBookingModal(d.id,d);}; cA.appendChild(div); } }
        function renderSummaryBlock(evs,sT,eT){ const sM=(sT.getHours()-9)*60+sT.getMinutes(), eM=(eT.getHours()-9)*60+eT.getMinutes(), slots=document.querySelectorAll('.time-slot'); if(slots[sT.getHours()-9]){ const cA=slots[sT.getHours()-9].querySelector('.time-content'), div=document.createElement('div'); div.className='event-block cluster'; div.style.top=(sT.getMinutes()+1)+"px"; div.style.height=(eM-sM-2)+"px"; div.style.width="85%"; div.innerHTML=`<div class="event-title">予約 ${evs.length}件</div>`; div.onclick=(e)=>{e.stopPropagation(); openEventListModal(evs);}; cA.appendChild(div); } }
        window.saveBooking=async()=>{ const eid=document.getElementById('editingBookingId').value, t=document.querySelector('input[name="bookingType"]:checked')?.value||'normal'; let bd={creatorId:currentUser,userName:currentProfile.displayName,type:t,createdAt:new Date()}; if(t==='normal'){const bS=document.getElementById('selectBookingBand'); if(!bS.value)return alert("要バンド"); bd.bandId=bS.value; bd.bandName=bS.options[bS.selectedIndex].text;} else {const tit=document.getElementById('inputEventTitle').value.trim(); if(!tit)return; bd.title=tit; bd.bandName=tit;} let sH,sM,eH,eM; if(document.getElementById('checkAllDay').checked){sH=9;sM=0;eH=20;eM=0;} else {const sTS=document.getElementById('selectStartTime').value, eTS=document.getElementById('selectEndTime').value; [sH,sM]=sTS.split(':').map(Number); [eH,eM]=eTS.split(':').map(Number);} const st=new Date(displayDate), et=new Date(displayDate); st.setHours(sH,sM,0,0); et.setHours(eH,eM,0,0); if(st>=et)return alert("時間不正"); bd.startTime=st; bd.endTime=et; const mode=currentSystemSettings.bookingMode||'first_come'; if(mode==='first_come'){ const q=query(collection(db,"bookings"),where("startTime",">=",new Date(st).setHours(0,0,0,0)),where("startTime","<=",new Date(st).setHours(23,59,59,999))); try{ const snap=await getDocs(q); let over=false; snap.forEach(d=>{if(eid&&d.id===eid)return; const e=d.data().startTime.toDate(), f=d.data().endTime.toDate(); if(e<et&&f>st)over=true;}); if(over)return alert("重複あり"); bd.status='confirmed'; }catch(e){return alert(e.message)} } else bd.status='pending'; try{ if(eid){delete bd.createdAt; await updateDoc(doc(db,"bookings",eid),bd); alert("保存完了");} else {await addDoc(collection(db,"bookings"),bd); alert(mode==='lottery'?"希望提出完了":"予約完了");} closeModal('modal-booking'); }catch(e){alert(e.message)} };
        window.addToGoogleCalendar=()=>{ if(!editingBookingData)return; const t=editingBookingData.bandName||"練習", s=editingBookingData.startTime.toDate().toISOString().replace(/-|:|\.\d\d\d/g,""), e=editingBookingData.endTime.toDate().toISOString().replace(/-|:|\.\d\d\d/g,""); window.open(`https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(t)}&dates=${s}/${e}`, '_blank'); };
        window.deleteBooking=async()=>{ const eid=document.getElementById('editingBookingId').value; if(eid&&confirm("削除？")){try{await deleteDoc(doc(db,"bookings",eid)); alert("削除完了"); closeModal('modal-booking');}catch(e){alert(e.message)}} };
        function renderHeaderIcons(d){ let r=""; const aff=d.affiliations||[], isU=aff.includes("urakata"); if(d.birthday){const t=new Date(), b=new Date(d.birthday); if(t.getMonth()===b.getMonth()&&t.getDate()===b.getDate())r="ring-birthday";} if(!r&&isU)r=d.job?`ring-${d.job}`:"ring-rainbow"; const h=`<img src="${d.icon||'https://ul.h3z.jp/Vnukmtvq.jpg'}">`; ['headerIconBands','headerIconCal','headerIconCue','headerIconAdmin'].forEach(id=>{ const el=document.getElementById(id); if(el){el.innerHTML=h; el.className="header-avatar "+r; el.onclick=openUserStatusModal;} }); if(isU&&d.role)document.getElementById('nav-admin').classList.remove('hidden'); }
        main();
    </script>
</body>
</html>
