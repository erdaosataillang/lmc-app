<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LMC Mobile</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script><script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; font-family: 'Roboto', 'Noto Sans JP', sans-serif; background-color: rgb(241, 244, 249); color: #1f1f1f; min-height: 100vh; padding-bottom: 88px; overscroll-behavior-y: none; user-select: none; -webkit-user-select: none; }
        .container { max-width: 480px; margin: 0 auto; height: 100%; display: flex; flex-direction: column; } .hidden { display: none !important; }
        .app-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: rgb(241, 244, 249); flex-shrink: 0; z-index: 500; }
        .header-title { font-size: 22px; font-weight: bold; color: #1f1f1f; display: flex; align-items: center; gap: 8px; }
        .header-avatar { width: 36px; height: 36px; border-radius: 50%; display: flex; justify-content: center; align-items: center; background: #dadce0; cursor: pointer; position: relative; }
        .header-avatar img { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid white; z-index: 2; }
        .ring-sound { background: #1a73e8; box-shadow: 0 0 5px rgba(26,115,232,0.5); } .ring-light { background: #fa7b17; box-shadow: 0 0 5px rgba(250,123,23,0.5); }
        .ring-stage { background: #34A853; box-shadow: 0 0 5px rgba(52,168,83,0.5); } .ring-video { background: #EA4335; box-shadow: 0 0 5px rgba(234,67,53,0.5); }
        .ring-rainbow { background: linear-gradient(135deg, #EA4335, #FBBC05, #34A853, #4285F4); animation: spin 4s linear infinite; }
        .ring-birthday { background: linear-gradient(45deg, #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000); background-size: 400%; animation: birthday-glow 3s linear infinite; box-shadow: 0 0 8px rgba(255, 215, 0, 0.8); }
        @keyframes spin { 100% { transform: rotate(360deg); } } @keyframes birthday-glow { 0% { background-position: 0 0; } 50% { background-position: 400% 0; } 100% { background-position: 0 0; } }
        .screen { display: none; flex-direction: column; height: 100%; width: 100%; } .screen.active { display: flex; }
        .scroll-content { flex-grow: 1; overflow-y: auto; padding: 16px; padding-bottom: 100px; -webkit-overflow-scrolling: touch; }
        .calendar-controls { display: flex; justify-content: space-between; align-items: center; background: white; padding: 12px 16px; border-radius: 12px; margin: 0 16px 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); flex-shrink: 0; z-index: 400; }
        .view-switcher { display: flex; position: relative; background: #f1f3f4; border-radius: 20px; padding: 2px; width: 90px; height: 32px; }
        .switcher-item { flex: 1; z-index: 2; font-size: 13px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: color 0.3s; color: #5f6368; } .switcher-item.active { color: #0b57d0; }
        .switcher-slide { position: absolute; width: 44px; height: 28px; background: white; border-radius: 18px; top: 2px; left: 2px; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 1px 3px rgba(0,0,0,0.1); z-index: 1; } .view-switcher.day-mode .switcher-slide { transform: translateX(42px); }
        .month-grid { background: white; border-radius: 12px; padding: 10px; display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; margin-bottom: 20px; }
        .weekday-label { font-size: 11px; color: #5f6368; padding-bottom: 8px; font-weight: bold; } .weekday-label.sun { color: #d93025; } .weekday-label.sat { color: #1a73e8; }
        .day-cell { height: 68px; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 6px; cursor: pointer; border: 1px solid transparent; transition: all 0.2s; background-color: #fafafa; }
        .day-num { font-size: 14px; width: 28px; height: 28px; line-height: 28px; border-radius: 50%; z-index: 2; margin-bottom: 2px; } .day-cell.today { background-color: #e8f0fe; } .day-cell.today .day-num { background: #0b57d0; color: white; font-weight: bold; }
        .day-cell.other-month { opacity: 0.15; cursor: default; pointer-events: none; } .day-cell.unavailable { background-color: #fff1f0; border-color: #ffccc7; } .day-cell.unavailable .day-num { color: #cf1322; }
        .status-label { font-size: 8px; color: #cf1322; font-weight: bold; height: 12px; transform: scale(0.9); }
        .event-dots { display: flex; gap: 3px; margin-top: 2px; justify-content: center; min-height: 6px; } .dot { width: 5px; height: 5px; border-radius: 50%; background: #34A853; } .dot.event { background: #137333; transform: scale(1.2); }
        .timeline-container { background: white; border-radius: 12px; padding: 10px 0; position: relative; height: auto; min-height: 600px; }
        .time-slot { height: 60px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: flex-start; position: relative; }
        .time-label { width: 50px; font-size: 12px; color: #5f6368; text-align: center; transform: translateY(-8px); }
        .time-content { flex-grow: 1; height: 100%; position: relative; border-left: 1px solid #f0f0f0; touch-action: pan-y; } .time-content.selecting { background-color: rgba(11, 87, 208, 0.2); }
        .event-block { position: absolute; left: 0; width: 100%; background: #e8f0fe; border-left: 4px solid #0b57d0; border-radius: 4px; padding: 4px 8px; font-size: 12px; color: #0b57d0; overflow: hidden; cursor: pointer; z-index: 10; box-shadow: 0 1px 2px rgba(0,0,0,0.1); box-sizing: border-box; }
        .event-title { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; } .event-block.special-event { background: #e6f4ea; border-left: 4px solid #137333; color: #0d652d; }
        .event-block.pending { opacity: 0.9; background: #fff8e1; border-left: 4px solid #ffb300; color: #b06000; border: 1px dashed #ffb300; border-left-style: solid; }
        .event-block.lottery-confirmed { background: #f3e5f5; border-left: 4px solid #ab47bc; color: #4a148c; }
        .card { background: white; border-radius: 16px; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); margin-bottom: 12px; transition: background-color 0.2s; } .card.band-card:active { background-color: #f5f5f5; }
        .band-item { display: flex; align-items: center; border-bottom: 1px solid #f0f0f0; padding-bottom: 12px; margin-bottom: 12px; } .band-item:last-child { border: none; margin: 0; padding: 0; }
        .band-icon { width: 48px; height: 48px; background: #e0e3e7; border-radius: 12px; display: flex; justify-content: center; align-items: center; margin-right: 12px; font-size: 20px; color: #5f6368; font-weight: bold; overflow: hidden; } .band-icon img { width: 100%; height: 100%; object-fit: cover; }
        .band-info { flex-grow: 1; } .band-name { font-weight: bold; font-size: 16px; } .band-members { font-size: 12px; color: #5f6368; }
        .band-tabs { display: flex; background: white; border-radius: 12px; padding: 4px; margin: 0 16px 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); flex-shrink: 0; } .band-tab { flex: 1; text-align: center; padding: 10px; font-size: 14px; font-weight: bold; border-radius: 8px; cursor: pointer; color: #5f6368; } .band-tab.active { background: #e8f0fe; color: #0b57d0; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #f0f4f9; border-top: none; display: flex; justify-content: space-around; padding: 12px 0 28px; z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #444746; font-size: 12px; width: 72px; cursor: pointer; gap: 4px; font-weight: 500; }
        .nav-icon { font-size: 24px; padding: 4px 20px; border-radius: 16px; transition: background-color 0.2s ease-in-out, color 0.2s; } .nav-item.active .nav-icon { background-color: #c2e7ff; color: #001d35; } .nav-item#nav-admin.active .nav-icon { background-color: #ffd8e4; color: #31111d; } .nav-item.active span { color: #1f1f1f; font-weight: bold; }
        .fab { position: fixed; bottom: 100px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background: #c2e7ff; color: #001d35; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; z-index: 900; }
        .btn-primary { background: #0b57d0; color: white; border: none; padding: 12px 20px; border-radius: 24px; width: 100%; font-weight: bold; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .btn-secondary { background: #f1f3f4; color: #1f1f1f; border: none; padding: 12px 20px; border-radius: 24px; width: 100%; margin-top: 8px; cursor: pointer; font-weight: bold; }
        .btn-danger { background: #fee2e2; color: #d93025; border: none; padding: 12px 20px; border-radius: 24px; width: 100%; margin-top: 8px; cursor: pointer; font-weight: bold; }
        .btn-outline { background: white; color: #0b57d0; border: 1px solid #dadce0; padding: 6px 12px; border-radius: 16px; font-size: 12px; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; margin-left: auto; }
        .btn-google { background: #fff; color: #3c4043; border: 1px solid #dadce0; padding: 10px; border-radius: 20px; font-weight: bold; width: 100%; margin-top: 16px; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .form-group { margin-bottom: 16px; } .form-label { display: block; font-size: 12px; color: #5f6368; margin-bottom: 4px; font-weight: bold; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #dadce0; border-radius: 8px; box-sizing: border-box; font-size: 16px; background: white; }
        .member-select-list { max-height: 200px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; } .member-option { padding: 10px; display: flex; align-items: center; border-bottom: 1px solid #eee; cursor: pointer; }
        .member-option.selected { background: #e8f0fe; } .member-check { margin-right: 10px; color: #0b57d0; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; display: none; justify-content: center; align-items: flex-end; } .modal-overlay.open { display: flex; }
        .modal-content { background: white; width: 100%; max-width: 480px; border-radius: 24px 24px 0 0; padding: 24px; box-sizing: border-box; max-height: 85vh; overflow-y: auto; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .member-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f9f9f9; }
        .btn-remove-member { font-size: 11px; color: #d93025; border: 1px solid #d93025; background: white; border-radius: 4px; padding: 2px 8px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="selectionToast">なぞって時間を選択...</div>
    <!-- 画面 -->
    <div id="screen-bands" class="screen active">
        <div class="app-header"><div class="header-title">マイバンド <span style="font-size:12px; font-weight:normal; background:#e8f0fe; color:#0b57d0; padding:4px 8px; border-radius:12px;">2025年度</span></div><div class="header-avatar" id="headerIconBands"></div></div>
        <div class="band-tabs"><div class="band-tab active" onclick="switchBandTab('active')">活動中</div><div class="band-tab" onclick="switchBandTab('archived')">アーカイブ</div></div>
        <div class="scroll-content"><div id="bandListContainer"><div style="text-align:center; color:#999; margin-top:40px;">読み込み中...</div></div></div>
        <div class="fab" onclick="openBandModal()"><span class="material-icons">add</span></div>
    </div>

    <div id="screen-calendar" class="screen">
        <div class="app-header"><div class="header-title">合わせ予約</div><div class="header-avatar" id="headerIconCal"></div></div>
        <div class="calendar-controls">
            <div class="view-switcher" id="viewSwitcher">
                <div class="switcher-slide"></div>
                <div class="switcher-item active" data-mode="month" onclick="switchCalendarView('month')">月</div>
                <div class="switcher-item" data-mode="day" onclick="switchCalendarView('day')">日</div>
            </div>
            <div style="display:flex; align-items:center;"><span class="material-icons" style="cursor:pointer; padding:5px;" onclick="changeDate(-1)">chevron_left</span><div class="date-display" id="calHeaderDate" style="margin:0 10px; font-size:16px;"></div><span class="material-icons" style="cursor:pointer; padding:5px;" onclick="changeDate(1)">chevron_right</span></div>
        </div>
        <div class="scroll-content">
            <div id="calMonthView"><div class="month-grid" id="monthGrid"></div></div>
            <div id="calDayView" class="hidden">
                <div style="text-align:center; margin-bottom:10px; font-weight:bold; color:#0b57d0;" id="dayViewDateLabel"></div>
                <div id="bookingModeBanner" style="margin:0 10px 10px; padding:10px; border-radius:8px; font-size:13px; text-align:center; line-height:1.4;"></div>
                <div class="timeline-container" id="timeline"></div>
            </div>
        </div>
    </div>

    <div id="screen-cuesheet" class="screen">
        <div class="app-header"><div class="header-title">Cueシート</div><div class="header-avatar" id="headerIconCue"></div></div>
        <div class="scroll-content"><div id="cuesheetBandListContainer"><div style="padding: 10px 4px; font-size: 12px; color: #5f6368;">閲覧するバンドを選択</div><div id="cuesheetBandList"></div></div><div id="cuesheetDetailView" class="hidden"><div style="margin-bottom: 16px; display: flex; align-items: center; background: white; padding: 10px; border-radius: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);"><button onclick="closeCuesheetDetail()" style="background:#f1f3f4; border:none; padding:8px; border-radius:50%; margin-right:12px; cursor:pointer; display:flex; align-items:center; justify-content:center;"><span class="material-icons" style="font-size:20px; color:#5f6368;">arrow_back</span></button><div><div style="font-size:10px; color:#5f6368;">Selected Band</div><div id="cuesheetTargetBandName" style="font-weight:bold; font-size:16px;">Band Name</div></div></div><div id="cuesheetContainer" style="display:flex; flex-direction:column; align-items:center; min-height: 100%;"><div id="cuesheetLoading" style="margin-top:50px; color:#5f6368; display:none;">読み込み中...</div><div id="cuesheetContent" class="hidden" style="width:100%; box-sizing:border-box;"><img id="cuesheetImage" src="" referrerpolicy="no-referrer" style="width:100%; height:auto; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1);" onclick="window.open(this.src, '_blank')"></div><div id="cuesheetEmpty" class="hidden" style="margin-top:50px; text-align:center; color:#5f6368;">Cueシートはまだありません</div></div></div></div>
    </div>

    <div id="screen-admin" class="screen">
        <div class="app-header"><div class="header-title">管理者メニュー</div><div class="header-avatar" id="headerIconAdmin"></div></div>
        <div class="scroll-content">
            <div class="menu-list">
                <button class="menu-btn" onclick="openAdminFeesMenu()"><div class="menu-icon-wrapper icon-admin-fee"><span class="material-icons">attach_money</span></div><div class="menu-content"><span class="menu-title">部費の管理</span></div></button>
                <button class="menu-btn" onclick="openAdminSettings()"><div class="menu-icon-wrapper icon-admin-cal"><span class="material-icons">edit_calendar</span></div><div class="menu-content"><span class="menu-title">予約システム管理</span></div></button>
                <button class="menu-btn" onclick="openAdminUsers()"><div class="menu-icon-wrapper icon-admin-user"><span class="material-icons">manage_accounts</span></div><div class="menu-content"><span class="menu-title">個人の管理</span></div></button>
                <button class="menu-btn" onclick="openAdminBands()"><div class="menu-icon-wrapper icon-admin-band"><span class="material-icons">groups</span></div><div class="menu-content"><span class="menu-title">バンドの管理</span></div></button>
            </div>
        </div>
    </div>

    <!-- ナビ -->
    <div class="bottom-nav"><div class="nav-item active" onclick="switchScreen('bands', this)"><span class="material-icons nav-icon">groups</span><span>マイバンド</span></div><div class="nav-item" onclick="switchScreen('calendar', this)"><span class="material-icons nav-icon">calendar_month</span><span>予約</span></div><div class="nav-item" onclick="switchScreen('cuesheet', this)"><span class="material-icons nav-icon">description</span><span>Cueシート</span></div><div class="nav-item hidden" id="nav-admin" onclick="switchScreen('admin', this)"><span class="material-icons nav-icon">admin_panel_settings</span><span>管理</span></div><div class="nav-item" onclick="goToMyPage()"><span class="material-icons nav-icon">account_circle</span><span>マイページ</span></div></div>

    <!-- モーダル -->
    <div id="modal-band" class="modal-overlay" onclick="if(event.target===this) closeModal('modal-band')">
        <div class="modal-content">
            <h3>バンド結成</h3>
            <div class="image-picker-area"><div class="image-picker" onclick="document.getElementById('bandIconInput').click()"><i class="material-icons">add_a_photo</i><img id="previewBandIcon" class="hidden" src=""></div><input type="file" id="bandIconInput" accept="image/*" hidden onchange="handleImageSelect(this, 'previewBandIcon')"></div>
            <div class="form-group"><label class="form-label">バンド名</label><input type="text" id="inputBandName" class="form-input"></div>
            <div class="form-group"><label class="form-label">メンバーを検索</label><input type="text" id="bandMemberSearchInput" class="form-input"></div>
            <div class="form-group"><div class="member-select-list" id="userSelectList"></div></div>
            <button class="btn-primary" onclick="saveBand()">作成する</button><button class="btn-secondary" onclick="closeModal('modal-band')">閉じる</button>
        </div>
    </div>

    <div id="modal-band-detail" class="modal-overlay" onclick="if(event.target===this) closeModal('modal-band-detail')">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;"><button class="material-icons" onclick="closeModal('modal-band-detail')" style="border:none; background:none;">close</button><h3 style="margin:0;">バンド詳細</h3><button class="btn-outline" id="btnInviteInModal">招待</button></div>
            <div style="text-align:center; margin-bottom:24px;">
                <div style="position:relative; display:inline-block;"><img id="detailBandIcon" src="" style="width:100px; height:100px; border-radius:50%; object-fit:cover; border:4px solid white; box-shadow:0 4px 12px rgba(0,0,0,0.1); background:#eee;"><button id="detailIconPicker" style="position:absolute; bottom:0; right:0; background:#0b57d0; color:white; border:none; width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center;"><span class="material-icons" style="font-size:18px;">photo_camera</span></button></div>
                <input type="file" id="editBandIconInput" accept="image/*" hidden onchange="handleImageEdit(this)">
                <div id="detailBandNameDisplay" style="font-size:22px; font-weight:bold; margin-top:12px;">Band Name</div><input type="text" id="detailBandName" class="form-input hidden" style="text-align:center;">
                <input type="hidden" id="detailBandId">
            </div>
            <div style="background:#f8f9fa; border-radius:16px; padding:16px; margin-bottom:16px;"><div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;"><label class="form-label" style="margin:0;">メンバー</label><button id="btnAddMemberToBand" class="btn-outline hidden" onclick="openAddMemberModal()">追加</button></div><div id="detailMemberList"></div></div>
            <div style="background:#f8f9fa; border-radius:16px; padding:16px; margin-bottom:16px;"><label class="form-label">出演履歴</label><div id="detailPerformanceList" style="font-size:12px; color:#999; text-align:center;">履歴なし</div></div>
            <div id="adminBandBookingsArea" style="background:#f8f9fa; border-radius:16px; padding:16px; margin-bottom:24px;"><label class="form-label">予約・合わせ履歴</label><div id="adminBandBookingsList" style="max-height:150px; overflow-y:auto; font-size:12px;">中...</div></div>
            <div id="bandCreatorActions" class="hidden"><button class="btn-primary" onclick="toggleBandNameEdit()" id="btnEditName" style="margin-bottom:10px;">名前変更</button><button class="btn-primary hidden" onclick="updateBandName()" id="btnSaveName" style="margin-bottom:10px;">保存</button><div style="display:flex; gap:10px;"><button id="btnArchive" class="btn-secondary" onclick="archiveBand()" style="flex:1;">アーカイブ</button><button id="btnRestore" class="btn-primary hidden" onclick="restoreBand()" style="flex:1;">復元</button><button class="btn-danger" onclick="deleteBand()" style="flex:1;">解散</button></div></div>
            <div id="bandMemberActions" class="hidden"><button class="btn-danger" onclick="leaveBand()">脱退</button></div>
        </div>
    </div>

    <div id="modal-add-member" class="modal-overlay" onclick="if(event.target===this) closeModal('modal-add-member')"><div class="modal-content"><h3>追加</h3><div class="form-group"><div class="member-select-list" id="addMemberSelectList"></div></div><button class="btn-primary" onclick="saveAddedMembers()">追加する</button><button class="btn-secondary" onclick="closeModal('modal-add-member')">閉じる</button></div></div>
    <div id="modal-booking" class="modal-overlay" onclick="if(event.target===this) closeModal('modal-booking')"><div class="modal-content"><h3>予約確認</h3><input type="hidden" id="editingBookingId"><div class="form-group"><label class="form-label">日付</label><div id="bookingDateDisplay" style="font-weight:bold;"></div></div><div class="form-group"><label class="checkbox-label"><input type="checkbox" id="checkAllDay" onchange="toggleAllDay()"> 終日 (9:00-20:00)</label></div><div class="form-group" id="timeSelectArea" style="display:flex; gap:10px; align-items:center;"><div style="flex:1;"><select id="selectStartTime" class="form-input"></select></div><span>〜</span><div style="flex:1;"><select id="selectEndTime" class="form-input"></select></div></div><div id="bookingTypeSelector" class="form-group hidden"><div class="radio-group"><label class="radio-label"><input type="radio" name="bookingType" value="normal" checked onchange="toggleBookingInputs()">練習</label><label class="radio-label"><input type="radio" name="bookingType" value="event" onchange="toggleBookingInputs()">イベント</label></div></div><div id="groupBandSelect" class="form-group"><label class="form-label">バンド</label><select id="selectBookingBand" class="form-input"></select></div><div id="groupEventTitle" class="form-group hidden"><label class="form-label">名前</label><input type="text" id="inputEventTitle" class="form-input"></div><button class="btn-primary" onclick="saveBooking()">保存</button><button id="btnDeleteBooking" class="btn-danger hidden" onclick="deleteBooking()">削除</button><button class="btn-secondary" onclick="closeModal('modal-booking')">戻る</button></div></div>
    <div id="modal-user-status" class="modal-overlay" onclick="if(event.target===this) closeModal('modal-user-status')"><div class="modal-content"><h3>マイステータス</h3><div class="user-status-card"><img id="modalUserIcon" src="" class="user-status-icon"><div id="modalUserName" class="user-status-name"></div><div style="background:#f9f9f9; padding:15px; border-radius:12px;"><div id="statusFeeYear">部費</div><div class="fee-status-row"><div id="statusFeeTerm1" class="fee-status-badge">前期</div><div id="statusFeeTerm2" class="fee-status-badge">後期</div></div></div><div id="myQRCodeArea" style="margin-top:20px;"><span class="material-icons">qr_code_2</span></div></div><button class="btn-secondary" onclick="closeModal('modal-user-status')">閉じる</button></div></div>
    <div id="modal-event-list" class="modal-overlay" onclick="if(event.target===this) closeModal('modal-event-list')"><div class="modal-content"><h3>予約一覧</h3><div id="eventListContainer" style="max-height:400px; overflow-y:auto;"></div><button class="btn-secondary" onclick="closeModal('modal-event-list')">閉じる</button></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, setDoc, updateDoc, deleteDoc, query, where, orderBy, onSnapshot, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        const firebaseConfig = { apiKey: "AIzaSyAWtITnn5uMOPBgOY0Bd7Rt5IN1ry8XoJI", authDomain: "urakata-app.firebaseapp.com", projectId: "urakata-app", storageBucket: "urakata-app.firebasestorage.app", messagingSenderId: "407777765696", appId: "1:407777765696:web:045c2d94729022b4eab2a5", measurementId: "G-9ZRMD26XNJ" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app);
        const MY_LIFF_ID = "2008162165-vVODNp12", MY_PAGE_URL = "https://liff.line.me/2008162165-znd24peg";
        let currentUser=null, currentProfile=null, currentUserData=null, displayDate=new Date(), calendarMode='month', isSelecting=false, selectionTimer=null, editingBookingData=null;
        let myBandsAll=[], currentBandTab='active', currentEditingBandId=null, currentEditingBandMembers=[], tempBandIconBlob=null, allUsersCache=[], adminEditingUserId=null, allBandsCache=[], tempLotterySchedule=null;
        let currentSystemSettings={ bookingMode:'first_come', lotteryConfig:{ mode:'auto', daysBefore:2, time:0 } }, currentFeeSettings={ year:new Date().getFullYear(), term1_amount:0, term2_amount:0 };
        function getNameById(uid){ const u=allUsersCache.find(x=>x.id===uid); return u?u.name:"不明"; }
        window.openUserStatusModal=async()=>{ if(!currentUserData)return; if(!currentFeeSettings.year){ try{ const snap=await getDoc(doc(db,"system","fees")); if(snap.exists())currentFeeSettings=snap.data(); else currentFeeSettings={year:new Date().getFullYear(),term1_amount:0,term2_amount:0}; }catch(e){console.error(e)} } const year=currentFeeSettings.year||new Date().getFullYear(), status=currentUserData.feeStatus||{}; document.getElementById('modalUserIcon').src=currentUserData.icon||'https://ul.h3z.jp/Vnukmtvq.jpg'; document.getElementById('modalUserName').innerText=currentUserData.name+" さん"; const isP1=!!status[`${year}_1`], isP2=!!status[`${year}_2`]; document.getElementById('statusFeeTerm1').innerText=`前期: ${isP1?'済':'未納'}`; document.getElementById('statusFeeTerm1').className=`fee-status-badge ${isP1?'fee-paid':'fee-unpaid'}`; document.getElementById('statusFeeTerm2').innerText=`後期: ${isP2?'済':'未納'}`; document.getElementById('statusFeeTerm2').className=`fee-status-badge ${isP2?'fee-paid':'fee-unpaid'}`; document.getElementById('statusFeeYear').innerText=`${year}年度 部費状況`; if(currentUser){ const qrUrl=`https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${currentUser}`; document.getElementById('myQRCodeArea').innerHTML=`<img src="${qrUrl}" style="width:100%;height:100%;">`; } openModal('modal-user-status'); };
        window.openAdminFeesMenu=()=>openPage('admin-fees-menu');
        window.openAdminFeeHistory=async()=>{ openPage('admin-fees-history'); const ys=document.getElementById('scanFeeYear'); ys.innerHTML=""; const cy=new Date().getFullYear(); [cy-1,cy,cy+1].forEach(y=>{ const op=document.createElement('option'); op.value=y; op.text=`${y}年度`; if(y===cy)op.selected=true; ys.appendChild(op); }); await refreshAllUsersCache(); };
        window.openAdminFeeSettings=async()=>{ openPage('admin-fees-settings'); try{ const snap=await getDoc(doc(db,"system","fees")); currentFeeSettings=snap.exists()?snap.data():{year:new Date().getFullYear(),term1_amount:0,term2_amount:0}; document.getElementById('feeSettingYear').value=currentFeeSettings.year; document.getElementById('feeSettingTerm1').value=currentFeeSettings.term1_amount; document.getElementById('feeSettingTerm2').value=currentFeeSettings.term2_amount; loadFeeSummary(); }catch(e){console.error(e)} };
        async function refreshAllUsersCache(){ const qs=await getDocs(collection(db,"users")); allUsersCache=[]; qs.forEach(doc=>allUsersCache.push({id:doc.id,...doc.data()})); }
        async function loadFeeSummary(){ if(allUsersCache.length===0)await refreshAllUsersCache(); const year=currentFeeSettings.year||new Date().getFullYear(), t1=parseInt(currentFeeSettings.term1_amount)||0, t2=parseInt(currentFeeSettings.term2_amount)||0, k1=`${year}_1`, k2=`${year}_2`; let c1=0, c2=0, tu=allUsersCache.length; allUsersCache.forEach(u=>{ if(u.feeStatus){if(u.feeStatus[k1])c1++; if(u.feeStatus[k2])c2++;} }); const s1=c1*t1, s2=c2*t2, total=s1+s2; let maxT=(t1>0?tu*t1:0)+(t2>0?tu*t2:0); let pct=(maxT>0)?Math.round((total/maxT)*100):0; document.getElementById('feeTotalAmount').innerText=total.toLocaleString(); document.getElementById('feeTotalTerm1').innerText='¥'+s1.toLocaleString(); document.getElementById('feeCountTerm1').innerText=`(${c1}/${tu}人)`; document.getElementById('feeTotalTerm2').innerText='¥'+s2.toLocaleString(); document.getElementById('feeCountTerm2').innerText=`(${c2}/${tu}人)`; document.getElementById('feeProgressPercent').innerText=`${pct}%`; document.getElementById('feeProgressChart').style.background=`conic-gradient(rgba(255,255,255,0.9) 0% ${pct}%, rgba(255,255,255,0.2) ${pct}% 100%)`; }
        window.saveFeeSettings=async()=>{ const y=parseInt(document.getElementById('feeSettingYear').value), t1=parseInt(document.getElementById('feeSettingTerm1').value), t2=parseInt(document.getElementById('feeSettingTerm2').value); try{ await setDoc(doc(db,"system","fees"),{year:y,term1_amount:t1||0,term2_amount:t2||0,updatedAt:serverTimestamp()},{merge:true}); currentFeeSettings={year:y,term1_amount:t1,term2_amount:t2}; alert("保存完了"); loadFeeSummary(); }catch(e){alert(e.message)} };
        window.openAdminFeeList=async()=>{ openPage('admin-fees-list'); await getDoc(doc(db,"system","fees")).then(snap=>{if(snap.exists())currentFeeSettings=snap.data()}); document.getElementById('feeListYearLabel').innerText=currentFeeSettings.year; loadFeeUserList(); };
        async function loadFeeUserList(){ try{ const q=query(collection(db,"users"),orderBy("studentId","asc")), qs=await getDocs(q); allUsersCache=[]; qs.forEach(doc=>allUsersCache.push({id:doc.id,...doc.data()})); renderFeeUserList(allUsersCache); }catch(e){alert(e.message)} }
        function renderFeeUserList(users){ const c=document.getElementById('feeUserList'); c.innerHTML=""; if(users.length===0){c.innerHTML='なし'; return;} const ty=currentFeeSettings.year, k1=`${ty}_1`, k2=`${ty}_2`; users.forEach(u=>{ const s=u.feeStatus||{}, div=document.createElement('div'); div.className='fee-user-item'; div.innerHTML=`<div><b>${u.name}</b><br><small>${u.studentId||'-'}</small></div><div class="fee-check-group"><div class="fee-checkbox ${s[k1]?'checked':''}" onclick="toggleFeeStatus('${u.id}','${k1}',this)">前期</div><div class="fee-checkbox ${s[k2]?'checked':''}" onclick="toggleFeeStatus('${u.id}','${k2}',this)">後期</div></div>`; c.appendChild(div); }); }
        window.toggleFeeStatus=async(uid,key,element)=>{ const ok=element.classList.contains('checked'); ok?element.classList.remove('checked'):element.classList.add('checked'); try{ await updateDoc(doc(db,"users",uid),{[`feeStatus.${key}`]:!ok}); const u=allUsersCache.find(x=>x.id===uid); if(u){u.feeStatus=u.feeStatus||{}; u.feeStatus[key]=!ok;} }catch(e){alert(e.message)} };
        let videoStream=null, isScanning=false, scanLock=false;
        window.startQRScanner=async()=>{ const v=document.getElementById('camera-video'), ra=document.getElementById('scan-result-area'), ba=document.getElementById('scan-start-btn-area'); document.getElementById('video-container').style.display='block'; ba.style.display='none'; ra.style.display='none'; try{ videoStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}); v.srcObject=videoStream; v.setAttribute("playsinline",true); v.play(); isScanning=true; requestAnimationFrame(scanLoop); }catch(e){alert("カメラ失敗"); window.stopQRScanner();} };
        window.stopQRScanner=()=>{ isScanning=false; if(videoStream){videoStream.getTracks().forEach(t=>t.stop()); videoStream=null;} document.getElementById('video-container').style.display='none'; document.getElementById('scan-start-btn-area').style.display='block'; };
        function scanLoop(){ if(!isScanning)return; const v=document.getElementById('camera-video'), cv=document.getElementById('qr-canvas'), ctx=cv.getContext('2d'); if(v.readyState===v.HAVE_ENOUGH_DATA){ cv.height=v.videoHeight; cv.width=v.videoWidth; ctx.drawImage(v,0,0,cv.width,cv.height); const code=jsQR(ctx.getImageData(0,0,cv.width,cv.height).data,cv.width,cv.height,{inversionAttempts:"dontInvert"}); if(code&&!scanLock)handleScanSuccess(code.data); } requestAnimationFrame(scanLoop); }
        async function handleScanSuccess(data){ scanLock=true; const target=allUsersCache.find(u=>u.id===data), ra=document.getElementById('scan-result-area'), ns=document.getElementById('scannedUserName'); ra.style.display='block'; if(target){ ns.innerText=target.name; const y=document.getElementById('scanFeeYear').value, t=document.getElementById('scanFeeTerm').value, k=`${y}_${t}`; try{ await updateDoc(doc(db,"users",data),{[`feeStatus.${k}`]:true}); if(!target.feeStatus)target.feeStatus={}; target.feeStatus[k]=true; if(navigator.vibrate)navigator.vibrate([100,50,100]); }catch(e){alert(e.message)} }else{ ns.innerText="未登録"; if(navigator.vibrate)navigator.vibrate(50); } setTimeout(()=>{scanLock=false; ra.style.display='none';},2000); }
        window.openAdminSettings=async()=>{ openPage('admin-calendar-stub'); try{ const snap=await getDoc(doc(db,"system","settings")); if(snap.exists())currentSystemSettings=snap.data(); const mode=currentSystemSettings.bookingMode||'first_come'; document.getElementsByName('adminBookingMode').forEach(r=>{if(r.value===mode)r.checked=true}); if(currentSystemSettings.lotteryConfig){ const lc=currentSystemSettings.lotteryConfig; document.getElementsByName('lotteryExecMode').forEach(r=>{if(r.value===(lc.mode||'auto'))r.checked=true}); document.getElementById('lotteryAutoDays').value=lc.daysBefore||2; document.getElementById('lotteryAutoTime').value=lc.time||0; } toggleLotterySettings(); }catch(e){console.error(e)} };
        window.toggleLotterySettings=()=>{ const isL=document.querySelector('input[name="adminBookingMode"][value="lottery"]').checked, area=document.getElementById('lotterySettingsArea'); isL?area.classList.remove('hidden'):area.classList.add('hidden'); if(isL)toggleLotteryExecUI(); };
        window.toggleLotteryExecUI=()=>{ const mode=document.querySelector('input[name="lotteryExecMode"]:checked').value, ac=document.getElementById('lotteryAutoConfig'), mc=document.getElementById('lotteryManualConfig'); if(mode==='auto'){ac.classList.remove('hidden'); mc.classList.add('hidden');} else {ac.classList.add('hidden'); mc.classList.remove('hidden');} };
        window.runManualLottery=async()=>{ const dv=document.getElementById('manualLotteryDate').value; if(!dv||!confirm("実行？"))return; const lb=document.getElementById('lotteryLog'); lb.innerHTML='中...'; lb.classList.remove('hidden'); try{ const q=query(collection(db,"bookings"),where("startTime",">=",new Date(dv).setHours(0,0,0,0)),where("startTime","<=",new Date(dv).setHours(23,59,59,999))); const snap=await getDocs(q); let candidates=[], locked=[]; snap.forEach(d=>{ const v=d.data(); if(v.status==='pending')candidates.push({id:d.id,...v}); else locked.push({start:v.startTime.toDate(),end:v.endTime.toDate()}); }); if(!candidates.length)return; const bandReqs={}; candidates.forEach(c=>{ if(!bandReqs[c.bandId])bandReqs[c.bandId]={id:c.bandId,name:c.bandName,requests:[],docIds:[]}; bandReqs[c.bandId].requests.push({start:c.startTime.toDate(),end:c.endTime.toDate()}); bandReqs[c.bandId].docIds.push(c.id); }); let sched=attemptSchedule(Object.values(bandReqs),60,locked); if(sched.successCount<Object.keys(bandReqs).length)sched=attemptSchedule(Object.values(bandReqs),30,locked); else sched=extendSchedule(sched,Object.values(bandReqs),90); lb.innerHTML='結果'; sched.assignments.forEach(a=>lb.innerHTML+=`<div class="log-success">${a.bandName}: ${a.start.getHours()}:${a.start.getMinutes()}</div>`); tempLotterySchedule=sched; document.getElementById('btnApplyLottery').classList.remove('hidden'); }catch(e){alert(e.message)} };
        function attemptSchedule(bands,dur,locked){ const TM=(20-9)*60, timeline=new Array(TM).fill(null); if(locked)locked.forEach(l=>{ const s=(l.start.getHours()-9)*60+l.start.getMinutes(), e=(l.end.getHours()-9)*60+l.end.getMinutes(); for(let t=Math.max(0,s);t<Math.min(TM,e);t++)timeline[t]="LOCKED"; }); const sb=[...bands].sort(()=>Math.random()-0.5), assign=[], failed=[]; sb.forEach(b=>{ let ok=false; const reqs=[...b.requests].sort(()=>Math.random()-0.5); for(let r of reqs){ if(ok)break; const s=(r.start.getHours()-9)*60+r.start.getMinutes(), e=(r.end.getHours()-9)*60+r.end.getMinutes(); for(let t=s;t<=e-dur;t+=30){ let free=true; for(let k=0;k<dur;k++){if(t+k>=TM||timeline[t+k]!==null){free=false; break;}} if(free){ for(let k=0;k<dur;k++)timeline[t+k]=b.name; const st=new Date(r.start); st.setHours(9+Math.floor(t/60),t%60,0,0); const et=new Date(st); et.setMinutes(st.getMinutes()+dur); assign.push({bandId:b.id,bandName:b.name,start:st,end:et,originalDocIds:b.docIds}); ok=true; break; } } } if(!ok)failed.push(b); }); return {assignments:assign,failedBands:failed,successCount:assign.length,timeline}; }
        function extendSchedule(base,bands,target){ const assign=base.assignments, timeline=base.timeline, extra=target-60; [...assign].sort(()=>Math.random()-0.5).forEach(a=>{ const cem=(a.end.getHours()-9)*60+a.end.getMinutes(); let can=true; for(let k=0;k<extra;k++){if(cem+k>=timeline.length||timeline[cem+k]!==null){can=false; break;}} if(can){ const b=bands.find(x=>x.name===a.bandName), net=new Date(a.end); net.setMinutes(net.getMinutes()+extra); let ir=false; for(let r of b.requests){if(r.start<=a.start&&r.end>=net){ir=true; break;}} if(!ir)can=false; } if(can){ for(let k=0;k<extra;k++)timeline[cem+k]=a.bandName; a.end.setMinutes(a.end.getMinutes()+extra); } }); return base; }
        window.applyLotteryResults=async()=>{ if(!tempLotterySchedule||!confirm("反映？"))return; const batch=writeBatch(db); tempLotterySchedule.assignments.forEach(a=>{ batch.set(doc(collection(db,"bookings")),{bandId:a.bandId,bandName:a.bandName,creatorId:currentUser,userName:"抽選確定",startTime:a.start,endTime:a.end,type:'normal',status:'confirmed',source:'lottery',createdAt:new Date()}); a.originalDocIds.forEach(id=>batch.delete(doc(db,"bookings",id))); }); try{await batch.commit(); alert("反映完了"); closePage('admin-calendar-stub');}catch(e){alert(e.message)} };
        window.saveSystemSettings=async()=>{ const mode=document.querySelector('input[name="adminBookingMode"]:checked').value, emode=document.querySelector('input[name="lotteryExecMode"]:checked').value, days=parseInt(document.getElementById('lotteryAutoDays').value), time=parseInt(document.getElementById('lotteryAutoTime').value); try{ await setDoc(doc(db,"system","settings"),{bookingMode:mode,lotteryConfig:{mode:emode,daysBefore:days,time:time},updatedAt:serverTimestamp(),updatedBy:currentUser},{merge:true}); alert("完了"); closePage('admin-calendar-stub'); }catch(e){alert(e.message)} };
        async function loadSystemConfig(){ try{ const snap=await getDoc(doc(db,"system","settings")); if(snap.exists())currentSystemSettings=snap.data(); }catch(e){} }
        window.switchScreen=(id,nav)=>{ document.querySelectorAll('.screen').forEach(el=>el.classList.remove('active')); document.getElementById('screen-'+id).classList.add('active'); document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active')); nav.classList.add('active'); if(id==='calendar'){calendarMode='month'; updateViewMenuUI(); renderCalendar();} if(id==='cuesheet'){closeCuesheetDetail(); renderCuesheetBandList();} };
        window.goToMyPage=()=>window.location.href=MY_PAGE_URL;
        window.openPage=(id)=>document.getElementById('page-'+id).classList.add('open');
        window.closePage=(id)=>document.getElementById('page-'+id).classList.remove('open');
        window.openModal=(id)=>document.getElementById(id).classList.add('open');
        window.closeModal=(id)=>document.getElementById(id).classList.remove('open');
        window.openAdminUsers=async()=>{ openPage('admin-users'); try{ const q=query(collection(db,"users"),orderBy("createdAt","desc")), qs=await getDocs(q); allUsersCache=[]; qs.forEach(d=>{ const v=d.data(); v.affiliations=v.affiliations||(v.org?[v.org]:[]); allUsersCache.push({id:d.id,...v}); }); renderAdminList(allUsersCache); }catch(e){alert(e.message)} };
        window.sortUsers=(t)=>{ if(t==='year')allUsersCache.sort((a,b)=>(a.year||99)-(b.year||99)); else if(t==='kana')allUsersCache.sort((a,b)=>(a.kana||"").localeCompare(b.kana||"","ja")); renderAdminList(allUsersCache); };
        function renderAdminList(users){ const c=document.getElementById('adminUserList'); c.innerHTML=""; users.forEach(u=>{ const div=document.createElement('div'); div.className='user-list-item'; div.onclick=()=>openAdminEdit(u); let kHtml=u.kana?`<div style="font-size:9px; color:#888;">${u.kana}</div>`:''; div.innerHTML=`<img src="${u.icon||'https://ul.h3z.jp/Vnukmtvq.jpg'}" class="mini-icon"><div class="user-info-main">${kHtml}<b>${u.name}</b><br><small>${u.year||'-'}年</small></div><span class="material-icons">chevron_right</span>`; c.appendChild(div); }); }
        document.getElementById('adminSearchInput').addEventListener('input',(e)=>{ const t=e.target.value.trim(); renderAdminList(t?allUsersCache.filter(u=>u.name.includes(t)||u.kana?.includes(t)):allUsersCache); });
        function openAdminEdit(u){ adminEditingUserId=u.id; openPage('admin-edit'); document.getElementById('admin-user-icon').src=u.icon||"https://ul.h3z.jp/Vnukmtvq.jpg"; document.getElementById('admin-edit-docId').innerText=u.id; document.getElementById('admin-show-name').innerText=u.name; document.getElementById('admin-show-kana').innerText=u.kana||"-"; document.getElementById('admin-show-studentId').innerText=u.studentId||"-"; document.getElementById('admin-show-year').innerText=(u.year||"-")+"年"; document.getElementById('admin-show-aff').innerText=(u.affiliations.includes('urakata')?"裏方 ":"")+(u.affiliations.includes('lmc')?"LMC":""); document.getElementById('admin-show-part').innerText=getPartLabel(u.part)||"-"; document.getElementById('admin-edit-role').value=u.role||""; loadAdminUserBands(u.id); }
        async function loadAdminUserBands(uid){ const c=document.getElementById('admin-user-band-list'); try{ const q=query(collection(db,"bands"),where("memberIds","array-contains",uid)), qs=await getDocs(q); if(qs.empty)c.innerHTML="なし"; else { let h="<ul>"; qs.forEach(d=>h+=`<li>${d.data().name}</li>`); h+="</ul>"; c.innerHTML=h; } }catch(e){c.innerHTML="エラー"} }
        document.getElementById('btn-save-user-role').addEventListener('click',async()=>{ if(!adminEditingUserId)return; try{await updateDoc(doc(db,"users",adminEditingUserId),{role:document.getElementById('admin-edit-role').value}); alert("保存完了"); closePage('admin-edit');}catch(e){alert(e.message)} });
        window.openAdminBands=async()=>{ openPage('admin-bands'); try{ const qs=await getDocs(collection(db,"bands")); allBandsCache=[]; qs.forEach(d=>allBandsCache.push({id:d.id,...d.data()})); allBandsCache.sort((a,b)=>(b.createdAt?.toDate()||0)-(a.createdAt?.toDate()||0)); renderAdminBandList(allBandsCache); }catch(e){alert(e.message)} };
        function renderAdminBandList(bands){ const c=document.getElementById('adminBandList'); c.innerHTML=""; bands.forEach(b=>{ const div=document.createElement('div'); div.className='card band-card'; div.onclick=()=>openBandDetail(b.id,b); const names=b.memberIds.map(id=>getNameById(id)).join(', '); div.innerHTML=`<div style="display:flex; align-items:center;"><img src="${b.icon||'https://ul.h3z.jp/Vnukmtvq.jpg'}" style="width:40px; height:40px; border-radius:8px; margin-right:12px;"><div><b>${b.name}</b><br><small>${names}</small></div></div>`; c.appendChild(div); }); }
        async function loadBandBookings(bid){ const list=document.getElementById('adminBandBookingsList'); if(!list)return; try{ const qs=await getDocs(query(collection(db,"bookings"),where("bandId","==",bid))); if(qs.empty){list.innerHTML="なし";return;} const bks=[]; qs.forEach(d=>bks.push(d.data())); bks.sort((a,b)=>b.startTime.toDate()-a.startTime.toDate()); let h=""; bks.forEach(bk=>{ const d=bk.startTime.toDate(), ds=`${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`; h+=`<div>${ds} ${bk.status==='confirmed'?'確定':'待ち'}</div>`; }); list.innerHTML=h; }catch(e){list.innerHTML=e.message} }
        async function main(){ try{ try{ if(typeof __initial_auth_token!=='undefined'&&__initial_auth_token)await signInWithCustomToken(auth,__initial_auth_token); else await signInAnonymously(auth); }catch(ae){} await liff.init({liffId:MY_LIFF_ID}); if(!liff.isLoggedIn()){liff.login();return;} const pr=await liff.getProfile(); currentUser=pr.userId; currentProfile=pr; const uRef=doc(db,"users",currentUser), snap=await getDoc(uRef); if(!snap.exists()){window.location.href=MY_PAGE_URL;return;} await setDoc(uRef,{lastLogin:serverTimestamp()},{merge:true}); currentUserData=snap.data(); renderHeaderIcons(currentUserData); await refreshAllUsersCache(); await loadSystemConfig(); const up=new URLSearchParams(window.location.search), tp=up.get('page'); if(tp){ const idx=(tp==='calendar')?2:(tp==='cuesheet')?3:1, nav=document.querySelector(`.nav-item:nth-child(${idx})`); if(nav)switchScreen(tp,nav); } loadMyBands(); }catch(e){console.error(e)} }
        function renderCuesheetBandList(){ const c=document.getElementById('cuesheetBandList'); if(!c)return; c.innerHTML=""; const active=myBandsAll.filter(b=>!b.isArchived); if(!active.length){c.innerHTML='なし';return;} active.forEach(b=>{ const div=document.createElement('div'); div.className='card band-card'; div.onclick=()=>openCuesheetDetail(b); div.innerHTML=`<div style="display:flex; align-items:center;"><img src="${b.icon||'https://ul.h3z.jp/Vnukmtvq.jpg'}" style="width:40px;height:40px;border-radius:8px;margin-right:12px;"><b>${b.name}</b></div>`; c.appendChild(div); }); }
        window.openCuesheetDetail=(b)=>{ document.getElementById('cuesheetBandListContainer').classList.add('hidden'); document.getElementById('cuesheetDetailView').classList.remove('hidden'); document.getElementById('cuesheetTargetBandName').innerText=b.name; loadBandCuesheetData(b.id); };
        window.closeCuesheetDetail=()=>{ document.getElementById('cuesheetDetailView').classList.add('hidden'); document.getElementById('cuesheetBandListContainer').classList.remove('hidden'); if(currentCuesheetUnsub){currentCuesheetUnsub();currentCuesheetUnsub=null;} };
        let currentCuesheetUnsub=null; function loadBandCuesheetData(bid){ if(currentCuesheetUnsub)currentCuesheetUnsub(); currentCuesheetUnsub=onSnapshot(doc(db,"bands",bid),(ds)=>{ if(ds.exists()){ const v=ds.data(); if(v.latestCuesheetUrl){document.getElementById('cuesheetImage').src=v.latestCuesheetUrl; document.getElementById('cuesheetContent').classList.remove('hidden');} } }); }
        function loadMyBands(){ onSnapshot(query(collection(db,"bands"),where("memberIds","array-contains",currentUser)),(snap)=>{ myBandsAll=[]; snap.forEach(d=>myBandsAll.push({id:d.id,...d.data()})); renderBandList(); if(document.getElementById('screen-cuesheet').classList.contains('active'))renderCuesheetBandList(); }); }
        window.switchBandTab=(t)=>{ currentBandTab=t; document.querySelectorAll('.band-tab').forEach((el,i)=>el.classList.toggle('active', (t==='active'&&i===0)||(t==='archived'&&i===1))); renderBandList(); };
        function renderBandList(){ const c=document.getElementById('bandListContainer'); c.innerHTML=""; const t=myBandsAll.filter(b=>(currentBandTab==='active')?!b.isArchived:b.isArchived); if(!t.length){c.innerHTML='なし';return;} t.forEach(b=>{ const div=document.createElement('div'); div.className='card band-card'; div.onclick=()=>openBandDetail(b.id,b); div.innerHTML=`<div style="display:flex; align-items:center;"><img src="${b.icon||'https://ul.h3z.jp/Vnukmtvq.jpg'}" style="width:48px;height:48px;border-radius:12px;margin-right:12px;"><b>${b.name}</b></div>`; c.appendChild(div); }); }
        async function uploadImageToExternal(blob){ const fd=new FormData(); fd.append('files',blob,'image.jpg'); try{ const res=await fetch('https://ul.h3z.jp/uploader-work/work.php',{method:'POST',body:fd}); const json=await res.json(); return json.files[0].url; }catch(e){throw new Error('アップロード失敗')} }
        window.openBandModal=()=>{ document.getElementById('inputBandName').value=""; document.getElementById('bandMemberSearchInput').value=""; loadUserList('userSelectList'); openModal('modal-band'); };
        window.saveBand=async()=>{ const name=document.getElementById('inputBandName').value.trim(); if(!name)return; const sel=document.querySelectorAll('#userSelectList .member-option.selected'), ids=[currentUser]; sel.forEach(el=>ids.push(el.dataset.uid)); try{ const ref=await addDoc(collection(db,"bands"),{name,memberIds:ids,creatorId:currentUser,isArchived:false,createdAt:new Date()}); if(tempBandIconBlob){const u=await uploadImageToExternal(tempBandIconBlob); await updateDoc(ref,{icon:u});} closeModal('modal-band'); alert("作成完了"); }catch(e){alert(e.message)} };
        window.shareBandInvite=async(bid,bn)=>{ const url=`https://liff.line.me/${MY_LIFF_ID}/?bandId=${bid}&action=invite`; if(liff.isApiAvailable('shareTargetPicker'))await liff.shareTargetPicker([{type:"flex",altText:bn+"への招待",contents:{type:"bubble",body:{type:"box",layout:"vertical",contents:[{type:"text",text:"🎸 招待",weight:"bold"},{type:"text",text:bn,size:"xl"}]},footer:{type:"box",layout:"vertical",contents:[{type:"button",action:{type:"uri",label:"参加",uri:url}}]}}}]); };
        async function handleInvite(bid){ try{ const snap=await getDoc(doc(db,"bands",bid)); if(!snap.exists()||snap.data().memberIds.includes(currentUser))return; if(confirm("参加？")){await updateDoc(doc(db,"bands",bid),{memberIds:arrayUnion(currentUser)}); alert("参加完了");} }catch(e){alert(e.message)} }
        window.openBandDetail=(bid,data)=>{
            document.getElementById('detailBandId').value=bid;
            document.getElementById('detailBandNameDisplay').innerText=data.name;
            document.getElementById('btnInviteInModal').onclick=()=>shareBandInvite(bid,data.name);
            currentEditingBandId=bid; currentEditingBandMembers=data.memberIds;
            const di=document.getElementById('detailBandIcon'), dp=document.getElementById('detailIconPicker');
            di.src=data.icon||'https://ul.h3z.jp/Vnukmtvq.jpg';
            const adm=currentUserData?.affiliations.includes('urakata')&&currentUserData.role, can=(data.creatorId===currentUser)||adm;
            dp.onclick=can?()=>document.getElementById('editBandIconInput').click():null;
            const ml=document.getElementById('detailMemberList'), bA=document.getElementById('btnArchive'), bR=document.getElementById('btnRestore'), bAdd=document.getElementById('btnAddMemberToBand');
            ml.innerHTML="";
            if(data.isArchived){if(bA)bA.classList.add('hidden'); if(bR)bR.classList.remove('hidden'); if(bAdd)bAdd.classList.add('hidden');}
            else {if(bA)bA.classList.remove('hidden'); if(bR)bR.classList.add('hidden'); if(can && bAdd)bAdd.classList.remove('hidden');}
            document.getElementById('bandCreatorActions').classList.toggle('hidden',!can);
            document.getElementById('bandMemberActions').classList.toggle('hidden',can);
            data.memberIds.forEach((uid)=>{
                const n = getNameById(uid), row=document.createElement('div');
                row.className='member-row';
                row.innerHTML=`<span>${n}</span>`+(can&&uid!==currentUser?`<button class="btn-remove-member" onclick="removeMember('${bid}','${uid}','${n}')">削除</button>`:(uid===data.creatorId?'<span style="font-size:10px; color:#0b57d0;">リーダー</span>':''));
                ml.appendChild(row);
            });
            loadBandBookings(bid);
            openModal('modal-band-detail');
        };
        window.toggleBandNameEdit=()=>{ const d=document.getElementById('detailBandNameDisplay'), i=document.getElementById('detailBandName'), be=document.getElementById('btnEditName'), bs=document.getElementById('btnSaveName'); d.classList.toggle('hidden'); i.classList.toggle('hidden'); be.classList.toggle('hidden'); bs.classList.toggle('hidden'); if(!i.classList.contains('hidden')){i.value=d.innerText; i.focus();} };
        window.archiveBand=async()=>{ const bid=document.getElementById('detailBandId').value; if(confirm("アーカイブ？")){await updateDoc(doc(db,"bands",bid),{isArchived:true}); closeModal('modal-band-detail');} };
        window.restoreBand=async()=>{ const bid=document.getElementById('detailBandId').value; if(confirm("復元？")){await updateDoc(doc(db,"bands",bid),{isArchived:false}); closeModal('modal-band-detail');} };
        window.updateBandName=async()=>{ const bid=document.getElementById('detailBandId').value, nn=document.getElementById('detailBandName').value.trim(); if(nn){await updateDoc(doc(db,"bands",bid),{name:nn}); closeModal('modal-band-detail');} };
        window.removeMember=async(bid,uid,n)=>{ if(confirm("削除？")){await updateDoc(doc(db,"bands",bid),{memberIds:arrayRemove(uid)}); closeModal('modal-band-detail');} };
        window.deleteBand=async()=>{ if(confirm("解散？")){await deleteDoc(doc(db,"bands",document.getElementById('detailBandId').value)); closeModal('modal-band-detail');} };
        window.leaveBand=async()=>{ if(confirm("脱退？")){await updateDoc(doc(db,"bands",document.getElementById('detailBandId').value),{memberIds:arrayRemove(currentUser)}); closeModal('modal-band-detail');} };
        window.openAddMemberModal=()=>{ loadUserList('addMemberSelectList',currentEditingBandMembers); openModal('modal-add-member'); };
        window.saveAddedMembers=async()=>{ const sel=document.querySelectorAll('#addMemberSelectList .member-option.selected'); if(!sel.length)return; const ids=[]; sel.forEach(el=>ids.push(el.dataset.uid)); await updateDoc(doc(db,"bands",currentEditingBandId),{memberIds:arrayUnion(...ids)}); closeModal('modal-add-member'); closeModal('modal-band-detail'); };
        window.handleImageSelect=(i,p)=>{ if(i.files?.[0]) compressImage(i.files[0]).then(b=>{tempBandIconBlob=b; const img=document.getElementById(p); img.src=URL.createObjectURL(b); img.classList.remove('hidden');}); };
        window.handleImageEdit=async(i)=>{ if(i.files?.[0]&&confirm("変更？")){ try{ const b=await compressImage(i.files[0]), bid=document.getElementById('detailBandId').value, u=await uploadImageToExternal(b); await updateDoc(doc(db,"bands",bid),{icon:u}); document.getElementById('detailBandIcon').src=u; }catch(e){alert(e.message)} } };
        const compressImage=(f)=>{ return new Promise((res,rej)=>{ const i=new Image(); i.src=URL.createObjectURL(f); i.onload=()=>{ const c=document.createElement('canvas'), ctx=c.getContext('2d'), s=200; c.width=s; c.height=s; let w=i.width, h=i.height, sx=0, sy=0; if(w>h){w=h; sx=(i.width-h)/2;} else {h=w; sy=(i.height-w)/2;} ctx.drawImage(i,sx,sy,w,h,0,0,s,s); c.toBlob(b=>res(b),'image/jpeg',0.8); }; }); };
        async function loadUserList(tid='userSelectList',ex=[]){ const list=document.getElementById(tid), qs=await getDocs(collection(db,"users")); list.innerHTML=""; qs.forEach(doc=>{ const u=doc.data(); if(doc.id===currentUser||ex.includes(doc.id))return; const div=document.createElement('div'); div.className='member-option'; div.dataset.uid=doc.id; div.dataset.uname=u.name; div.dataset.ukana=u.kana||""; div.onclick=()=>{div.classList.toggle('selected'); div.querySelector('.material-icons').innerText=div.classList.contains('selected')?'check_box':'check_box_outline_blank';}; div.innerHTML=`<span class="material-icons member-check">check_box_outline_blank</span><img src="${u.icon||'https://ul.h3z.jp/Vnukmtvq.jpg'}" style="width:32px; height:32px; border-radius:50%; margin-right:10px; object-fit:cover;"><div>${u.name} <small>${u.part?`(${getPartLabel(u.part)})`:''}</small></div>`; list.appendChild(div); }); }
        document.getElementById('bandMemberSearchInput')?.addEventListener('input',(e)=>{ const t=e.target.value.trim().toLowerCase(); document.querySelectorAll('#userSelectList .member-option').forEach(el=>{ const n=el.dataset.uname.toLowerCase(), k=el.dataset.ukana.toLowerCase(); el.style.display=(n.includes(t)||k.includes(t))?'flex':'none'; }); });
        function getPartLabel(p){ return {vocal:"Vo",guitar:"Gt",bass:"Ba",drums:"Dr",keyboard:"Key"}[p]||""; }
        window.toggleViewMenu=()=>document.getElementById('viewMenu').classList.toggle('open');
        window.switchCalendarView=(m)=>{ calendarMode=m; if(m==='day'){const t=new Date(); if(displayDate.getMonth()===t.getMonth()&&displayDate.getFullYear()===t.getFullYear())displayDate.setDate(t.getDate()); else displayDate.setDate(1);} updateViewMenuUI(); renderCalendar(); };
        function updateViewMenuUI(){ const isM=(calendarMode==='month'); document.getElementById('calMonthView').classList.toggle('hidden',!isM); document.getElementById('calDayView').classList.toggle('hidden',isM); const sw=document.getElementById('viewSwitcher'); if(sw)sw.classList.toggle('day-mode',!isM); document.querySelectorAll('.switcher-item').forEach(el=>el.classList.toggle('active',el.dataset.mode===calendarMode)); }
        window.changeDate=(d)=>{ if(calendarMode==='month')displayDate.setMonth(displayDate.getMonth()+d); else displayDate.setDate(displayDate.getDate()+d); renderCalendar(); };
        function renderCalendar(){ const y=displayDate.getFullYear(), m=displayDate.getMonth()+1; if(calendarMode==='month'){document.getElementById('calHeaderDate').innerText=`${y}年 ${m}月`; renderMonthView();} else {const d=displayDate.getDate(), w=['日','月','火','水','木','金','土'][displayDate.getDay()]; document.getElementById('calHeaderDate').innerText=`${m}月`; document.getElementById('dayViewDateLabel').innerText=`${m}/${d} (${w})`; renderDayView();} }
        function renderMonthView(){ const g=document.getElementById('monthGrid'); g.innerHTML=""; ['日','月','火','水','木','金','土'].forEach(wd=>{const div=document.createElement('div'); div.className='weekday-label'; if(wd==='日')div.classList.add('sun'); if(wd==='土')div.classList.add('sat'); div.innerText=wd; g.appendChild(div);}); const y=displayDate.getFullYear(), m=displayDate.getMonth(), fd=new Date(y,m,1), ld=new Date(y,m+1,0), today=new Date(); for(let i=0; i<fd.getDay(); i++)g.appendChild(document.createElement('div')); for(let d=1; d<=ld.getDate(); d++){ const div=document.createElement('div'); div.className='day-cell'; div.id=`day-${y}-${m+1}-${d}`; if(y===today.getFullYear()&&m===today.getMonth()&&d===today.getDate())div.classList.add('today'); div.onclick=()=>{displayDate.setDate(d); switchCalendarView('day');}; div.innerHTML=`<div class="day-num">${d}</div><div class="status-label"></div><div class="event-dots" id="dots-${y}-${m+1}-${d}"></div>`; g.appendChild(div); } loadMonthBookings(y,m); }
        function loadMonthBookings(y,m){ onSnapshot(query(collection(db,"bookings"),where("startTime",">=",new Date(y,m,1)),where("startTime","<=",new Date(y,m+1,0,23,59,59))),(qs)=>{ document.querySelectorAll('.event-dots').forEach(el=>el.innerHTML=""); document.querySelectorAll('.day-cell.unavailable').forEach(el=>{ el.classList.remove('unavailable'); const st=el.querySelector('.status-label'); if(st)st.innerText=""; }); qs.forEach(snap=>{ const d=snap.data().startTime.toDate(), cell=document.getElementById(`day-${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`); if(snap.data().type==='event' && cell){ cell.classList.add('unavailable'); const st=cell.querySelector('.status-label'); if(st)st.innerText="🚫不可"; } else if(cell) { const c=document.getElementById(`dots-${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`); if(c&&c.children.length<3){const dot=document.createElement('div'); dot.className='dot'; c.appendChild(dot);} } }); }); }
        function renderDayView(){ const banner=document.getElementById('bookingModeBanner'), mode=currentSystemSettings.bookingMode||'first_come'; if(mode==='lottery')banner.innerHTML=`抽選受付中`; else banner.innerHTML=`先着順モード`; const container=document.getElementById('timeline'); container.innerHTML=""; for(let h=9;h<20;h++){ const slot=document.createElement('div'); slot.className='time-slot'; slot.innerHTML=`<div class="time-label">${h}:00</div><div class="time-content" data-hour="${h}"></div>`; const content=slot.querySelector('.time-content'); content.addEventListener('touchstart',handleTouchStart,{passive:false}); content.addEventListener('touchmove',handleTouchMove,{passive:false}); content.addEventListener('touchend',handleTouchEnd); content.addEventListener('mousedown',handleMouseDown); container.appendChild(slot); } container.addEventListener('mousemove',handleMouseMove); container.addEventListener('mouseup',handleMouseUp); loadDayBookings(); }
        function handleTouchStart(e){ if(e.target.classList.contains('event-block'))return; const h=parseInt(e.target.dataset.hour); if(isNaN(h))return; selectionTimer=setTimeout(()=>{isSelecting=true; selectionStartHour=h; selectionEndHour=h; updateSelectionUI(); document.getElementById('selectionToast').classList.add('show'); if(navigator.vibrate)navigator.vibrate(50);},500); }
        function handleTouchMove(e){ if(!isSelecting){clearTimeout(selectionTimer);return;} e.preventDefault(); const t=document.elementFromPoint(e.touches[0].clientX,e.touches[0].clientY); if(t&&t.classList.contains('time-content')){selectionEndHour=parseInt(t.dataset.hour); updateSelectionUI();} }
        function handleTouchEnd(e){ clearTimeout(selectionTimer); if(isSelecting){isSelecting=false; document.getElementById('selectionToast').classList.remove('show'); openBookingModalRange();} }
        function handleMouseDown(e){ if(!e.target.classList.contains('time-content'))return; isSelecting=true; selectionStartHour=parseInt(e.target.dataset.hour); selectionEndHour=selectionStartHour; updateSelectionUI(); }
        function handleMouseMove(e){ if(isSelecting&&e.target.classList.contains('time-content')){selectionEndHour=parseInt(e.target.dataset.hour); updateSelectionUI();} }
        function handleMouseUp(){ if(isSelecting){isSelecting=false; openBookingModalRange();} }
        function updateSelectionUI(){ document.querySelectorAll('.time-content').forEach(el=>el.classList.remove('selecting')); if(selectionStartHour===null||selectionEndHour===null)return; const s=Math.min(selectionStartHour,selectionEndHour), e=Math.max(selectionStartHour,selectionEndHour); for(let h=s; h<=e; h++)document.querySelector(`.time-content[data-hour="${h}"]`)?.classList.add('selecting'); }
        window.toggleAllDay=()=>{ const isA=document.getElementById('checkAllDay').checked, area=document.getElementById('timeSelectArea'); if(isA){area.style.opacity="0.5"; area.style.pointerEvents="none"; document.getElementById('selectStartTime').value="9:00"; document.getElementById('selectEndTime').value="20:00";} else {area.style.opacity="1"; area.style.pointerEvents="auto";} };
        window.toggleBookingInputs=()=>{ const t=document.querySelector('input[name="bookingType"]:checked')?.value||'normal'; if(t==='event'){document.getElementById('groupBandSelect').classList.add('hidden'); document.getElementById('groupEventTitle').classList.remove('hidden');} else {document.getElementById('groupBandSelect').classList.remove('hidden'); document.getElementById('groupEventTitle').classList.add('hidden');} };
        function openBookingModalRange(){ document.querySelectorAll('.time-content').forEach(el=>el.classList.remove('selecting')); const s=Math.min(selectionStartHour,selectionEndHour), e=Math.max(selectionStartHour,selectionEndHour); document.getElementById('bookingModalTitle').innerText="新規予約"; document.getElementById('editingBookingId').value=""; const adm=currentUserData?.affiliations.includes('urakata')&&currentUserData.role; document.getElementById('bookingTypeSelector').classList.toggle('hidden',!adm); if(adm)document.querySelector('input[name="bookingType"][value="normal"]').checked=true; toggleBookingInputs(); document.getElementById('bookingDateDisplay').innerText=`${displayDate.getMonth()+1}月 ${displayDate.getDate()}日`; setupTimeSelects(`${s}:00`,`${e+1}:00`); document.getElementById('checkAllDay').checked=false; toggleAllDay(); updateBandSelect(); openModal('modal-booking'); }
        function openEditBookingModal(id,data){ if(data.creatorId!==currentUser){ if(data.type==='event')alert(`予定あり`); else alert("編集不可"); return; } document.getElementById('bookingModalTitle').innerText="編集"; document.getElementById('btnDeleteBooking').classList.remove('hidden'); document.getElementById('editingBookingId').value=id; editingBookingData=data; const adm=currentUserData?.affiliations.includes('urakata')&&currentUserData.role; document.getElementById('bookingTypeSelector').classList.toggle('hidden',!adm); if(adm)document.querySelector(`input[name="bookingType"][value="${data.type||'normal'}"]`).checked=true; toggleBookingInputs(); const s=data.startTime.toDate(), e=data.endTime.toDate(), sStr=`${s.getHours()}:${String(s.getMinutes()).padStart(2,'0')}`, eStr=`${e.getHours()}:${String(e.getMinutes()).padStart(2,'0')}`; document.getElementById('bookingDateDisplay').innerText=`${s.getMonth()+1}月 ${s.getDate()}日`; document.getElementById('checkAllDay').checked=(sStr==="9:00"&&eStr==="20:00"); setupTimeSelects(sStr,eStr); toggleAllDay(); if(data.type==='event')document.getElementById('inputEventTitle').value=data.title||""; else updateBandSelect(data.bandId); openModal('modal-booking'); }
        function setupTimeSelects(ds,de){ const sSel=document.getElementById('selectStartTime'), eSel=document.getElementById('selectEndTime'), opts=[]; for(let h=9;h<=20;h++){ opts.push(`${h}:00`); if(h<20)opts.push(`${h}:30`); } sSel.innerHTML=""; eSel.innerHTML=""; opts.forEach(t=>{sSel.appendChild(new Option(t,t)); eSel.appendChild(new Option(t,t));}); if(ds)sSel.value=ds; if(de)eSel.value=de; }
        function updateBandSelect(bid=""){ const s=document.getElementById('selectBookingBand'); s.innerHTML=""; const active=myBandsAll.filter(b=>!b.isArchived); if(!active.length)s.appendChild(new Option("なし","")); else active.forEach(b=>{const op=new Option(b.name,b.id); if(b.id===bid)op.selected=true; s.appendChild(op);}); }
        window.openEventListModal=(evs)=>{ const c=document.getElementById('eventListContainer'); c.innerHTML=""; evs.forEach(d=>{ const div=document.createElement('div'); div.className="card"; const s=d.startTime.toDate(), e=d.endTime.toDate(), tStr=`${s.getHours()}:${String(s.getMinutes()).padStart(2,'0')} - ${e.getHours()}:${String(e.getMinutes()).padStart(2,'0')}`; div.innerHTML=`<b>${tStr}</b><br>${d.bandName}`; div.onclick=()=>{closeModal('modal-event-list'); openEditBookingModal(d.id,d);}; c.appendChild(div); }); openModal('modal-event-list'); };
        function loadDayBookings(){ const sD=new Date(displayDate), eD=new Date(displayDate); sD.setHours(0,0,0,0); eD.setHours(23,59,59,999); onSnapshot(query(collection(db,"bookings"),where("startTime",">=",sD),where("startTime","<=",eD)),(qs)=>{ document.querySelectorAll('.event-block').forEach(el=>el.remove()); const evs=[]; qs.forEach(snap=>{const d=snap.data(); d.id=snap.id; evs.push(d);}); evs.sort((a,b)=>a.startTime.toDate()-b.startTime.toDate()); evs.forEach(e=>renderEventBlock(e,0,85)); }); }
        function renderEventBlock(d,l,w){ const s=d.startTime.toDate(), e=d.endTime.toDate(), sM=(s.getHours()-9)*60+s.getMinutes(), eM=(e.getHours()-9)*60+e.getMinutes(), slots=document.querySelectorAll('.time-slot'); if(slots[s.getHours()-9]){ const cA=slots[s.getHours()-9].querySelector('.time-content'), div=document.createElement('div'); div.className='event-block'; div.style.top=(s.getMinutes()+1)+"px"; div.style.height=(eM-sM-2)+"px"; div.style.width=w+"%"; div.innerHTML=`<b>${d.bandName}</b>`; div.onclick=(ev)=>{ev.stopPropagation(); openEditBookingModal(d.id,d);}; cA.appendChild(div); } }
        window.saveBooking=async()=>{ const eid=document.getElementById('editingBookingId').value, t=document.querySelector('input[name="bookingType"]:checked')?.value||'normal'; let bd={creatorId:currentUser,userName:currentProfile.displayName,type:t,createdAt:new Date()}; if(t==='normal'){const bS=document.getElementById('selectBookingBand'); bd.bandId=bS.value; bd.bandName=bS.options[bS.selectedIndex].text;} else bd.bandName=document.getElementById('inputEventTitle').value.trim(); let sH,sM,eH,eM; if(document.getElementById('checkAllDay').checked){sH=9;sM=0;eH=20;eM=0;} else {const sTS=document.getElementById('selectStartTime').value, eTS=document.getElementById('selectEndTime').value; [sH,sM]=sTS.split(':').map(Number); [eH,eM]=eTS.split(':').map(Number);} const st=new Date(displayDate), et=new Date(displayDate); st.setHours(sH,sM,0,0); et.setHours(eH,eM,0,0); bd.startTime=st; bd.endTime=et; const mode=currentSystemSettings.bookingMode||'first_come'; bd.status=(mode==='first_come')?'confirmed':'pending'; if(eid) await updateDoc(doc(db,"bookings",eid),bd); else await addDoc(collection(db,"bookings"),bd); closeModal('modal-booking'); };
        window.addToGoogleCalendar=()=>{}; window.deleteBooking=async()=>{}; function renderHeaderIcons(d){ let r=""; const aff=d.affiliations||[], isU=aff.includes("urakata"); if(isU)r=d.job?`ring-${d.job}`:"ring-rainbow"; const h=`<img src="${d.icon||'https://ul.h3z.jp/Vnukmtvq.jpg'}">`; ['headerIconBands','headerIconCal','headerIconCue','headerIconAdmin'].forEach(id=>{ const el=document.getElementById(id); if(el){el.innerHTML=h; el.className="header-avatar "+r; el.onclick=openUserStatusModal;} }); if(isU&&d.role)document.getElementById('nav-admin').classList.remove('hidden'); }
        main();
    </script>
</body>
</html>
