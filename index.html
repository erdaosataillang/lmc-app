<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LMC Studio Mobile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F3F4F6; color: #1F2937; -webkit-tap-highlight-color: transparent; }
        .mobile-container { max-width: 480px; margin: 0 auto; background: white; min-height: 100vh; position: relative; padding-bottom: 80px; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        .app-header { background: white; padding: 15px 20px; position: sticky; top: 0; z-index: 50; border-bottom: 1px solid #E5E7EB; display: flex; align-items: center; justify-content: space-between; height: 60px; }
        .logo { font-weight: 800; font-size: 20px; background: linear-gradient(135deg, #6366F1, #8B5CF6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -0.5px; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #E5E7EB; padding: 8px 0 20px; display: flex; justify-content: space-around; max-width: 480px; margin: 0 auto; z-index: 50; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #9CA3AF; font-size: 10px; font-weight: 500; transition: all 0.2s; width: 20%; }
        .nav-item.active { color: #6366F1; }
        .nav-item .material-icons { font-size: 24px; margin-bottom: 4px; }
        .card { background: white; border-radius: 16px; padding: 20px; margin-bottom: 16px; border: 1px solid #F3F4F6; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .btn-primary { background: linear-gradient(135deg, #6366F1, #8B5CF6); color: white; border: none; padding: 12px 24px; border-radius: 12px; font-weight: 600; width: 100%; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2); transition: transform 0.1s; }
        .btn-primary:active { transform: scale(0.98); }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 100; display: none; align-items: flex-end; backdrop-filter: blur(2px); }
        .modal-content { background: white; width: 100%; max-width: 480px; margin: 0 auto; border-radius: 20px 20px 0 0; padding: 24px; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); max-height: 90vh; overflow-y: auto; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; margin-bottom: 20px; }
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 14px; border-radius: 10px; position: relative; }
        .calendar-day.today { background-color: #EEF2FF; color: #6366F1; font-weight: 700; }
        .calendar-day.selected { background-color: #6366F1; color: white; }
        .calendar-day.has-event::after { content: ''; position: absolute; bottom: 4px; width: 4px; height: 4px; background: #EF4444; border-radius: 50%; }
        .time-slot { display: flex; border-bottom: 1px solid #F3F4F6; padding: 0; height: 44px; position: relative; } /* 高さ固定 */
        .time-label { width: 50px; font-size: 12px; color: #9CA3AF; padding: 12px 8px 0 0; text-align: right; flex-shrink: 0; }
        .time-track { flex-grow: 1; position: relative; background: #FAFAFA; border-left: 1px solid #F3F4F6; cursor: pointer; } /* cursor pointer追加 */
        .booking-block { position: absolute; left: 2px; right: 2px; border-radius: 6px; padding: 2px 6px; font-size: 11px; color: white; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; z-index: 10; pointer-events: auto; }
        .selection-highlight { position: absolute; left: 0; right: 0; background-color: rgba(99, 102, 241, 0.2); pointer-events: none; z-index: 5; } /* 選択範囲ハイライト */
        .band-icon-sm { width: 40px; height: 40px; border-radius: 10px; object-fit: cover; background: #F3F4F6; }
        .hidden { display: none !important; }
        
        /* メンバー選択用 */
        .member-select-list { max-height: 200px; overflow-y: auto; margin-bottom: 15px; border: 1px solid #eee; border-radius: 8px; }
        .member-option { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #f9f9f9; cursor: pointer; }
        .member-option:last-child { border-bottom: none; }
        .member-option.selected { background-color: #EEF2FF; }
        .member-check { margin-right: 10px; color: #6366F1; }

        /* タブ切り替え */
        .tab-group { display: flex; background: #F3F4F6; padding: 4px; border-radius: 12px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 8px; text-align: center; font-size: 13px; font-weight: 600; color: #6B7280; border-radius: 8px; transition: all 0.2s; }
        .tab-btn.active { background: white; color: #6366F1; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* スケルトンローディング */
        .skeleton { background: #eee; background: linear-gradient(110deg, #ececec 8%, #f5f5f5 18%, #ececec 33%); border-radius: 8px; background-size: 200% 100%; animation: 1.5s shine linear infinite; }
        @keyframes shine { to { background-position-x: -200%; } }

        /* トースト通知 */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 200; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; pointer-events: none; }
        .toast { background: rgba(31, 41, 55, 0.95); color: white; padding: 12px 20px; border-radius: 50px; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transform: translateY(-20px); transition: all 0.3s; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .toast.show { opacity: 1; transform: translateY(0); }

        /* 管理者パネル */
        .admin-panel { border: 2px solid #6366F1; background: #EEF2FF; display: none; }
    </style>
</head>
<body>

<div class="mobile-container">
    <!-- Header -->
    <header class="app-header">
        <div class="logo">LMC Studio</div>
        <div class="flex items-center gap-3">
            <span id="headerDate" class="text-sm font-medium text-gray-500"></span>
            <div id="userAvatar" class="w-8 h-8 rounded-full bg-gray-200 overflow-hidden cursor-pointer border border-gray-200" onclick="switchPage('profile')">
                <img id="headerUserIcon" src="https://placehold.jp/150x150.png" class="w-full h-full object-cover">
            </div>
        </div>
    </header>

    <div id="toast-container"></div>

    <!-- Main Content Area -->
    <main id="mainContent" class="p-4">
        <!-- ページはJSで切り替え -->
    </main>
    
    <!-- Navigation -->
    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchPage('home')">
            <span class="material-icons">calendar_today</span>
            <span>予約</span>
        </div>
        <div class="nav-item" onclick="switchPage('bands')">
            <span class="material-icons">groups</span>
            <span>バンド</span>
        </div>
        <div class="nav-item" onclick="switchPage('lottery')">
            <span class="material-icons">casino</span>
            <span>抽選</span>
        </div>
        <div class="nav-item" onclick="switchPage('profile')">
            <span class="material-icons">person</span>
            <span>マイページ</span>
        </div>
        <div id="adminNav" class="nav-item hidden" onclick="switchPage('admin')">
            <span class="material-icons">admin_panel_settings</span>
            <span>管理</span>
        </div>
    </nav>
</div>

<!-- Modal: Band Create -->
<div id="modal-band" class="modal-overlay" onclick="if(event.target===this) closeModal('modal-band')">
    <div class="modal-content">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg font-bold">バンド作成</h3>
            <button onclick="closeModal('modal-band')" class="text-gray-400"><span class="material-icons">close</span></button>
        </div>
        <div class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">バンド名</label>
                <input type="text" id="inputBandName" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:border-indigo-500" placeholder="バンド名を入力">
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">アイコン画像</label>
                <input type="file" id="inputBandIcon" accept="image/*" class="hidden" onchange="handleImageSelect(this, 'previewBandIcon')">
                <div onclick="document.getElementById('inputBandIcon').click()" class="w-full h-32 bg-gray-50 border-2 border-dashed border-gray-200 rounded-xl flex flex-col items-center justify-center text-gray-400 cursor-pointer hover:bg-gray-100">
                    <img id="previewBandIcon" class="hidden w-full h-full object-cover rounded-xl">
                    <span class="material-icons mb-1">add_photo_alternate</span>
                    <span class="text-xs">タップして画像を選択</span>
                </div>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">メンバー追加</label>
                <div id="userSelectList" class="member-select-list">
                    <!-- JSでユーザーリスト生成 -->
                </div>
            </div>
            <button onclick="saveBand()" class="btn-primary">作成する</button>
        </div>
    </div>
</div>

<!-- Modal: Booking -->
<div id="modal-booking" class="modal-overlay" onclick="if(event.target===this) closeModal('modal-booking')">
    <div class="modal-content">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg font-bold">スタジオ予約</h3>
            <button onclick="closeModal('modal-booking')" class="text-gray-400"><span class="material-icons">close</span></button>
        </div>
        <div class="space-y-4">
            <div class="p-3 bg-indigo-50 rounded-xl text-indigo-800 text-sm font-medium flex items-center gap-2">
                <span class="material-icons text-base">schedule</span>
                <span id="bookingTimeDisplay">--:-- 〜 --:--</span>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">バンド選択</label>
                <select id="bookingBandSelect" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:border-indigo-500 appearance-none">
                    <!-- JSで生成 -->
                </select>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">メモ (任意)</label>
                <textarea id="bookingMemo" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:border-indigo-500" rows="2" placeholder="機材の要望など"></textarea>
            </div>
            <button onclick="confirmBooking()" class="btn-primary">予約する</button>
            <button id="btnDeleteBooking" onclick="deleteBooking()" class="w-full py-3 text-red-500 font-medium text-sm hidden">予約を取り消す</button>
        </div>
    </div>
</div>

<!-- Modal: Band Detail -->
<div id="modal-band-detail" class="modal-overlay" onclick="if(event.target===this) closeModal('modal-band-detail')">
    <div class="modal-content">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold">バンド詳細</h3>
            <button onclick="closeModal('modal-band-detail')" class="text-gray-400"><span class="material-icons">close</span></button>
        </div>
        <div class="flex flex-col items-center mb-6">
            <div class="relative">
                <img id="detailBandIcon" src="" class="w-24 h-24 rounded-2xl object-cover mb-3 shadow-md bg-gray-200">
                <label for="editBandIconInput" class="absolute bottom-2 right-[-8px] bg-white p-1.5 rounded-full shadow cursor-pointer text-gray-600">
                    <span class="material-icons text-sm">edit</span>
                </label>
                <input type="file" id="editBandIconInput" class="hidden" accept="image/*" onchange="handleImageEdit(this)">
            </div>
            <h2 id="detailBandName" class="text-xl font-bold"></h2>
            <p id="detailBandMemberCount" class="text-sm text-gray-500 mt-1"></p>
        </div>
        
        <input type="hidden" id="detailBandId">

        <div class="space-y-4">
            <div>
                <div class="flex justify-between items-center mb-2">
                    <label class="text-xs font-bold text-gray-500">メンバー</label>
                    <button onclick="openMemberAddModal()" class="text-xs text-indigo-600 font-medium">+ 追加</button>
                </div>
                <div id="detailMemberList" class="space-y-2"></div>
            </div>
            
            <div class="pt-4 border-t border-gray-100">
                <button onclick="archiveBand()" class="w-full py-3 text-red-500 font-medium text-sm bg-red-50 rounded-xl">バンドを解散/アーカイブ</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Add Member -->
<div id="modal-add-member" class="modal-overlay" onclick="if(event.target===this) closeModal('modal-add-member')">
    <div class="modal-content">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg font-bold">メンバー追加</h3>
            <button onclick="closeModal('modal-add-member')" class="text-gray-400"><span class="material-icons">close</span></button>
        </div>
        <div id="addMemberSelectList" class="member-select-list"></div>
        <button onclick="executeAddMember()" class="btn-primary">追加する</button>
    </div>
</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, setDoc, updateDoc, deleteDoc, query, where, orderBy, onSnapshot, Timestamp, arrayUnion, arrayRemove, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAWtITnn5uMOPBgOY0Bd7Rt5IN1ry8XoJI",
            authDomain: "urakata-app.firebaseapp.com",
            projectId: "urakata-app",
            storageBucket: "urakata-app.firebasestorage.app",
            messagingSenderId: "407777765696",
            appId: "1:407777765696:web:045c2d94729022b4eab2a5",
            measurementId: "G-9ZRMD26XNJ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const auth = getAuth(app);

        // State Variables
        let currentUser = null; let currentProfile = null; let currentUserData = null; 
        let displayDate = new Date(); let selectedTimeSlot = null; let selectionStartHour = null; let selectionEndHour = null;
        let myBandsAll = []; let currentBandTab = 'active'; let calendarMode = 'month';
        let isSelecting = false; let selectionTimer = null; let editingBookingData = null;
        let currentEditingBandId = null; let currentEditingBandMembers = []; 
        let tempBandIconBlob = null; 
        let allUsersCache = []; let adminEditingUserId = null;
        let allBandsCache = []; // 管理者用バンドキャッシュ
        let tempLotterySchedule = null; // 抽選結果一時保存用

        // --- Auth & Init ---
        async function main() {
            try {
                await signInAnonymously(auth);
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        currentUser = user.uid;
                        await checkUserProfile();
                        initApp();
                    }
                });
            } catch(e) { console.error("Auth Error:", e); alert("認証エラー: " + e.message); }
        }
        
        async function checkUserProfile() {
            const userDoc = await getDoc(doc(db, "users", currentUser));
            if (!userDoc.exists()) {
                const name = prompt("あなたの名前(ニックネーム)を入力してください:");
                if(name) {
                    await setDoc(doc(db, "users", currentUser), {
                        name: name, icon: "", part: "vocal", isAdmin: false, createdAt: new Date()
                    });
                    currentProfile = { name, icon: "", isAdmin: false };
                }
            } else {
                currentProfile = userDoc.data();
                currentUserData = userDoc.data(); // cache full data
                if(currentProfile.icon) document.getElementById('headerUserIcon').src = currentProfile.icon;
                if(currentProfile.isAdmin) document.getElementById('adminNav').classList.remove('hidden');
            }
        }

        function initApp() {
            loadBookings();
            renderCalendarHeader();
            switchPage('home'); // 初期表示
            
            // パラメータチェック (バンド招待など)
            const urlParams = new URLSearchParams(window.location.search);
            if(urlParams.has('invite_band')) {
                joinBandFromInvite(urlParams.get('invite_band'));
            }
        }
        main();

        // --- Navigation ---
        window.switchPage = (pageId) => {
            const content = document.getElementById('mainContent');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            // Reset active state for nav items
            const navMap = { 'home': 0, 'bands': 1, 'lottery': 2, 'profile': 3, 'admin': 4 };
            if(navMap[pageId] !== undefined) document.querySelectorAll('.nav-item')[navMap[pageId]].classList.add('active');

            if (pageId === 'home') {
                renderHome();
            } else if (pageId === 'bands') {
                renderBandsPage();
            } else if (pageId === 'lottery') {
                renderLotteryPage();
            } else if (pageId === 'profile') {
                renderProfilePage();
            } else if (pageId === 'admin') {
                if(!currentProfile.isAdmin) { alert("権限がありません"); switchPage('home'); return; }
                renderAdminPage();
            }
        };

        // --- Pages ---
        function renderHome() {
            const d = displayDate;
            const dateStr = `${d.getFullYear()}年${d.getMonth()+1}月`;
            document.getElementById('headerDate').innerText = dateStr;
            
            let html = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">予約カレンダー</h2>
                    <div class="flex bg-gray-200 rounded-lg p-1">
                        <button onclick="setCalendarMode('month')" class="px-3 py-1 text-xs font-bold rounded-md ${calendarMode==='month'?'bg-white shadow text-indigo-600':''}">月</button>
                        <button onclick="setCalendarMode('week')" class="px-3 py-1 text-xs font-bold rounded-md ${calendarMode==='week'?'bg-white shadow text-indigo-600':''}">週</button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded-full"><span class="material-icons">chevron_left</span></button>
                        <span class="font-bold text-lg">${d.getFullYear()}年 ${d.getMonth()+1}月</span>
                        <button onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded-full"><span class="material-icons">chevron_right</span></button>
                    </div>
                    <div class="calendar-grid text-xs text-gray-400 font-medium mb-2">
                        <div>日</div><div>月</div><div>火</div><div>水</div><div>木</div><div>金</div><div>土</div>
                    </div>
                    <div id="calendarDays" class="calendar-grid"></div>
                </div>

                <div class="card">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-gray-700" id="selectedDateLabel">12月31日(水)の予約</h3>
                        <button class="text-xs bg-indigo-50 text-indigo-600 px-2 py-1 rounded" onclick="scrollToCurrentTime()">現在時刻へ</button>
                    </div>
                    <div class="text-xs text-gray-400 mb-3 flex items-center gap-1"><span class="material-icons text-sm">touch_app</span> 空き時間をタップして予約（ドラッグで範囲選択）</div>
                    <div id="timeTable" class="relative border-t border-gray-100">
                        <!-- Time slots generated by JS -->
                    </div>
                </div>
            `;
            document.getElementById('mainContent').innerHTML = html;
            renderCalendarDays();
            renderTimeTable();
        }

        async function renderBandsPage() {
            document.getElementById('headerDate').innerText = "My Bands";
            const content = document.getElementById('mainContent');
            content.innerHTML = `
                <div class="flex justify-between items-end mb-4">
                    <h2 class="text-2xl font-bold">バンド管理</h2>
                    <button onclick="openBandModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg shadow-indigo-200">+ 新規作成</button>
                </div>
                
                <div class="tab-group">
                    <div class="tab-btn ${currentBandTab==='active'?'active':''}" onclick="setBandTab('active')">活動中</div>
                    <div class="tab-btn ${currentBandTab==='archived'?'active':''}" onclick="setBandTab('archived')">解散済</div>
                </div>

                <div id="bandsList" class="space-y-3">
                    <div class="skeleton h-24 w-full"></div>
                    <div class="skeleton h-24 w-full"></div>
                </div>
            `;

            const q = query(collection(db, "bands"), where("memberIds", "array-contains", currentUser));
            const snap = await getDocs(q);
            myBandsAll = [];
            snap.forEach(d => myBandsAll.push({id: d.id, ...d.data()}));
            
            updateBandsList();
        }

        // 抽選ページ (管理者のみ作成・編集可能、一般は閲覧のみ)
        async function renderLotteryPage() {
            document.getElementById('headerDate').innerText = "Lottery";
            const isAdmin = currentProfile.isAdmin;
            const content = document.getElementById('mainContent');
            
            // 最新の抽選設定を取得
            const lotteryDocRef = doc(db, "system", "lottery_settings");
            const lotteryDoc = await getDoc(lotteryDocRef);
            const lotteryData = lotteryDoc.exists() ? lotteryDoc.data() : { is_open: false, target_month: "", entries: [] };
            
            content.innerHTML = `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-2">スタジオ抽選</h2>
                    <p class="text-sm text-gray-500">来月分のバンド練習枠を抽選で決定します。</p>
                </div>

                ${isAdmin ? `
                <div class="card border-l-4 border-indigo-500">
                    <h3 class="font-bold mb-2">管理者メニュー</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="toggleLotteryStatus()" class="p-2 bg-gray-100 rounded text-sm font-bold">${lotteryData.is_open ? '受付を終了する' : '受付を開始する'}</button>
                        <button onclick="runLottery()" class="p-2 bg-indigo-600 text-white rounded text-sm font-bold">抽選を実行する</button>
                    </div>
                </div>
                ` : ''}

                <div class="card">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-2 h-12 bg-${lotteryData.is_open ? 'green' : 'red'}-500 rounded-full"></div>
                        <div>
                            <div class="text-xs text-gray-400 font-bold uppercase">Status</div>
                            <div class="text-lg font-bold">${lotteryData.is_open ? 'エントリー受付中' : '受付終了 / 抽選済み'}</div>
                        </div>
                    </div>
                    
                    ${lotteryData.is_open ? `
                        <div class="bg-indigo-50 p-4 rounded-xl mb-4">
                            <h4 class="font-bold text-indigo-900 mb-2">希望を提出する</h4>
                            <p class="text-xs text-indigo-700 mb-3">各バンド、第3希望まで提出可能です。</p>
                            <button onclick="openLotteryEntryModal()" class="w-full py-2 bg-indigo-600 text-white rounded-lg font-bold text-sm">エントリー画面へ</button>
                        </div>
                    ` : `
                        <div class="text-center py-8 text-gray-400">
                            <span class="material-icons text-4xl mb-2">event_busy</span>
                            <p>現在は抽選期間ではありません</p>
                        </div>
                    `}
                </div>
            `;
        }

        async function renderProfilePage() {
            document.getElementById('headerDate').innerText = "Profile";
            if(!currentProfile) return;
            const content = document.getElementById('mainContent');
            content.innerHTML = `
                <div class="card flex flex-col items-center pt-6 pb-6">
                    <div class="relative mb-4">
                        <img id="profileIconPreview" src="${currentProfile.icon || 'https://placehold.jp/150x150.png'}" class="w-28 h-28 rounded-full object-cover border-4 border-white shadow-lg">
                        <label for="profileIconInput" class="absolute bottom-0 right-0 bg-indigo-600 text-white p-2 rounded-full cursor-pointer shadow-md hover:bg-indigo-700 transition">
                            <span class="material-icons text-sm">edit</span>
                        </label>
                        <input type="file" id="profileIconInput" class="hidden" accept="image/*" onchange="handleProfileIconUpload(this)">
                    </div>
                    <h2 class="text-2xl font-bold mb-1">${currentProfile.name}</h2>
                    <span class="px-3 py-1 bg-gray-100 text-gray-500 text-xs rounded-full font-bold uppercase tracking-wider">${currentProfile.part || 'Part Undefined'}</span>
                </div>

                <div class="card space-y-4">
                    <h3 class="font-bold text-gray-700 border-b pb-2">設定</h3>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">ニックネーム</label>
                        <div class="flex gap-2">
                            <input type="text" id="profileNameInput" value="${currentProfile.name}" class="flex-1 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2">
                            <button onclick="updateProfileName()" class="bg-indigo-600 text-white px-4 rounded-lg text-sm font-bold">保存</button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">担当パート</label>
                        <select id="profilePartSelect" onchange="updateProfilePart(this.value)" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2">
                            <option value="vocal" ${currentProfile.part==='vocal'?'selected':''}>Vocal</option>
                            <option value="guitar" ${currentProfile.part==='guitar'?'selected':''}>Guitar</option>
                            <option value="bass" ${currentProfile.part==='bass'?'selected':''}>Bass</option>
                            <option value="drums" ${currentProfile.part==='drums'?'selected':''}>Drums</option>
                            <option value="keyboard" ${currentProfile.part==='keyboard'?'selected':''}>Keyboard</option>
                        </select>
                    </div>
                </div>
            `;
        }

        async function renderAdminPage() {
            document.getElementById('headerDate').innerText = "Admin Console";
            const content = document.getElementById('mainContent');
            
            content.innerHTML = `
                <h2 class="text-2xl font-bold mb-4">管理者コンソール</h2>
                
                <div class="card mb-4">
                    <h3 class="font-bold text-gray-700 mb-2">ユーザー管理</h3>
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="adminSearchUser" placeholder="名前で検索..." class="flex-1 border p-2 rounded text-sm">
                    </div>
                    <div id="adminUserList" class="h-40 overflow-y-auto border rounded bg-gray-50 p-2 text-sm">Loading...</div>
                </div>

                <div class="card mb-4">
                    <h3 class="font-bold text-gray-700 mb-2">バンド管理</h3>
                    <div id="adminBandList" class="h-40 overflow-y-auto border rounded bg-gray-50 p-2 text-sm">Loading...</div>
                </div>
            `;

            // ユーザーリスト取得
            const uSnap = await getDocs(collection(db, "users"));
            allUsersCache = [];
            uSnap.forEach(d => allUsersCache.push({id: d.id, ...d.data()}));
            renderAdminUserList();

             // バンドリスト取得
            const bSnap = await getDocs(collection(db, "bands"));
            allBandsCache = [];
            bSnap.forEach(d => allBandsCache.push({id: d.id, ...d.data()}));
            renderAdminBandList();

            // 検索フィルター
            document.getElementById('adminSearchUser').addEventListener('input', (e) => {
                renderAdminUserList(e.target.value);
            });
        }

        function renderAdminUserList(filter = "") {
            const list = document.getElementById('adminUserList');
            list.innerHTML = "";
            allUsersCache.filter(u => u.name.toLowerCase().includes(filter.toLowerCase())).forEach(u => {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center p-2 border-b last:border-0";
                div.innerHTML = `
                    <span>${u.name} <span class="text-xs text-gray-400">(${u.part})</span></span>
                    <div class="flex gap-1">
                        <button onclick="adminToggleAdmin('${u.id}', ${!u.isAdmin})" class="text-xs px-2 py-1 rounded ${u.isAdmin ? 'bg-red-100 text-red-600' : 'bg-gray-200'}">${u.isAdmin ? '管理者解除' : '管理者へ'}</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function renderAdminBandList() {
            const list = document.getElementById('adminBandList');
            list.innerHTML = "";
            allBandsCache.forEach(b => {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center p-2 border-b last:border-0";
                div.innerHTML = `
                    <span>${b.name} <span class="text-xs text-gray-400">(${b.memberNames?.length||0}人)</span></span>
                    <button onclick="adminDeleteBand('${b.id}')" class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded">削除</button>
                `;
                list.appendChild(div);
            });
        }

        // --- Logic: Calendar & Booking ---
        window.changeMonth = (delta) => {
            displayDate.setMonth(displayDate.getMonth() + delta);
            renderHome();
        };
        window.setCalendarMode = (mode) => {
            calendarMode = mode;
            renderHome();
        };
        window.scrollToCurrentTime = () => {
             const now = new Date();
             const hour = now.getHours();
             const el = document.getElementById('timeTable');
             // 1時間44px計算。少し手前(2時間前)にスクロール
             el.scrollTop = Math.max(0, (hour - 2) * 44);
        };

        function renderCalendarDays() {
            const container = document.getElementById('calendarDays');
            container.innerHTML = "";
            const y = displayDate.getFullYear(), m = displayDate.getMonth();
            const firstDay = new Date(y, m, 1).getDay();
            const lastDate = new Date(y, m + 1, 0).getDate();
            
            // Empty slots
            for(let i=0; i<firstDay; i++) container.innerHTML += `<div></div>`;
            
            // Days
            const today = new Date();
            for(let d=1; d<=lastDate; d++) {
                const div = document.createElement('div');
                div.className = `calendar-day ${d===displayDate.getDate() ? 'selected' : ''}`;
                if(y===today.getFullYear() && m===today.getMonth() && d===today.getDate()) div.classList.add('today');
                div.innerText = d;
                div.onclick = () => { displayDate.setDate(d); renderHome(); };
                container.appendChild(div);
            }
            
            document.getElementById('selectedDateLabel').innerText = `${m+1}月${displayDate.getDate()}日(${['日','月','火','水','木','金','土'][displayDate.getDay()]})`;
        }

        async function loadBookings() {
            // Firestoreから今月の予約を取得するなどの処理 (今回は簡略化のためonSnapshotをHomeレンダー時に設定)
            // 実際はリスナー管理が必要
            const startOfDay = new Date(displayDate); startOfDay.setHours(0,0,0,0);
            const endOfDay = new Date(displayDate); endOfDay.setHours(23,59,59,999);
            
            const q = query(collection(db, "bookings"), 
                where("startTime", ">=", Timestamp.fromDate(startOfDay)),
                where("startTime", "<=", Timestamp.fromDate(endOfDay))
            );
            
            onSnapshot(q, (snap) => {
                document.querySelectorAll('.booking-block').forEach(e => e.remove());
                snap.forEach(d => {
                    const b = d.data();
                    renderBookingBlock(d.id, b);
                });
            });
        }

        function renderTimeTable() {
            const container = document.getElementById('timeTable');
            container.innerHTML = "";
            container.style.height = "400px";
            container.style.overflowY = "auto";
            
            for(let h=9; h<24; h++) {
                const row = document.createElement('div');
                row.className = "time-slot";
                row.dataset.hour = h;
                
                // Hour Label
                const label = document.createElement('div');
                label.className = "time-label";
                label.innerText = `${h}:00`;
                
                // Track
                const track = document.createElement('div');
                track.className = "time-track";
                // Touch/Mouse Events for range selection
                addSelectionEvents(track, h);

                row.appendChild(label);
                row.appendChild(track);
                container.appendChild(row);
            }
            // Load bookings immediately
            loadBookings();
        }

        function addSelectionEvents(el, hour) {
            const startSelection = (e) => {
                // 既存の予約がある場合は無視（簡易）
                if(e.target.classList.contains('booking-block')) return;
                
                isSelecting = true;
                selectionStartHour = hour;
                selectionEndHour = hour;
                updateSelectionHighlight();
                
                // Prevent scroll on touch
                // if(e.type === 'touchstart') e.preventDefault();
            };

            const moveSelection = (e) => {
                if(!isSelecting) return;
                // タッチ位置から要素特定は複雑なので、今回は簡易的に、
                // トラック上でのmoveのみ検知。PC向け。
                // モバイルのドラッグ選択はTouch APIで要素座標計算が必要だが
                // ここではタップ＝1時間予約、ドラッグ未対応の簡易版とするか、
                // あるいは別ロジックが必要。
                // "Tap to select, Tap another to range" pattern is easier for mobile.
            };

            const endSelection = () => {
                if(!isSelecting) return;
                isSelecting = false;
                clearSelectionHighlight();
                openBookingModal(selectionStartHour, selectionEndHour + 1); // +1 for end time
            };
            
            // Mobile: Tap to book 1 hour (Simple)
            el.onclick = (e) => {
                if(e.target.classList.contains('booking-block')) return;
                openBookingModal(hour, hour+1);
            };
        }

        function updateSelectionHighlight() {
            // Visual feedback logic
        }
        function clearSelectionHighlight() {
            document.querySelectorAll('.selection-highlight').forEach(e => e.remove());
        }

        function renderBookingBlock(id, data) {
            const start = data.startTime.toDate();
            const end = data.endTime.toDate();
            const startH = start.getHours();
            const endH = end.getHours(); // 簡易的に時間単位
            const duration = endH - startH;
            
            // Find track
            const track = document.querySelector(`.time-slot[data-hour="${startH}"] .time-track`);
            if(!track) return;
            
            const block = document.createElement('div');
            block.className = "booking-block shadow-sm";
            block.style.height = `calc(${duration * 100}% - 4px)`;
            block.style.top = "2px";
            block.style.backgroundColor = data.bandId === 'lottery_blocked' ? '#EF4444' : '#6366F1';
            
            block.innerHTML = `<span class="font-bold">${data.bandName}</span> <span class="opacity-75 text-[10px]">${data.memberName}</span>`;
            
            block.onclick = (e) => {
                e.stopPropagation();
                openBookingEditModal(id, data);
            };
            
            track.appendChild(block);
        }

        // --- Modals & Actions ---
        window.openModal = (id) => {
            const el = document.getElementById(id);
            el.style.display = 'flex';
        };
        window.closeModal = (id) => {
            document.getElementById(id).style.display = 'none';
        };

        // バンド作成 (画像保存つき)
        window.openBandModal = () => { 
            document.getElementById('inputBandName').value = ""; document.getElementById('userSelectList').innerHTML = "読み込み中...";
            tempBandIconBlob = null; document.getElementById('previewBandIcon').classList.add('hidden');
            loadUserList('userSelectList'); openModal('modal-band'); 
        };
        window.saveBand = async () => {
            const name = document.getElementById('inputBandName').value.trim(); if(!name) return alert("バンド名を入力してください");
            const selectedEls = document.querySelectorAll('#userSelectList .member-option.selected');
            const memberIds = [currentUser]; const memberNames = [currentProfile.displayName || currentProfile.name]; // fix name ref
            selectedEls.forEach(el => { memberIds.push(el.dataset.uid); memberNames.push(el.dataset.uname); });
            
            const btn = document.querySelector('#modal-band .btn-primary');
            const originalText = btn.innerText;
            btn.innerText = "作成中...";
            btn.disabled = true;

            try {
                const docRef = await addDoc(collection(db, "bands"), { name: name, memberIds: memberIds, memberNames: memberNames, creatorId: currentUser, isArchived: false, createdAt: new Date() });
                
                // Blobを使ってアップロード (uploadBytes)
                if (tempBandIconBlob) { 
                    const storageRef = ref(storage, `band_icons/${docRef.id}.jpg`); 
                    await uploadBytes(storageRef, tempBandIconBlob); 
                    const url = await getDownloadURL(storageRef); 
                    await updateDoc(doc(db, "bands", docRef.id), { icon: url }); 
                }

                closeModal('modal-band'); document.getElementById('inputBandName').value = "";
                if (confirm(`「${name}」を作成しました！\nLINEで招待状も送りますか？`)) shareBandInvite(docRef.id, name); else showToast("バンドを作成しました");
                renderBandsPage();
            } catch(e) { 
                console.error(e);
                alert("エラー: " + e.message); 
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        };

        // 予約モーダル
        window.openBookingModal = async (startH, endH) => {
            selectedTimeSlot = { start: startH, end: endH };
            document.getElementById('bookingTimeDisplay').innerText = `${startH}:00 〜 ${endH}:00`;
            document.getElementById('bookingMemo').value = "";
            document.getElementById('btnDeleteBooking').classList.add('hidden');
            editingBookingData = null;
            
            // Load My Bands
            const sel = document.getElementById('bookingBandSelect');
            sel.innerHTML = "";
            // キャッシュか再取得
            const q = query(collection(db, "bands"), where("memberIds", "array-contains", currentUser), where("isArchived", "==", false));
            const snap = await getDocs(q);
            if(snap.empty) {
                const op = document.createElement('option');
                op.text = "所属バンドがありません";
                sel.add(op);
                sel.disabled = true;
            } else {
                sel.disabled = false;
                snap.forEach(d => {
                    const op = document.createElement('option');
                    op.value = d.id;
                    op.text = d.data().name;
                    op.dataset.name = d.data().name;
                    sel.add(op);
                });
            }
            openModal('modal-booking');
        };

        window.openBookingEditModal = (id, data) => {
            // 自分または管理者のみ編集可能
            if(data.userId !== currentUser && !currentProfile.isAdmin) {
                alert("予約者のみ変更できます");
                return;
            }
            editingBookingData = { id, ...data };
            const startH = data.startTime.toDate().getHours();
            const endH = data.endTime.toDate().getHours();
            
            document.getElementById('bookingTimeDisplay').innerText = `${startH}:00 〜 ${endH}:00`;
            document.getElementById('bookingMemo').value = data.memo || "";
            
            // バンド選択復元
            const sel = document.getElementById('bookingBandSelect');
            sel.innerHTML = `<option value="${data.bandId}">${data.bandName}</option>`; // 簡易表示
            sel.disabled = true;

            document.getElementById('btnDeleteBooking').classList.remove('hidden');
            openModal('modal-booking');
        };

        window.confirmBooking = async () => {
            const sel = document.getElementById('bookingBandSelect');
            if(sel.disabled && !editingBookingData) { alert("バンドを作成してください"); return; }
            
            const memo = document.getElementById('bookingMemo').value;
            
            // Date Objects
            const sDate = new Date(displayDate); sDate.setHours(editingBookingData ? editingBookingData.startTime.toDate().getHours() : selectedTimeSlot.start, 0, 0);
            const eDate = new Date(displayDate); eDate.setHours(editingBookingData ? editingBookingData.endTime.toDate().getHours() : selectedTimeSlot.end, 0, 0);
            
            try {
                if(editingBookingData) {
                    await updateDoc(doc(db, "bookings", editingBookingData.id), {
                        memo: memo
                    });
                    showToast("予約を更新しました");
                } else {
                    const bandId = sel.value;
                    const bandName = sel.options[sel.selectedIndex].text;
                    
                    await addDoc(collection(db, "bookings"), {
                        bandId, bandName, 
                        userId: currentUser, memberName: currentProfile.name,
                        startTime: Timestamp.fromDate(sDate),
                        endTime: Timestamp.fromDate(eDate),
                        memo, createdAt: serverTimestamp()
                    });
                    showToast("予約しました！");
                }
                closeModal('modal-booking');
            } catch(e) {
                console.error(e);
                alert("予約エラー: " + e.message);
            }
        };

        window.deleteBooking = async () => {
            if(!editingBookingData) return;
            if(!confirm("予約を取り消しますか？")) return;
            try {
                await deleteDoc(doc(db, "bookings", editingBookingData.id));
                closeModal('modal-booking');
                showToast("予約を取り消しました");
            } catch(e) { alert(e.message); }
        };

        // --- Band Detail & Edit ---
        window.openBandDetail = async (bandId) => {
            const d = await getDoc(doc(db, "bands", bandId));
            if(!d.exists()) return;
            const b = d.data();
            currentEditingBandId = bandId;
            currentEditingBandMembers = b.memberIds;

            document.getElementById('detailBandName').innerText = b.name;
            document.getElementById('detailBandIcon').src = b.icon || 'https://placehold.jp/150x150.png';
            document.getElementById('detailBandMemberCount').innerText = `${b.memberIds.length} members`;
            document.getElementById('detailBandId').value = bandId;
            
            const list = document.getElementById('detailMemberList');
            list.innerHTML = "";
            
            // メンバー詳細取得
            // 実際はmemberIdsからUser取得だが、ここではmemberNamesを簡易使用、
            // または個別に取得。今回は簡易的に名前表示のみ。
            // 正確にはPromise.allでUser取得すべき。
            b.memberIds.forEach(async (uid) => {
                const uSnap = await getDoc(doc(db, "users", uid));
                const uData = uSnap.exists() ? uSnap.data() : {name: "Unknown", part: ""};
                const row = document.createElement('div');
                row.className = "flex justify-between items-center p-2 bg-gray-50 rounded-lg";
                row.innerHTML = `
                    <div class="flex items-center gap-2">
                        <img src="${uData.icon||'https://placehold.jp/32x32.png'}" class="w-8 h-8 rounded-full object-cover">
                        <div class="text-sm font-bold">${uData.name} <span class="text-xs font-normal text-gray-500">${uData.part}</span></div>
                    </div>
                    ${(b.creatorId === currentUser || currentProfile.isAdmin) && uid !== currentUser ? 
                        `<button onclick="removeMember('${uid}')" class="text-gray-400 hover:text-red-500"><span class="material-icons text-sm">remove_circle</span></button>` : ''}
                `;
                list.appendChild(row);
            });

            openModal('modal-band-detail');
        };
        
        // 画像処理 (大幅修正: uploadBytesを使用するように変更)
        window.handleImageSelect = (input, previewId) => { 
            if (input.files && input.files[0]) { 
                compressImage(input.files[0]).then(blob => { 
                    tempBandIconBlob = blob; 
                    const img = document.getElementById(previewId); 
                    img.src = URL.createObjectURL(blob); // BlobからプレビューURL生成
                    img.classList.remove('hidden'); 
                }).catch(e => alert("画像処理エラー: " + e.message));
            } 
        };

        window.handleImageEdit = async (input) => { 
            if (input.files && input.files[0]) { 
                if(!confirm("バンドアイコンを変更しますか？")) return;
                
                const detailIcon = document.getElementById('detailBandIcon');
                const originalSrc = detailIcon.src;
                detailIcon.style.opacity = "0.5"; // 処理中表示

                try {
                    const blob = await compressImage(input.files[0]); 
                    const bandId = document.getElementById('detailBandId').value; 
                    const storageRef = ref(storage, `band_icons/${bandId}.jpg`); 
                    
                    await uploadBytes(storageRef, blob); // uploadBytesに変更
                    const url = await getDownloadURL(storageRef); 
                    
                    await updateDoc(doc(db, "bands", bandId), { icon: url }); 
                    detailIcon.src = url; 
                    showToast("アイコンを変更しました"); 
                } catch(e) { 
                    console.error(e);
                    detailIcon.src = originalSrc;
                    alert("画像アップロードエラー: " + e.message); 
                } finally {
                    detailIcon.style.opacity = "1";
                }
            } 
        };
        
        // プロフィール画像
        window.handleProfileIconUpload = async (input) => {
            if (input.files && input.files[0]) {
                const imgEl = document.getElementById('profileIconPreview');
                imgEl.style.opacity = "0.5";
                try {
                    const blob = await compressImage(input.files[0]);
                    const storageRef = ref(storage, `user_icons/${currentUser}.jpg`);
                    await uploadBytes(storageRef, blob);
                    const url = await getDownloadURL(storageRef);
                    
                    await updateDoc(doc(db, "users", currentUser), { icon: url });
                    currentProfile.icon = url;
                    imgEl.src = url;
                    document.getElementById('headerUserIcon').src = url;
                    showToast("プロフィール画像を変更しました");
                } catch(e) { alert("Error: " + e.message); }
                finally { imgEl.style.opacity = "1"; }
            }
        };

        // Canvasを使って画像を圧縮し、Blobを返す関数
        const compressImage = (file) => { 
            return new Promise((resolve, reject) => { 
                const img = new Image(); 
                img.src = URL.createObjectURL(file); 
                img.onload = () => { 
                    const canvas = document.createElement('canvas'); 
                    const ctx = canvas.getContext('2d'); 
                    const size = 300; // サイズを少し大きくしました(200->300)
                    canvas.width = size; 
                    canvas.height = size; 
                    
                    let sWidth = img.width; 
                    let sHeight = img.height; 
                    let sx = 0; 
                    let sy = 0; 
                    
                    // 中央トリミング計算
                    if (sWidth > sHeight) { 
                        sWidth = sHeight; 
                        sx = (img.width - sHeight) / 2; 
                    } else { 
                        sHeight = sWidth; 
                        sy = (img.height - sWidth) / 2; 
                    } 
                    
                    ctx.drawImage(img, sx, sy, sWidth, sHeight, 0, 0, size, size); 
                    
                    // Blobとして出力 (Quality 0.8)
                    canvas.toBlob((blob) => {
                        if (blob) resolve(blob);
                        else reject(new Error("画像の変換に失敗しました"));
                    }, 'image/jpeg', 0.8); 
                }; 
                img.onerror = (e) => reject(e);
            }); 
        };

        // --- Util Functions ---
        async function loadUserList(targetId = 'userSelectList', excludeIds = []) { const list = document.getElementById(targetId); const qs = await getDocs(collection(db, "users")); list.innerHTML = ""; let count = 0; qs.forEach(doc => { const u = doc.data(); if(doc.id === currentUser || excludeIds.includes(doc.id)) return; const div = document.createElement('div'); div.className = 'member-option'; div.dataset.uid = doc.id; div.dataset.uname = u.name; div.onclick = () => { div.classList.toggle('selected'); div.querySelector('.material-icons').innerText = div.classList.contains('selected') ? 'check_box' : 'check_box_outline_blank'; }; div.innerHTML = `<span class="material-icons member-check">check_box_outline_blank</span><img src="${u.icon || 'https://placehold.jp/32x32.png'}" style="width:32px; height:32px; border-radius:50%; margin-right:10px; object-fit:cover;"><div>${u.name} <span style="font-size:10px; color:#999;">${u.part ? '('+getPartLabel(u.part)+')' : ''}</span></div>`; list.appendChild(div); count++; }); if(count === 0) list.innerHTML = '<div style="padding:10px; color:#999;">追加できるユーザーがいません</div>'; }
        function getPartLabel(part) { if (part === "vocal") return "Vo"; if (part === "guitar") return "Gt"; if (part === "bass") return "Ba"; if (part === "drums") return "Dr"; if (part === "keyboard") return "Key"; return ""; }
        
        window.updateBandsList = () => {
            const container = document.getElementById('bandsList');
            if(!container) return;
            container.innerHTML = "";
            const filtered = myBandsAll.filter(b => (b.isArchived === (currentBandTab === 'archived')));
            
            if(filtered.length === 0) {
                container.innerHTML = `<div class="text-center py-10 text-gray-400">バンドがありません</div>`;
                return;
            }

            filtered.forEach(b => {
                const div = document.createElement('div');
                div.className = "card flex items-center p-3 cursor-pointer hover:bg-gray-50 transition";
                div.onclick = () => openBandDetail(b.id);
                div.innerHTML = `
                    <img src="${b.icon || 'https://placehold.jp/100x100.png'}" class="band-icon-sm mr-3">
                    <div class="flex-1">
                        <div class="font-bold text-base">${b.name}</div>
                        <div class="text-xs text-gray-500">${b.memberNames ? b.memberNames.length : 0} members</div>
                    </div>
                    <span class="material-icons text-gray-300">chevron_right</span>
                `;
                container.appendChild(div);
            });
        };
        window.setBandTab = (tab) => { currentBandTab = tab; renderBandsPage(); };
        
        window.showToast = (msg) => {
            const con = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = 'toast';
            el.innerText = msg;
            con.appendChild(el);
            setTimeout(() => el.classList.add('show'), 10);
            setTimeout(() => { el.classList.remove('show'); setTimeout(()=>el.remove(), 300); }, 3000);
        };

        // --- Admin Functions ---
        window.adminToggleAdmin = async (uid, newStatus) => {
            if(!confirm(`管理者権限を${newStatus?'付与':'剥奪'}しますか？`)) return;
            await updateDoc(doc(db, "users", uid), { isAdmin: newStatus });
            renderAdminPage();
        };
        window.adminDeleteBand = async (bid) => {
            if(!confirm("本当にこのバンドを削除しますか？")) return;
            await deleteDoc(doc(db, "bands", bid));
            renderAdminPage();
        };

        // --- Other Helpers ---
        window.shareBandInvite = (bandId, bandName) => {
            const url = `${window.location.origin}${window.location.pathname}?invite_band=${bandId}`;
            if(navigator.share) {
                navigator.share({ title: 'バンド招待', text: `「${bandName}」に招待されています！`, url: url });
            } else {
                prompt("以下のURLをコピーして送ってください", url);
            }
        };

        // --- Profile Update ---
        window.updateProfileName = async () => {
            const name = document.getElementById('profileNameInput').value.trim();
            if(!name) return;
            await updateDoc(doc(db, "users", currentUser), { name });
            currentProfile.name = name;
            showToast("名前を更新しました");
        };
        window.updateProfilePart = async (val) => {
            await updateDoc(doc(db, "users", currentUser), { part: val });
            currentProfile.part = val;
            showToast("パートを更新しました");
        };

    </script>
</body>
</html>
